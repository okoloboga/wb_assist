# üìã –î–ï–¢–ê–õ–¨–ù–û–ï –¢–ó: AI-–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ GPT

## üéØ –¶–µ–ª—å

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É **"üß† AI-–∞–Ω–∞–ª–∏–∑"** –≤ –±–æ—Ç–µ ‚Üí —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ OpenAI ‚Üí –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ ‚Üí –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USER      ‚îÇ      ‚îÇ     BOT      ‚îÇ      ‚îÇ  GPT SERVICE ‚îÇ
‚îÇ  Telegram   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   (8001)     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   (9000)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚ñ≤                      ‚ñ≤
                            ‚îÇ                      ‚îÇ
                            ‚ñº                      ‚ñº
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ   SERVER     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   OpenAI     ‚îÇ
                     ‚îÇ   (8000)     ‚îÇ      ‚îÇ     API      ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚ñ≤
                            ‚îÇ
                            ‚ñº
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ PostgreSQL   ‚îÇ
                     ‚îÇ    +Redis    ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (Step-by-Step)

### **–®–ê–ì 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏–∑**

**–§–∞–π–ª**: `bot/handlers/gpt.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `cb_ai_analysis`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "üß† AI-–∞–Ω–∞–ª–∏–∑" (callback_data = `"ai_analysis"`)
2. –ë–æ—Ç –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç: `"‚è≥ –ó–∞–ø—É—Å–∫–∞—é AI‚Äë–∞–Ω–∞–ª–∏–∑‚Ä¶"`
3. –ë–æ—Ç –¥–µ–ª–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å:
   ```python
   POST http://gpt:9000/v1/analysis/start
   Headers: {"X-API-KEY": "{API_SECRET_KEY}"}
   Body: {"telegram_id": 123456789, "period": "7d", "validate_output": true}
   ```
4. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ (HTTP 200): `"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω. –Ø –ø—Ä–∏—à–ª—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏..."`
5. –ü—Ä–∏ –æ—à–∏–±–∫–µ: `"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑. HTTP {status}"`

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**:
```python
# bot/core/config.py
gpt_service_url = os.getenv("GPT_SERVICE_URL", "http://127.0.0.1:9000")  # ‚úÖ –£–ñ–ï –ï–°–¢–¨
```

---

### **–®–ê–ì 2: GPT —Å–µ—Ä–≤–∏—Å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å**

**–§–∞–π–ª**: `gpt_integration/service.py` ‚Üí —ç–Ω–¥–ø–æ–∏–Ω—Ç `/v1/analysis/start`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –í–∞–ª–∏–¥–∞—Ü–∏—è `X-API-KEY` (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `API_SECRET_KEY`)
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: `telegram_id`, `period`, `validate_output`
3. **Fire-and-forget**: –∑–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏ `_orchestrate_analysis()`
4. –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç—É: `{"status": "accepted", "message": "analysis started"}`

**–ö–æ–¥**:
```python
@app.post("/v1/analysis/start")
async def analysis_start(req: AnalysisStartRequest, x_api_key: Optional[str] = Header(None)):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
    if not x_api_key or x_api_key != os.getenv("API_SECRET_KEY"):
        raise HTTPException(status_code=403, detail="Invalid or missing API key")
    
    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫
    asyncio.create_task(_orchestrate_analysis(req.telegram_id, req.period, req.validate_output))
    return {"status": "accepted", "message": "analysis started"}
```

---

### **–®–ê–ì 3: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ Server (Bot API)**

**–§–∞–π–ª**: `gpt_integration/service.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `_orchestrate_analysis`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç** (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã):

#### 3.1 –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂
```http
GET http://server:8000/api/v1/bot/analytics/sales?telegram_id=123&period=7d
Headers: {"X-API-SECRET-KEY": "{API_SECRET_KEY}"}
```

**–û—Ç–≤–µ—Ç** (—Å—Ö–µ–º–∞ `AnalyticsSalesAPIResponse`):
```json
{
  "status": "success",
  "analytics": {
    "date_range": {"start_date": "2025-10-21", "end_date": "2025-10-28"},
    "sales_periods": {
      "today": {"count": 45, "sum_rub": 120000},
      "yesterday": {"count": 41, "sum_rub": 110000}
    },
    "dynamics": {
      "yesterday_growth_percent": 9.8,
      "week_growth_percent": 15.2
    },
    "top_products": [
      {"sku": "SKU-123", "name": "–¢–æ–≤–∞—Ä 1", "revenue_rub": 48000, "count": 16}
    ]
  },
  "telegram_text": "üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π..."
}
```

#### 3.2 –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤
```http
GET http://server:8000/api/v1/bot/stocks/critical?telegram_id=123&limit=20&offset=0
```

**–û—Ç–≤–µ—Ç** (`CriticalStocksAPIResponse`):
```json
{
  "status": "success",
  "stocks": {
    "critical_items": [
      {"sku": "SKU-456", "name": "–¢–æ–≤–∞—Ä 2", "stock": 3, "warehouse": "–ö–æ–ª–µ–¥–∏–Ω–æ"}
    ],
    "total_critical": 12
  }
}
```

#### 3.3 –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –ø–æ –æ—Ç–∑—ã–≤–∞–º
```http
GET http://server:8000/api/v1/bot/reviews/summary?telegram_id=123&limit=10&offset=0
```

**–û—Ç–≤–µ—Ç** (`ReviewsSummaryAPIResponse`):
```json
{
  "status": "success",
  "reviews": {
    "total_reviews": 156,
    "rating_distribution": {"1": 5, "2": 3, "3": 10, "4": 38, "5": 100},
    "negative_reviews": [...],
    "average_rating": 4.6
  }
}
```

#### 3.4 –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–∫–∞–∑–æ–≤
```http
GET http://server:8000/api/v1/bot/orders/recent?telegram_id=123&limit=10&offset=0
```

**–û—Ç–≤–µ—Ç**:
```json
{
  "status": "success",
  "orders": [
    {"id": 123, "date": "2025-10-28T10:30:00+03:00", "amount": 2670, "status": "delivered"}
  ],
  "pagination": {"total": 450, "limit": 10, "offset": 0}
}
```

**–ö–æ–¥** (–≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ):
```python
sales_task = _fetch_analytics_sales(telegram_id, period, server_host, api_secret_key)
stocks_task = _fetch_stocks_critical(telegram_id, server_host, api_secret_key)
reviews_task = _fetch_reviews_summary(telegram_id, server_host, api_secret_key)
orders_task = _fetch_orders_recent(telegram_id, server_host, api_secret_key)

fetched = await asyncio.gather(sales_task, stocks_task, reviews_task, orders_task, 
                                return_exceptions=True)
```

---

### **–®–ê–ì 4: –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**

**–§–∞–π–ª**: `gpt_integration/aggregator.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `aggregate`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö –≤ –µ–¥–∏–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å
2. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫:
   - `day_over_day`: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫ –≤—á–µ—Ä–∞ (%)
   - `week_over_week`: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ (%)
   - `top_products_count`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ø-—Ç–æ–≤–∞—Ä–æ–≤
   - `critical_stocks_count`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**:
```python
sources = {
    "meta": {"telegram_id": 123, "period": "7d"},
    "sales": {...},  # –∏–∑ analytics/sales
    "stocks_critical": {...},  # –∏–∑ stocks/critical
    "reviews_summary": {...},  # –∏–∑ reviews/summary
    "orders_recent": {...}  # –∏–∑ orders/recent
}
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (–¥–ª—è LLM):
```python
{
  "meta": {
    "telegram_id": 123,
    "period": "7d",
    "computed_metrics": {
      "day_over_day": 9.8,
      "week_over_week": 15.2,
      "top_products_count": 5,
      "critical_stocks_count": 12
    }
  },
  "sales": {...},
  "stocks_critical": {...},
  "reviews_summary": {...},
  "orders_recent": {...},
  "top_products": [...]
}
```

---

### **–®–ê–ì 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è LLM**

**–§–∞–π–ª**: `gpt_integration/pipeline.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `compose_messages`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ –∏–∑ `LLM_ANALYSIS_TEMPLATE.md`
2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π:
   - `SYSTEM` ‚Äî —Ä–æ–ª—å –∏ —Å—Ç–∏–ª—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
   - `TASKS` ‚Äî —á—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
   - `OUTPUT_JSON_SCHEMA` ‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤—ã—Ö–æ–¥–Ω–æ–≥–æ JSON
   - `OUTPUT_TG_GUIDE` ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è Telegram-—Ç–µ–∫—Å—Ç–∞

3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è OpenAI:
```python
[
  {
    "role": "system",
    "content": "–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ e-commerce (Wildberries). –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ..."
  },
  {
    "role": "user",
    "content": """
### DATA
{aggregated_data_json}

### TASKS
1) –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (key_metrics)
...

### OUTPUT_JSON_SCHEMA
{...}

### OUTPUT_TG_GUIDE
{...}

–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OUTPUT_JSON...
    """
  }
]
```

---

### **–®–ê–ì 6: –í—ã–∑–æ–≤ OpenAI API**

**–§–∞–π–ª**: `gpt_integration/gpt_client.py` ‚Üí –∫–ª–∞—Å—Å `GPTClient`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**:
```bash
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
OPENAI_API_KEY=sk-...
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o-mini
```

**–ó–∞–ø—Ä–æ—Å**:
```python
client = GPTClient.from_env()
response_text = client.complete_messages(messages)
```

**–û—Ç–≤–µ—Ç –æ—Ç OpenAI** (–ø—Ä–∏–º–µ—Ä):
```json
{
  "key_metrics": {
    "date_range": {"start_date": "2025-10-21", "end_date": "2025-10-28"},
    "orders_count": 450,
    "revenue_rub": 1200000,
    "avg_order_value": 2670,
    "day_over_day": 9.8,
    "week_over_week": 15.2,
    "top_products_count": 5,
    "critical_stocks_count": 12
  },
  "anomalies": [
    {
      "type": "low_stock",
      "description": "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ SKU-456 (3 —à—Ç.)",
      "severity": "high",
      "affected_items": ["SKU-456"]
    }
  ],
  "insights": [
    {
      "title": "–¢–æ–ø-5 —Ç–æ–≤–∞—Ä–æ–≤ –¥–∞—é—Ç 65% –≤—ã—Ä—É—á–∫–∏",
      "detail": "SKU-123, SKU-789... –°—Ç–æ–∏—Ç —Ä–∞—Å—à–∏—Ä–∏—Ç—å –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–∑–∏—Ü–∏–π"
    }
  ],
  "recommendations": [
    {
      "action": "replenish_stock",
      "why": "–û—Å—Ç–∞—Ç–∫–∏ SKU-456 < 5 —à—Ç., —Ä–∏—Å–∫ –¥–µ—Ñ–∏—Ü–∏—Ç–∞",
      "impact": "high",
      "effort": "medium",
      "items": ["SKU-456", "SKU-789"]
    }
  ],
  "telegram": {
    "chunks": [
      "üìä –û—Ç—á—ë—Ç –ø–æ –∫–∞–±–∏–Ω–µ—Ç—É: 2025-10-21 ‚Äî 2025-10-28\n\nüìà –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏...",
      "‚ö†Ô∏è –ê–Ω–æ–º–∞–ª–∏–∏\n‚Ä¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ SKU-456...",
      "‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n‚Ä¢ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ SKU-456..."
    ]
  },
  "sheets": {
    "headers": ["SKU", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–í—ã—Ä—É—á–∫–∞ ‚ÇΩ", "–ó–∞–∫–∞–∑—ã", "–û—Å—Ç–∞—Ç–æ–∫"],
    "rows": [
      ["SKU-123", "–¢–æ–≤–∞—Ä 1", 480000, 160, 45],
      ["SKU-456", "–¢–æ–≤–∞—Ä 2", 120000, 40, 3]
    ]
  }
}
```

---

### **–®–ê–ì 7: –ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞**

**–§–∞–π–ª**: `gpt_integration/pipeline.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `run_analysis`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM (—Ñ—É–Ω–∫—Ü–∏—è `_safe_json_extract`)
2. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–µ—Å–ª–∏ `validate=True`):
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π: `key_metrics`, `anomalies`, `insights`, `recommendations`, `telegram`, `sheets`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `telegram.chunks` –∏–ª–∏ `telegram.mdv2`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `sheets.headers` –∏ `sheets.rows`

3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è `telegram`:
   - –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è MarkdownV2
   - –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ —á–∞–Ω–∫–∏ (–µ—Å–ª–∏ —Ç–µ–∫—Å—Ç >3500 —Å–∏–º–≤–æ–ª–æ–≤)
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤

4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
   - –ï—Å–ª–∏ JSON –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π ‚Üí –ø–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ `OUTPUT_TG`
   - –ï—Å–ª–∏ LLM –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É ‚Üí —Ñ–æ–ª–±—ç–∫ —Ç–µ–∫—Å—Ç `"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM..."`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
```python
{
  "messages": [...],  # –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  "raw_response": "...",  # —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç LLM
  "json": {...},  # —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π JSON
  "telegram": {
    "chunks": ["—á–∞–Ω–∫ 1", "—á–∞–Ω–∫ 2", ...],
    "character_count": 2345
  },
  "sheets": {
    "headers": [...],
    "rows": [...]
  },
  "validation_errors": []  # –µ—Å–ª–∏ validate=True
}
```

---

### **–®–ê–ì 8: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –±–æ—Ç (webhook)**

**–§–∞–π–ª**: `gpt_integration/service.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `_post_bot_webhook`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
   ```python
   chunks = result["telegram"]["chunks"]
   if not chunks and result["telegram"].get("mdv2"):
       chunks = [result["telegram"]["mdv2"]]
   if not chunks:
       chunks = ["‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞"]
   ```

2. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è** –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞:
   ```python
   for chunk in chunks:
       POST http://bot:8001/webhook/notifications/{telegram_id}
       Headers: {"Content-Type": "application/json"}
       Body: {
         "telegram_id": 123456789,
         "user_id": 123456789,
         "type": "analysis_completed",
         "telegram_text": chunk
       }
   ```

3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
   - –ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –Ω–∞ —ç—Ç–∞–ø–∞—Ö 3-7 ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ–ª–±—ç–∫ —Å–æ–æ–±—â–µ–Ω–∏—è:
     ```python
     fallback_text = f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}"
     await _post_bot_webhook(telegram_id, fallback_text, webhook_base)
     ```

---

### **–®–ê–ì 9: –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç –∏ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**

**–§–∞–π–ª**: `bot/handlers/webhook.py` ‚Üí —ç–Ω–¥–ø–æ–∏–Ω—Ç `/webhook/notifications/{telegram_id}`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ü–æ–ª—É—á–µ–Ω–∏–µ POST –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç GPT —Å–µ—Ä–≤–∏—Å–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ `telegram_id` (URL vs payload)
3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `telegram_text` –∏ `notification_type`
4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞:
   ```python
   if notification_type == "analysis_completed":
       # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ë–ï–ó parse_mode (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ MarkdownV2)
       await bot.send_message(
           chat_id=telegram_id,
           text=telegram_text,
           parse_mode=None  # ‚Üê –í–ê–ñ–ù–û!
       )
   ```

5. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 1-3 —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤ Telegram

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

### –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

| –≠—Ç–∞–ø | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
|------|-----------|----------------|-----------------|
| 1 | –ë–æ—Ç ‚Üí GPT | `{"telegram_id": 123, "period": "7d"}` | HTTP 202 Accepted |
| 2 | GPT ‚Üí Server | `telegram_id`, `period` | 4 JSON –æ—Ç–≤–µ—Ç–∞ (sales, stocks, reviews, orders) |
| 3 | Aggregator | 4 JSON –æ–±—ä–µ–∫—Ç–∞ | –ï–¥–∏–Ω—ã–π `data` —Å–ª–æ–≤–∞—Ä—å —Å `computed_metrics` |
| 4 | Pipeline | `data` + —à–∞–±–ª–æ–Ω | –ü—Ä–æ–º–ø—Ç –¥–ª—è OpenAI (system + user messages) |
| 5 | OpenAI | –ü—Ä–æ–º–ø—Ç | JSON —Å –∞–Ω–∞–ª–∏–∑–æ–º (key_metrics, anomalies, insights, recommendations, telegram, sheets) |
| 6 | Pipeline | JSON –æ—Ç OpenAI | –í–∞–ª–∏–¥–∞—Ü–∏—è + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (`telegram.chunks`, —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ) |
| 7 | GPT ‚Üí –ë–æ—Ç | `telegram.chunks` | Webhook –∑–∞–ø—Ä–æ—Å—ã (–ø–æ 1 –Ω–∞ —á–∞–Ω–∫) |
| 8 | –ë–æ—Ç ‚Üí User | `telegram_text` | Telegram —Å–æ–æ–±—â–µ–Ω–∏—è |

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)

### BOT (.env –¥–ª—è –±–æ—Ç–∞)
```bash
BOT_TOKEN=123456:ABC...                  # Telegram Bot Token
SERVER_HOST=http://server:8000           # –ê–¥—Ä–µ—Å Backend —Å–µ—Ä–≤–µ—Ä–∞
API_SECRET_KEY=your_secret_key_here      # –û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
GPT_SERVICE_URL=http://gpt:9000          # –ê–¥—Ä–µ—Å GPT —Å–µ—Ä–≤–∏—Å–∞
REQUEST_TIMEOUT=600                      # –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (10 –º–∏–Ω)
WEBHOOK_SECRET=default_webhook_secret    # –°–µ–∫—Ä–µ—Ç –¥–ª—è –≤–µ–±—Ö—É–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### GPT SERVICE (.env –¥–ª—è gpt_integration)
```bash
SERVER_HOST=http://server:8000                      # –û—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
API_SECRET_KEY=your_secret_key_here                 # –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Server API
BOT_WEBHOOK_BASE=http://bot:8001                    # –ö—É–¥–∞ —Å–ª–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
OPENAI_API_KEY=sk-...                               # OpenAI API –∫–ª—é—á
OPENAI_BASE_URL=https://api.openai.com/v1           # OpenAI endpoint
OPENAI_MODEL=gpt-4o-mini                            # –ú–æ–¥–µ–ª—å (gpt-4o-mini, gpt-4, gpt-3.5-turbo)
GPT_PORT=9000                                       # –ü–æ—Ä—Ç GPT —Å–µ—Ä–≤–∏—Å–∞
```

### SERVER (.env –¥–ª—è backend)
```bash
DATABASE_URL=postgresql://user:pass@db:5432/wb_assist
API_SECRET_KEY=your_secret_key_here                 # –¢–æ—Ç –∂–µ —Å–µ–∫—Ä–µ—Ç!
REDIS_URL=redis://redis:6379/0
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç: –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

| # | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
|---|-----------|------|--------|
| 1 | –ö–Ω–æ–ø–∫–∞ "üß† AI-–∞–Ω–∞–ª–∏–∑" | `bot/keyboards/keyboards.py:104` | ‚úÖ |
| 2 | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ | `bot/handlers/gpt.py:20-69` | ‚úÖ |
| 3 | –ö–æ–Ω—Ñ–∏–≥ `gpt_service_url` | `bot/core/config.py:43` | ‚úÖ |
| 4 | –≠–Ω–¥–ø–æ–∏–Ω—Ç `/v1/analysis/start` | `gpt_integration/service.py:190-199` | ‚úÖ |
| 5 | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è `_orchestrate_analysis` | `gpt_integration/service.py:124-188` | ‚úÖ |
| 6 | –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ Server | `gpt_integration/service.py:59-110` | ‚úÖ |
| 7 | –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | `gpt_integration/aggregator.py` | ‚úÖ |
| 8 | –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ | `gpt_integration/pipeline.py:14-43` | ‚úÖ |
| 9 | GPT –∫–ª–∏–µ–Ω—Ç | `gpt_integration/gpt_client.py` | ‚úÖ |
| 10 | –ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è | `gpt_integration/pipeline.py:111-170` | ‚úÖ |
| 11 | –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ webhook –±–æ—Ç–∞ | `gpt_integration/service.py:112-122, 177-178` | ‚úÖ |
| 12 | Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ | `bot/handlers/webhook.py:62-262` | ‚úÖ |
| 13 | Server Bot API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã | `server/app/features/bot_api/routes.py` | ‚úÖ |
| 14 | Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | `docker-compose.yml:124-142` | ‚úÖ |

**–í—ã–≤–æ–¥**: –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã! üéâ

---

## SYSTEM

–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ e-commerce –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Wildberries. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö, –æ—Å—Ç–∞—Ç–∫–∞—Ö, –æ—Ç–∑—ã–≤–∞—Ö –∏ –∑–∞–∫–∞–∑–∞—Ö, –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∫—Ä–∞—Ç–∫–∏–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã.

**–°—Ç–∏–ª—å:**
- –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π
- –ì—Ä—É–ø–ø–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏
- –í—ã–¥–µ–ª—è–π –≤–∞–∂–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ —Ç—Ä–µ–Ω–¥—ã
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö

---

## TASKS

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç:

**–û–°–ù–û–í–ù–´–ï –î–ê–ù–ù–´–ï –î–õ–Ø –û–¢–ß–Å–¢–ê:**
- –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ `yesterday` ‚Äî —ç—Ç–æ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ó–ê –í–ß–ï–†–ê (–æ–¥–∏–Ω –ø–æ–ª–Ω—ã–π –¥–µ–Ω—å)
- –î–∞–Ω–Ω—ã–µ `daily_trends` ‚Äî —ç—Ç–æ –¥–∏–Ω–∞–º–∏–∫–∞ –∑–∞ N –¥–Ω–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤

1. **–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏** (`key_metrics`):
   - **–ó–ê –í–ß–ï–†–ê (–∏–∑ `yesterday`):**
     - –ó–∞–∫–∞–∑—ã: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö
     - –û—Ç–º–µ–Ω—ã: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö
     - –í—ã–∫—É–ø—ã: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö
     - –í–æ–∑–≤—Ä–∞—Ç—ã: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö
   - –°—Ä–µ–¥–Ω–∏–π —á–µ–∫
     - –¢–æ–ø-5 —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ –≤—á–µ—Ä–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º (–∏—Å–ø–æ–ª—å–∑—É–π `yesterday.top_products` —Å –ø–æ–ª–µ–º `name`)
   
   - **–ü–û–ö–ê–ó–ê–¢–ï–õ–ò –ó–ê N –î–ù–ï–ô (–∏–∑ `daily_trends.aggregates`):**
     - –î–æ–ª–∏: buyout_rate (% –≤—ã–∫—É–ø–∞ –æ—Ç –∑–∞–∫–∞–∑–æ–≤), return_rate (% –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –æ—Ç –≤—ã–∫—É–ø–æ–≤)
     - –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥

2. **–ê–Ω–æ–º–∞–ª–∏–∏** (`anomalies`):
   - –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
   - –†–µ–∑–∫–∏–µ –ø–∞–¥–µ–Ω–∏—è/—Ä–æ—Å—Ç –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º (—Å—Ä–∞–≤–Ω–∏ –≤—á–µ—Ä–∞ —Å –ø–æ–∑–∞–≤—á–µ—Ä–∞ –∏ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –¥–Ω—è–º–∏)
   - –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–º–µ–Ω –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –≤—á–µ—Ä–∞
   - –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –¥–Ω–∏ —Å –∞–Ω–æ–º–∞–ª–∏—è–º–∏ –≤ `time_series`

3. **–ò–Ω—Å–∞–π—Ç—ã** (`insights`):
   - **–ê–Ω–∞–ª–∏–∑ –∑–∞ 7 –¥–Ω–µ–π** (–∏—Å–ø–æ–ª—å–∑—É–π `daily_trends.time_series` ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π):
     - –¢—Ä–µ–Ω–¥—ã: —Ä–∞—Å—Ç—É—Ç/–ø–∞–¥–∞—é—Ç –∑–∞–∫–∞–∑—ã, –≤—ã–∫—É–ø—ã –ø–æ –¥–Ω—è–º
     - –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ —Å –ø—Ä–æ–≤–∞–ª–∞–º–∏/–ø–∏–∫–∞–º–∏
     - –î–∏–Ω–∞–º–∏–∫–∞ –æ—Ç–º–µ–Ω –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –ø–æ –¥–Ω—è–º
   - **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—á–µ—Ä–∞ —Å –æ–±—â–∏–º —Ç—Ä–µ–Ω–¥–æ–º:**
     - –í—á–µ—Ä–∞ –ª—É—á—à–µ/—Ö—É–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥?
     - –ï—Å—Ç—å –ª–∏ –∞–Ω–æ–º–∞–ª–∏–∏ –∏–º–µ–Ω–Ω–æ –≤–æ –≤—á–µ—Ä–∞—à–Ω–µ–º –¥–Ω–µ?
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—ã–∫—É–ø–∞ (buyout_rate –∑–∞ –ø–µ—Ä–∏–æ–¥)
   - –í–ª–∏—è–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –Ω–∞ –±–∏–∑–Ω–µ—Å (return_rate –∑–∞ –ø–µ—Ä–∏–æ–¥)

4. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** (`recommendations`):
   - –î–∞–π —Ä–æ–≤–Ω–æ 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞:
     - –î–∏–Ω–∞–º–∏–∫—É –∑–∞ N –¥–Ω–µ–π (–∏–∑ `time_series`)
     - –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è
     - –¢—Ä–µ–Ω–¥—ã –ø–æ —Ç–æ–ø-—Ç–æ–≤–∞—Ä–∞–º
     - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤—ã–∫—É–ø–∞/–≤–æ–∑–≤—Ä–∞—Ç–∞
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ–Ω–¥–æ–≤, —Ä–∞–±–æ—Ç–∞ —Å –æ—Ç–º–µ–Ω–∞–º–∏/–≤–æ–∑–≤—Ä–∞—Ç–∞–º–∏, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–Ω–µ–π —Å –ø—Ä–æ–≤–∞–ª–∞–º–∏, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ç–æ–≤–∞—Ä–∞–º

---

## OUTPUT_JSON_SCHEMA

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ –≤–∏–¥–µ —á–∏—Å—Ç–æ–≥–æ JSON, –ë–ï–ó markdown –±–ª–æ–∫–æ–≤, –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**
- –ù–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç –°–†–ê–ó–£ —Å –æ—Ç–∫—Ä—ã–≤–∞—é—â–µ–π —Ñ–∏–≥—É—Ä–Ω–æ–π —Å–∫–æ–±–∫–∏ `{`
- –í–µ—Ä–Ω–∏ –í–ï–°–¨ JSON –æ–±—ä–µ–∫—Ç
- –ó–∞–∫–æ–Ω—á–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π —Ñ–∏–≥—É—Ä–Ω–æ–π —Å–∫–æ–±–∫–æ–π `}`
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown code blocks (```json –∏–ª–∏ ```)
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

**–°—Ö–µ–º–∞ JSON:**

{
  "key_metrics": {
    "yesterday_date": "YYYY-MM-DD",
    "yesterday": {
      "orders": 0,
      "orders_amount": 0.0,
      "buyouts": 0,
      "buyouts_amount": 0.0,
      "returns": 0,
      "returns_amount": 0.0,
      "avg_check": 0.0,
    "top_products": [
        {"name": "string", "orders": 0}
      ]
    },
    "period_rates": {
      "buyout_rate_percent": 0.0,
      "return_rate_percent": 0.0,
      "avg_rating": 0.0
    }
  },
  "anomalies": [
    {
      "type": "high_returns|sales_drop|low_stock",
      "description": "string",
      "severity": "low|medium|high",
      "affected_items": ["string"]
    }
  ],
  "insights": [
    {
      "title": "string",
      "detail": "string"
    }
  ],
  "recommendations": [
    {
      "action": "string",
      "why": "string",
      "impact": "low|medium|high",
      "effort": "low|medium|high",
      "items": ["string"]
    }
  ],
  "telegram": {
    "chunks": ["string"]
  },
  "sheets": {
    "headers": ["string"],
    "rows": [["string"]]
  }
}

**–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ JSON, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ):**

{
  "key_metrics": { ... },
  "anomalies": [ ... ],
  "insights": [ ... ],
  "recommendations": [ ... ],
  "telegram": { "chunks": ["..."] },
  "sheets": { "headers": [...], "rows": [...] }
}

**–ß–¢–û –ù–ï –î–ï–õ–ê–¢–¨:**
‚ùå –ù–ï –Ω–∞—á–∏–Ω–∞–π —Å ```json
‚ùå –ù–ï –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –Ω–∞ ```
‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç —Ç–∏–ø–∞ "–í–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:"
‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Ä–∞–∑—Ä—è–¥–æ–≤ –≤ —á–∏—Å–ª–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 40_000.0). –ü–∏—à–∏ 40000.0
‚ùå –ù–ï –¥–æ–±–∞–≤–ª—è–π —Å–∏–º–≤–æ–ª—ã –≤–∞–ª—é—Ç—ã (‚ÇΩ, $, ‚Ç¨ –∏ —Ç.–¥.) –≤ —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è JSON. –ß–∏—Å–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å—Ç—ã–º–∏: 112500.0, –∞ –ù–ï 112500‚ÇΩ
‚úÖ –¢–û–õ–¨–ö–û —á–∏—Å—Ç—ã–π –≤–∞–ª–∏–¥–Ω—ã–π JSON, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å { –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–π—Å—è –Ω–∞ }

---

## OUTPUT_TG_GUIDE

**–í–ê–ñ–ù–û:** –¢–µ–∫—Å—Ç –¥–ª—è Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ë–ï–ó MarkdownV2 —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (parse_mode=None), –ø–æ—ç—Ç–æ–º—É:

1. **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã** (`\*`, `\_`, `\(` –∏ —Ç.–¥.)
2. **–ò—Å–ø–æ–ª—å–∑—É–π –æ–±—ã—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã** –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
   - `*` –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è (–±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Å–∏–º–≤–æ–ª)
   - `_` –¥–ª—è –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è (–±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Å–∏–º–≤–æ–ª)
   - –ò—Å–ø–æ–ª—å–∑—É–π **—ç–º–æ–¥–∑–∏** –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∏ –∞–∫—Ü–µ–Ω—Ç–æ–≤

3. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ `yesterday`):**

```
üìä –î–ò–ù–ê–ú–ò–ö–ê

–í—á–µ—Ä–∞ ({yesterday_date}):

–ó–∞–∫–∞–∑—ã: {yesterday.orders} —à—Ç. ‚Äî {yesterday.orders_amount}‚ÇΩ
–í—ã–∫—É–ø—ã: {yesterday.buyouts} —à—Ç. ‚Äî {yesterday.buyouts_amount}‚ÇΩ
–í–æ–∑–≤—Ä–∞—Ç—ã: {yesterday.returns} —à—Ç. ‚Äî {yesterday.returns_amount}‚ÇΩ

–°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {yesterday.avg_check}‚ÇΩ

üìà –ü–û–ö–ê–ó–ê–¢–ï–õ–ò –ó–ê {N} –î–ù–ï–ô

‚Ä¢ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤—ã–∫—É–ø–∞: {buyout_rate}%
‚Ä¢ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞: {return_rate}%
‚Ä¢ –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: {avg_rating}

üõçÔ∏è –¢–û–ü –¢–û–í–ê–†–û–í –í–ß–ï–†–ê

1. {name} ‚Äî {orders} –∑–∞–∫–∞–∑–æ–≤
2. {name} ‚Äî {orders} –∑–∞–∫–∞–∑–æ–≤
3. {name} ‚Äî {orders} –∑–∞–∫–∞–∑–æ–≤
4. {name} ‚Äî {orders} –∑–∞–∫–∞–∑–æ–≤
5. {name} ‚Äî {orders} –∑–∞–∫–∞–∑–æ–≤

üí° –ò–ù–°–ê–ô–¢–´ (–∞–Ω–∞–ª–∏–∑ –∑–∞ {N} –¥–Ω–µ–π)

‚Ä¢ {insight_1} ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–Ω—Å–∞–π—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ time_series
‚Ä¢ {insight_2} ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—á–µ—Ä–∞ —Å —Ç—Ä–µ–Ω–¥–æ–º
‚Ä¢ {insight_3} ‚Äî –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
‚Ä¢ {insight_4} ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
‚Ä¢ {insight_5} ‚Äî –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –∏ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏

üîç –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

‚Ä¢ {recommendation_1}
‚Ä¢ {recommendation_2}
‚Ä¢ {recommendation_3}
```

**–í–ê–ñ–ù–û:** 
- **–û–°–ù–û–í–ù–û–ô –ë–õ–û–ö:** –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ `yesterday` ‚Äî —ç—Ç–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å
- **–ü–û–ö–ê–ó–ê–¢–ï–õ–ò –ó–ê N –î–ù–ï–ô:** –∏—Å–ø–æ–ª—å–∑—É–π `daily_trends.aggregates.conversion` –∏ —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥
- **–¢–û–ü –¢–û–í–ê–†–û–í:** –∏—Å–ø–æ–ª—å–∑—É–π `yesterday.top_products` (—Ç–æ–ø –∑–∞ –≤—á–µ—Ä–∞, –º–∞–∫—Å–∏–º—É–º 5)
- –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–æ–ª—è `name` –≤ top_products (—É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –∏–∑ –ë–î)
- –í—Å–µ —á–∏—Å–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –¥–ª—è —Ç—ã—Å—è—á
- **–ò–ù–°–ê–ô–¢–´:** –¥–æ–ª–∂–Ω—ã –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ `daily_trends.time_series` ‚Äî –∞–Ω–∞–ª–∏–∑ –¥–∏–Ω–∞–º–∏–∫–∏ –∑–∞ 7 –¥–Ω–µ–π, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—á–µ—Ä–∞ —Å –æ–±—â–∏–º —Ç—Ä–µ–Ω–¥–æ–º (3‚Äì5 –∏–Ω—Å–∞–π—Ç–æ–≤)
- **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:** —Ä–æ–≤–Ω–æ 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

4. **–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
   - –ò—Å–ø–æ–ª—å–∑—É–π –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏
   - –§–æ—Ä–º–∞—Ç–∏—Ä—É–π —á–∏—Å–ª–∞ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –¥–ª—è —Ç—ã—Å—è—á: `604 372‚ÇΩ` –≤–º–µ—Å—Ç–æ `604372.0‚ÇΩ`
   - –û–∫—Ä—É–≥–ª—è–π –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–æ 2 –∑–Ω–∞–∫–æ–≤: `67.53%`
   - –ò—Å–ø–æ–ª—å–∑—É–π –¥–µ—Ñ–∏—Å—ã `‚Äî` –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏ –æ–ø–∏—Å–∞–Ω–∏–π
   - –ì—Ä—É–ø–ø–∏—Ä—É–π —Å–≤—è–∑–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤–º–µ—Å—Ç–µ

5. **–≠–º–æ–¥–∑–∏ –¥–ª—è —Å–µ–∫—Ü–∏–π:**
   - üìä –î–∏–Ω–∞–º–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π
   - üìà –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏
   - üõçÔ∏è –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤
   - üí° –ò–Ω—Å–∞–π—Ç—ã
   - üîç –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   - ‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã
   - ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã
   - üìâ –ü–∞–¥–µ–Ω–∏–µ

6. **–†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ —á–∞—Å—Ç–∏:**
   - –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—Ä–µ–≤—ã—à–∞–µ—Ç 3500 —Å–∏–º–≤–æ–ª–æ–≤, —Ä–∞–∑–±–µ–π –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π –≤ –º–∞—Å—Å–∏–≤–µ `chunks`
   - –ö–∞–∂–¥–∞—è —á–∞—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π
   - –ù–∞—á–∏–Ω–∞–π —Å–ª–µ–¥—É—é—â—É—é —á–∞—Å—Ç—å —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞

**–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
```
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π: "–ü—Ä–æ–¥–∞–∂–∏ —É–ø–∞–ª–∏ –Ω–∞ 67.53%"
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π: "–ü—Ä–æ–¥–∞–∂–∏ —É–ø–∞–ª–∏ –Ω–∞ \\*67\\.53%\\*"
```
