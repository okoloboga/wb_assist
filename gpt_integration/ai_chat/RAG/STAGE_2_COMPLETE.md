# –≠—Ç–∞–ø 2: –ú–æ–¥—É–ª—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö - –ó–∞–≤–µ—Ä—à–µ–Ω ‚úÖ

## üìã –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### ‚úÖ –ó–∞–¥–∞—á–∞ 2.1: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `gpt_integration/ai_chat/rag/indexer.py`
- –°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å `RAGIndexer` —Å –ø–æ–ª–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –º–µ—Ç–æ–¥–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ –ó–∞–¥–∞—á–∞ 2.2: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `extract_data_from_main_db()`
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤—Å–µ—Ö 5 —Ç–∞–±–ª–∏—Ü:
  - `wb_orders` (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π)
  - `wb_products` (–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã)
  - `wb_stocks` (–æ—Å—Ç–∞—Ç–∫–∏ > 0)
  - `wb_reviews` (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π)
  - `wb_sales` (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è asyncpg —á–µ—Ä–µ–∑ –ø—É–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

### ‚úÖ –ó–∞–¥–∞—á–∞ 2.3: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞–Ω–∫–æ–≤:
  - `_create_order_chunk()` - –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
  - `_create_product_chunk()` - –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
  - `_create_stock_chunk()` - –¥–ª—è –æ—Å—Ç–∞—Ç–∫–æ–≤
  - `_create_review_chunk()` - –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
  - `_create_sale_chunk()` - –¥–ª—è –ø—Ä–æ–¥–∞–∂
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `create_chunks()` —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–ª–æ–≤–∞—Ä—è –Ω–∞–∑–≤–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ NULL –∑–Ω–∞—á–µ–Ω–∏–π –∏ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∑—ã–≤–æ–≤ (200 —Å–∏–º–≤–æ–ª–æ–≤)

### ‚úÖ –ó–∞–¥–∞—á–∞ 2.4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `generate_embeddings()`
- Batch processing –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `text-embedding-3-small`)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø—Ä–æ–±—Ä–æ—Å–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### ‚úÖ –ó–∞–¥–∞—á–∞ 2.5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –ë–î
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `save_to_vector_db()`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å rollback

### ‚úÖ –ó–∞–¥–∞—á–∞ 2.6: –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `index_cabinet()`
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ (pending, in_progress, completed, failed)
- –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:
  1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
  2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ 'in_progress'
  3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  4. –°–æ–∑–¥–∞–Ω–∏–µ —á–∞–Ω–∫–æ–≤
  5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
  6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
  7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ 'completed'
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞ 'failed'
- –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–∞—Ö

### ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_asyncpg_pool()` –≤ `tools/db_pool.py`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã —ç–∫—Å–ø–æ—Ä—Ç—ã –≤ `rag/__init__.py`

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ/–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. `gpt_integration/ai_chat/rag/indexer.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
2. `gpt_integration/ai_chat/rag/__init__.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã —ç–∫—Å–ø–æ—Ä—Ç—ã
3. `gpt_integration/ai_chat/tools/db_pool.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_asyncpg_pool()`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```python
import asyncio
from gpt_integration.ai_chat.rag.indexer import RAGIndexer

async def test_indexing():
    indexer = RAGIndexer()
    result = await indexer.index_cabinet(cabinet_id=1)
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")

# –ó–∞–ø—É—Å–∫
asyncio.run(test_indexing())
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î:** –ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `DATABASE_URL` –∏–ª–∏ `AI_CHAT_DATABASE_URL` –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é –ë–î —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ `wb_orders`, `wb_products` –∏ —Ç.–¥.

2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—É–ª–∞:** –ü—É–ª asyncpg –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ `get_asyncpg_pool()`.

3. **OpenAI API –∫–ª—é—á:** –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è `OPENAI_API_KEY` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.

4. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:** –ú–µ—Ç–æ–¥ `index_cabinet()` –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, –ø–æ—ç—Ç–æ–º—É –µ–≥–æ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Å `await` –∏–ª–∏ —á–µ—Ä–µ–∑ `asyncio.run()`.

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≠—Ç–∞–ø–∞ 2 –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫:
- **–≠—Ç–∞–ø 3:** –ú–æ–¥—É–ª—å –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (—Å–º. `STAGE_3_VECTOR_SEARCH.md`)

---

**–°—Ç–∞—Ç—É—Å:** –≠—Ç–∞–ø 2 - –ú–æ–¥—É–ª—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö ‚úÖ  
**–î–∞—Ç–∞:** 2025-01-XX  
**–ö–æ–º–º–∏—Ç:** a90f41b







