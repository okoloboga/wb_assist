# –≠—Ç–∞–ø 4: –ú–æ–¥—É–ª—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ - –ó–∞–≤–µ—Ä—à–µ–Ω ‚úÖ

## üìã –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### ‚úÖ –ó–∞–¥–∞—á–∞ 4.1: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è
- –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `gpt_integration/ai_chat/rag/context_builder.py`
- –°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å `ContextBuilder` —Å –ø–æ–ª–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –º–µ—Ç–æ–¥–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### ‚úÖ –ó–∞–¥–∞—á–∞ 4.2: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —á–∞–Ω–∫–æ–≤ –ø–æ —Ç–∏–ø—É
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `group_by_type()`
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —á–∞–Ω–∫–æ–≤ –ø–æ —Ç–∏–ø–∞–º (order, product, stock, review, sale)
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –ø–æ similarity (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏

### ‚úÖ –ó–∞–¥–∞—á–∞ 4.3: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `deduplicate()`
- –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ `source_table` –∏ `source_id`
- –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π (—Å –±–æ–ª—å—à–∏–º similarity)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –∫–ª—é—á–∏ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

### ‚úÖ –ó–∞–¥–∞—á–∞ 4.4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `format_context()`
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –ø–æ —Ç–∏–ø–∞–º
- –†—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–æ–≤ (–ó–ê–ö–ê–ó–´, –¢–û–í–ê–†–´, –û–°–¢–ê–¢–ö–ò, –û–¢–ó–´–í–´, –ü–†–û–î–ê–ñ–ò)
- –ü–æ—Ä—è–¥–æ–∫ –≤—ã–≤–æ–¥–∞ —Ç–∏–ø–æ–≤: product ‚Üí order ‚Üí sale ‚Üí stock ‚Üí review
- –ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
- –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

### ‚úÖ –ó–∞–¥–∞—á–∞ 4.5: –û–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `truncate_context()`
- –û–±—Ä–µ–∑–∫–∞ –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –£–¥–∞–ª–µ–Ω–∏–µ –º–µ–Ω–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ (–≤ –∫–æ–Ω—Ü–µ)
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±—Ä–µ–∑–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—Ä–µ–∑–∫–∏

### ‚úÖ –ó–∞–¥–∞—á–∞ 4.6: –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `build_context()`
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —ç—Ç–∞–ø—ã:
  1. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
  2. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  3. –û–±—Ä–µ–∑–∫–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ —á–∞–Ω–∫–æ–≤
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤

### ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
- –û–±–Ω–æ–≤–ª–µ–Ω—ã —ç–∫—Å–ø–æ—Ä—Ç—ã –≤ `rag/__init__.py`
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ/–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. `gpt_integration/ai_chat/rag/context_builder.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å (297 —Å—Ç—Ä–æ–∫)
2. `gpt_integration/ai_chat/rag/__init__.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã —ç–∫—Å–ø–æ—Ä—Ç—ã

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```python
from gpt_integration.ai_chat.rag import VectorSearch, ContextBuilder

# 1. –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
search = VectorSearch()
chunks = search.search_relevant_chunks(
    query_text="–ö–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–æ–¥–∞—é—Ç—Å—è –ª—É—á—à–µ –≤—Å–µ–≥–æ?",
    cabinet_id=1,
    max_chunks=10
)

# 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
builder = ContextBuilder()
context = builder.build_context(chunks)

# –í—ã–≤–µ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
print(context)
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
=== –†–ï–õ–ï–í–ê–ù–¢–ù–´–ï –î–ê–ù–ù–´–ï –ò–ó –ë–ê–ó–´ –î–ê–ù–ù–´–• ===

## –¢–û–í–ê–†–´
- –¢–æ–≤–∞—Ä '–ö—Ä–æ—Å—Å–æ–≤–∫–∏ Nike' (nm_id: 12345), –±—Ä–µ–Ω–¥: Nike, –∫–∞—Ç–µ–≥–æ—Ä–∏—è: –û–±—É–≤—å, —Ä–µ–π—Ç–∏–Ω–≥: 4.5, –æ—Ç–∑—ã–≤–æ–≤: 120, —Ü–µ–Ω–∞: 5999.00‚ÇΩ
- –¢–æ–≤–∞—Ä '–§—É—Ç–±–æ–ª–∫–∞ Adidas' (nm_id: 67890), –±—Ä–µ–Ω–¥: Adidas, –∫–∞—Ç–µ–≥–æ—Ä–∏—è: –û–¥–µ–∂–¥–∞, —Ä–µ–π—Ç–∏–Ω–≥: 4.2, –æ—Ç–∑—ã–≤–æ–≤: 85, —Ü–µ–Ω–∞: 1999.00‚ÇΩ

## –ó–ê–ö–ê–ó–´
- –ó–∞–∫–∞–∑ #12345 –æ—Ç 2025-01-15: —Ç–æ–≤–∞—Ä '–ö—Ä–æ—Å—Å–æ–≤–∫–∏ Nike' (nm_id: 12345), —Ä–∞–∑–º–µ—Ä 42, —Ü–µ–Ω–∞ 5999.00‚ÇΩ, —Å—Ç–∞—Ç—É—Å: –¥–æ—Å—Ç–∞–≤–ª–µ–Ω

## –ü–†–û–î–ê–ñ–ò
- –ü—Ä–æ–¥–∞–∂–∞ —Ç–æ–≤–∞—Ä–∞ '–ö—Ä–æ—Å—Å–æ–≤–∫–∏ Nike' (nm_id: 12345) –æ—Ç 2025-01-14: —Ç–∏–ø - –ø—Ä–æ–¥–∞–∂–∞, —Å—É–º–º–∞: 5999.00‚ÇΩ
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3000)
RAG_CONTEXT_MAX_LENGTH=3000
```

## üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ü–æ—Ä—è–¥–æ–∫ —Ç–∏–ø–æ–≤:** –¢–∏–ø—ã –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (product ‚Üí order ‚Üí sale ‚Üí stock ‚Üí review), —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç LLM –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç.

2. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:** –£–º–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π —á–∞–Ω–∫ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:** –ü—Ä–∏ –æ–±—Ä–µ–∑–∫–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–∑–∞–≥–æ–ª–æ–≤–∫–∏, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞).

4. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å:** –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–ª–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º—ã–º –¥–ª—è LLM –∏ —á–µ–ª–æ–≤–µ–∫–∞.

5. **–ì–∏–±–∫–æ—Å—Ç—å:** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –º–µ—Ç–æ–¥–∞.

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞:** 
   - –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (500-1000 —Å–∏–º–≤–æ–ª–æ–≤) –º–æ–∂–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
   - –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (5000+ —Å–∏–º–≤–æ–ª–æ–≤) –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∏–Ω–∞—Ç—å —Å 3000 —Å–∏–º–≤–æ–ª–æ–≤ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º

2. **–ü–æ—Ä—è–¥–æ–∫ —Ç–∏–ø–æ–≤:** 
   - –ü–æ—Ä—è–¥–æ–∫ –≤—ã–≤–æ–¥–∞ —Ç–∏–ø–æ–≤ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è LLM
   - –¢–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫: product ‚Üí order ‚Üí sale ‚Üí stock ‚Üí review
   - –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `self.type_order` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

3. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:**
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ `(source_table, source_id)`
   - –ï—Å–ª–∏ —ç—Ç–∏ –ø–æ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, —á–∞–Ω–∫ –Ω–µ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ—Ç—Å—è
   - –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—É–±–ª–∏–∫–∞—Ç–∞–º, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–ø–æ–ª–Ω—ã–µ

4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
   - –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö (1000+ —á–∞–Ω–∫–æ–≤) –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≠—Ç–∞–ø–∞ 4 –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫:
- **–≠—Ç–∞–ø 5:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AI Chat Service (—Å–º. `STAGE_5_INTEGRATION.md`)

---

**–°—Ç–∞—Ç—É—Å:** –≠—Ç–∞–ø 4 - –ú–æ–¥—É–ª—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚úÖ  
**–î–∞—Ç–∞:** 2025-01-XX  
**–ö–æ–º–º–∏—Ç:** 8e766f4

