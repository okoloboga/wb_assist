# üìã –î–ï–¢–ê–õ–¨–ù–û–ï –¢–ó: AI-–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ GPT

## üéØ –¶–µ–ª—å

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É **"üß† AI-–∞–Ω–∞–ª–∏–∑"** –≤ –±–æ—Ç–µ ‚Üí —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ OpenAI ‚Üí –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ ‚Üí –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   USER      ‚îÇ      ‚îÇ     BOT      ‚îÇ      ‚îÇ  GPT SERVICE ‚îÇ
‚îÇ  Telegram   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   (8001)     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   (9000)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚ñ≤                      ‚ñ≤
                            ‚îÇ                      ‚îÇ
                            ‚ñº                      ‚ñº
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ   SERVER     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   OpenAI     ‚îÇ
                     ‚îÇ   (8000)     ‚îÇ      ‚îÇ     API      ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚ñ≤
                            ‚îÇ
                            ‚ñº
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ PostgreSQL   ‚îÇ
                     ‚îÇ    +Redis    ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (Step-by-Step)

### **–®–ê–ì 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏–∑**

**–§–∞–π–ª**: `bot/handlers/gpt.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `cb_ai_analysis`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "üß† AI-–∞–Ω–∞–ª–∏–∑" (callback_data = `"ai_analysis"`)
2. –ë–æ—Ç –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç: `"‚è≥ –ó–∞–ø—É—Å–∫–∞—é AI‚Äë–∞–Ω–∞–ª–∏–∑‚Ä¶"`
3. –ë–æ—Ç –¥–µ–ª–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å:
   ```python
   POST http://gpt:9000/v1/analysis/start
   Headers: {"X-API-KEY": "{API_SECRET_KEY}"}
   Body: {"telegram_id": 123456789, "period": "7d", "validate_output": true}
   ```
4. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ (HTTP 200): `"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω. –Ø –ø—Ä–∏—à–ª—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏..."`
5. –ü—Ä–∏ –æ—à–∏–±–∫–µ: `"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑. HTTP {status}"`

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**:
```python
# bot/core/config.py
gpt_service_url = os.getenv("GPT_SERVICE_URL", "http://127.0.0.1:9000")  # ‚úÖ –£–ñ–ï –ï–°–¢–¨
```

---

### **–®–ê–ì 2: GPT —Å–µ—Ä–≤–∏—Å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å**

**–§–∞–π–ª**: `gpt_integration/service.py` ‚Üí —ç–Ω–¥–ø–æ–∏–Ω—Ç `/v1/analysis/start`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –í–∞–ª–∏–¥–∞—Ü–∏—è `X-API-KEY` (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `API_SECRET_KEY`)
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: `telegram_id`, `period`, `validate_output`
3. **Fire-and-forget**: –∑–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏ `_orchestrate_analysis()`
4. –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç—É: `{"status": "accepted", "message": "analysis started"}`

**–ö–æ–¥**:
```python
@app.post("/v1/analysis/start")
async def analysis_start(req: AnalysisStartRequest, x_api_key: Optional[str] = Header(None)):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
    if not x_api_key or x_api_key != os.getenv("API_SECRET_KEY"):
        raise HTTPException(status_code=403, detail="Invalid or missing API key")
    
    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫
    asyncio.create_task(_orchestrate_analysis(req.telegram_id, req.period, req.validate_output))
    return {"status": "accepted", "message": "analysis started"}
```

---

### **–®–ê–ì 3: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ Server (Bot API)**

**–§–∞–π–ª**: `gpt_integration/service.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `_orchestrate_analysis`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç** (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã):

#### 3.1 –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂
```http
GET http://server:8000/api/v1/bot/analytics/sales?telegram_id=123&period=7d
Headers: {"X-API-SECRET-KEY": "{API_SECRET_KEY}"}
```

**–û—Ç–≤–µ—Ç** (—Å—Ö–µ–º–∞ `AnalyticsSalesAPIResponse`):
```json
{
  "status": "success",
  "analytics": {
    "date_range": {"start_date": "2025-10-21", "end_date": "2025-10-28"},
    "sales_periods": {
      "today": {"count": 45, "sum_rub": 120000},
      "yesterday": {"count": 41, "sum_rub": 110000}
    },
    "dynamics": {
      "yesterday_growth_percent": 9.8,
      "week_growth_percent": 15.2
    },
    "top_products": [
      {"sku": "SKU-123", "name": "–¢–æ–≤–∞—Ä 1", "revenue_rub": 48000, "count": 16}
    ]
  },
  "telegram_text": "üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π..."
}
```

#### 3.2 –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤
```http
GET http://server:8000/api/v1/bot/stocks/critical?telegram_id=123&limit=20&offset=0
```

**–û—Ç–≤–µ—Ç** (`CriticalStocksAPIResponse`):
```json
{
  "status": "success",
  "stocks": {
    "critical_items": [
      {"sku": "SKU-456", "name": "–¢–æ–≤–∞—Ä 2", "stock": 3, "warehouse": "–ö–æ–ª–µ–¥–∏–Ω–æ"}
    ],
    "total_critical": 12
  }
}
```

#### 3.3 –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –ø–æ –æ—Ç–∑—ã–≤–∞–º
```http
GET http://server:8000/api/v1/bot/reviews/summary?telegram_id=123&limit=10&offset=0
```

**–û—Ç–≤–µ—Ç** (`ReviewsSummaryAPIResponse`):
```json
{
  "status": "success",
  "reviews": {
    "total_reviews": 156,
    "rating_distribution": {"1": 5, "2": 3, "3": 10, "4": 38, "5": 100},
    "negative_reviews": [...],
    "average_rating": 4.6
  }
}
```

#### 3.4 –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–∫–∞–∑–æ–≤
```http
GET http://server:8000/api/v1/bot/orders/recent?telegram_id=123&limit=10&offset=0
```

**–û—Ç–≤–µ—Ç**:
```json
{
  "status": "success",
  "orders": [
    {"id": 123, "date": "2025-10-28T10:30:00+03:00", "amount": 2670, "status": "delivered"}
  ],
  "pagination": {"total": 450, "limit": 10, "offset": 0}
}
```

**–ö–æ–¥** (–≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ):
```python
sales_task = _fetch_analytics_sales(telegram_id, period, server_host, api_secret_key)
stocks_task = _fetch_stocks_critical(telegram_id, server_host, api_secret_key)
reviews_task = _fetch_reviews_summary(telegram_id, server_host, api_secret_key)
orders_task = _fetch_orders_recent(telegram_id, server_host, api_secret_key)

fetched = await asyncio.gather(sales_task, stocks_task, reviews_task, orders_task, 
                                return_exceptions=True)
```

---

### **–®–ê–ì 4: –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**

**–§–∞–π–ª**: `gpt_integration/aggregator.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `aggregate`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö –≤ –µ–¥–∏–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å
2. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫:
   - `day_over_day`: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫ –≤—á–µ—Ä–∞ (%)
   - `week_over_week`: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ (%)
   - `top_products_count`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ø-—Ç–æ–≤–∞—Ä–æ–≤
   - `critical_stocks_count`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**:
```python
sources = {
    "meta": {"telegram_id": 123, "period": "7d"},
    "sales": {...},  # –∏–∑ analytics/sales
    "stocks_critical": {...},  # –∏–∑ stocks/critical
    "reviews_summary": {...},  # –∏–∑ reviews/summary
    "orders_recent": {...}  # –∏–∑ orders/recent
}
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (–¥–ª—è LLM):
```python
{
  "meta": {
    "telegram_id": 123,
    "period": "7d",
    "computed_metrics": {
      "day_over_day": 9.8,
      "week_over_week": 15.2,
      "top_products_count": 5,
      "critical_stocks_count": 12
    }
  },
  "sales": {...},
  "stocks_critical": {...},
  "reviews_summary": {...},
  "orders_recent": {...},
  "top_products": [...]
}
```

---

### **–®–ê–ì 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è LLM**

**–§–∞–π–ª**: `gpt_integration/pipeline.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `compose_messages`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ –∏–∑ `LLM_ANALYSIS_TEMPLATE.md`
2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π:
   - `SYSTEM` ‚Äî —Ä–æ–ª—å –∏ —Å—Ç–∏–ª—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
   - `TASKS` ‚Äî —á—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
   - `OUTPUT_JSON_SCHEMA` ‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤—ã—Ö–æ–¥–Ω–æ–≥–æ JSON
   - `OUTPUT_TG_GUIDE` ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è Telegram-—Ç–µ–∫—Å—Ç–∞

3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è OpenAI:
```python
[
  {
    "role": "system",
    "content": "–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ e-commerce (Wildberries). –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ..."
  },
  {
    "role": "user",
    "content": """
### DATA
{aggregated_data_json}

### TASKS
1) –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (key_metrics)
...

### OUTPUT_JSON_SCHEMA
{...}

### OUTPUT_TG_GUIDE
{...}

–í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OUTPUT_JSON...
    """
  }
]
```

---

### **–®–ê–ì 6: –í—ã–∑–æ–≤ OpenAI API**

**–§–∞–π–ª**: `gpt_integration/gpt_client.py` ‚Üí –∫–ª–∞—Å—Å `GPTClient`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**:
```bash
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
OPENAI_API_KEY=sk-...
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o-mini
```

**–ó–∞–ø—Ä–æ—Å**:
```python
client = GPTClient.from_env()
response_text = client.complete_messages(messages)
```

**–û—Ç–≤–µ—Ç –æ—Ç OpenAI** (–ø—Ä–∏–º–µ—Ä):
```json
{
  "key_metrics": {
    "date_range": {"start_date": "2025-10-21", "end_date": "2025-10-28"},
    "orders_count": 450,
    "revenue_rub": 1200000,
    "avg_order_value": 2670,
    "day_over_day": 9.8,
    "week_over_week": 15.2,
    "top_products_count": 5,
    "critical_stocks_count": 12
  },
  "anomalies": [
    {
      "type": "low_stock",
      "description": "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ SKU-456 (3 —à—Ç.)",
      "severity": "high",
      "affected_items": ["SKU-456"]
    }
  ],
  "insights": [
    {
      "title": "–¢–æ–ø-5 —Ç–æ–≤–∞—Ä–æ–≤ –¥–∞—é—Ç 65% –≤—ã—Ä—É—á–∫–∏",
      "detail": "SKU-123, SKU-789... –°—Ç–æ–∏—Ç —Ä–∞—Å—à–∏—Ä–∏—Ç—å –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–∑–∏—Ü–∏–π"
    }
  ],
  "recommendations": [
    {
      "action": "replenish_stock",
      "why": "–û—Å—Ç–∞—Ç–∫–∏ SKU-456 < 5 —à—Ç., —Ä–∏—Å–∫ –¥–µ—Ñ–∏—Ü–∏—Ç–∞",
      "impact": "high",
      "effort": "medium",
      "items": ["SKU-456", "SKU-789"]
    }
  ],
  "telegram": {
    "chunks": [
      "üìä –û—Ç—á—ë—Ç –ø–æ –∫–∞–±–∏–Ω–µ—Ç—É: 2025-10-21 ‚Äî 2025-10-28\n\nüìà –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏...",
      "‚ö†Ô∏è –ê–Ω–æ–º–∞–ª–∏–∏\n‚Ä¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ SKU-456...",
      "‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n‚Ä¢ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ SKU-456..."
    ]
  },
  "sheets": {
    "headers": ["SKU", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–í—ã—Ä—É—á–∫–∞ ‚ÇΩ", "–ó–∞–∫–∞–∑—ã", "–û—Å—Ç–∞—Ç–æ–∫"],
    "rows": [
      ["SKU-123", "–¢–æ–≤–∞—Ä 1", 480000, 160, 45],
      ["SKU-456", "–¢–æ–≤–∞—Ä 2", 120000, 40, 3]
    ]
  }
}
```

---

### **–®–ê–ì 7: –ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞**

**–§–∞–π–ª**: `gpt_integration/pipeline.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `run_analysis`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM (—Ñ—É–Ω–∫—Ü–∏—è `_safe_json_extract`)
2. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–µ—Å–ª–∏ `validate=True`):
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π: `key_metrics`, `anomalies`, `insights`, `recommendations`, `telegram`, `sheets`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `telegram.chunks` –∏–ª–∏ `telegram.mdv2`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `sheets.headers` –∏ `sheets.rows`

3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è `telegram`:
   - –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è MarkdownV2
   - –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ —á–∞–Ω–∫–∏ (–µ—Å–ª–∏ —Ç–µ–∫—Å—Ç >3500 —Å–∏–º–≤–æ–ª–æ–≤)
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤

4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
   - –ï—Å–ª–∏ JSON –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π ‚Üí –ø–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ `OUTPUT_TG`
   - –ï—Å–ª–∏ LLM –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É ‚Üí —Ñ–æ–ª–±—ç–∫ —Ç–µ–∫—Å—Ç `"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM..."`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
```python
{
  "messages": [...],  # –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  "raw_response": "...",  # —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç LLM
  "json": {...},  # —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π JSON
  "telegram": {
    "chunks": ["—á–∞–Ω–∫ 1", "—á–∞–Ω–∫ 2", ...],
    "character_count": 2345
  },
  "sheets": {
    "headers": [...],
    "rows": [...]
  },
  "validation_errors": []  # –µ—Å–ª–∏ validate=True
}
```

---

### **–®–ê–ì 8: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –±–æ—Ç (webhook)**

**–§–∞–π–ª**: `gpt_integration/service.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `_post_bot_webhook`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∞–Ω–∫–æ–≤ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
   ```python
   chunks = result["telegram"]["chunks"]
   if not chunks and result["telegram"].get("mdv2"):
       chunks = [result["telegram"]["mdv2"]]
   if not chunks:
       chunks = ["‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞"]
   ```

2. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è** –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞:
   ```python
   for chunk in chunks:
       POST http://bot:8001/webhook/notifications/{telegram_id}
       Headers: {"Content-Type": "application/json"}
       Body: {
         "telegram_id": 123456789,
         "user_id": 123456789,
         "type": "analysis_completed",
         "telegram_text": chunk
       }
   ```

3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
   - –ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –Ω–∞ —ç—Ç–∞–ø–∞—Ö 3-7 ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ–ª–±—ç–∫ —Å–æ–æ–±—â–µ–Ω–∏—è:
     ```python
     fallback_text = f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}"
     await _post_bot_webhook(telegram_id, fallback_text, webhook_base)
     ```

---

### **–®–ê–ì 9: –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç –∏ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**

**–§–∞–π–ª**: `bot/handlers/webhook.py` ‚Üí —ç–Ω–¥–ø–æ–∏–Ω—Ç `/webhook/notifications/{telegram_id}`

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –ü–æ–ª—É—á–µ–Ω–∏–µ POST –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç GPT —Å–µ—Ä–≤–∏—Å–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ `telegram_id` (URL vs payload)
3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `telegram_text` –∏ `notification_type`
4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞:
   ```python
   if notification_type == "analysis_completed":
       # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ë–ï–ó parse_mode (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ MarkdownV2)
       await bot.send_message(
           chat_id=telegram_id,
           text=telegram_text,
           parse_mode=None  # ‚Üê –í–ê–ñ–ù–û!
       )
   ```

5. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 1-3 —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤ Telegram

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

### –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

| –≠—Ç–∞–ø | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
|------|-----------|----------------|-----------------|
| 1 | –ë–æ—Ç ‚Üí GPT | `{"telegram_id": 123, "period": "7d"}` | HTTP 202 Accepted |
| 2 | GPT ‚Üí Server | `telegram_id`, `period` | 4 JSON –æ—Ç–≤–µ—Ç–∞ (sales, stocks, reviews, orders) |
| 3 | Aggregator | 4 JSON –æ–±—ä–µ–∫—Ç–∞ | –ï–¥–∏–Ω—ã–π `data` —Å–ª–æ–≤–∞—Ä—å —Å `computed_metrics` |
| 4 | Pipeline | `data` + —à–∞–±–ª–æ–Ω | –ü—Ä–æ–º–ø—Ç –¥–ª—è OpenAI (system + user messages) |
| 5 | OpenAI | –ü—Ä–æ–º–ø—Ç | JSON —Å –∞–Ω–∞–ª–∏–∑–æ–º (key_metrics, anomalies, insights, recommendations, telegram, sheets) |
| 6 | Pipeline | JSON –æ—Ç OpenAI | –í–∞–ª–∏–¥–∞—Ü–∏—è + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (`telegram.chunks`, —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ) |
| 7 | GPT ‚Üí –ë–æ—Ç | `telegram.chunks` | Webhook –∑–∞–ø—Ä–æ—Å—ã (–ø–æ 1 –Ω–∞ —á–∞–Ω–∫) |
| 8 | –ë–æ—Ç ‚Üí User | `telegram_text` | Telegram —Å–æ–æ–±—â–µ–Ω–∏—è |

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)

### BOT (.env –¥–ª—è –±–æ—Ç–∞)
```bash
BOT_TOKEN=123456:ABC...                  # Telegram Bot Token
SERVER_HOST=http://server:8000           # –ê–¥—Ä–µ—Å Backend —Å–µ—Ä–≤–µ—Ä–∞
API_SECRET_KEY=your_secret_key_here      # –û–±—â–∏–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
GPT_SERVICE_URL=http://gpt:9000          # –ê–¥—Ä–µ—Å GPT —Å–µ—Ä–≤–∏—Å–∞
REQUEST_TIMEOUT=600                      # –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (10 –º–∏–Ω)
WEBHOOK_SECRET=default_webhook_secret    # –°–µ–∫—Ä–µ—Ç –¥–ª—è –≤–µ–±—Ö—É–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### GPT SERVICE (.env –¥–ª—è gpt_integration)
```bash
SERVER_HOST=http://server:8000                      # –û—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
API_SECRET_KEY=your_secret_key_here                 # –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Server API
BOT_WEBHOOK_BASE=http://bot:8001                    # –ö—É–¥–∞ —Å–ª–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
OPENAI_API_KEY=sk-...                               # OpenAI API –∫–ª—é—á
OPENAI_BASE_URL=https://api.openai.com/v1           # OpenAI endpoint
OPENAI_MODEL=gpt-4o-mini                            # –ú–æ–¥–µ–ª—å (gpt-4o-mini, gpt-4, gpt-3.5-turbo)
GPT_PORT=9000                                       # –ü–æ—Ä—Ç GPT —Å–µ—Ä–≤–∏—Å–∞
```

### SERVER (.env –¥–ª—è backend)
```bash
DATABASE_URL=postgresql://user:pass@db:5432/wb_assist
API_SECRET_KEY=your_secret_key_here                 # –¢–æ—Ç –∂–µ —Å–µ–∫—Ä–µ—Ç!
REDIS_URL=redis://redis:6379/0
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç: –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

| # | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
|---|-----------|------|--------|
| 1 | –ö–Ω–æ–ø–∫–∞ "üß† AI-–∞–Ω–∞–ª–∏–∑" | `bot/keyboards/keyboards.py:104` | ‚úÖ |
| 2 | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ | `bot/handlers/gpt.py:20-69` | ‚úÖ |
| 3 | –ö–æ–Ω—Ñ–∏–≥ `gpt_service_url` | `bot/core/config.py:43` | ‚úÖ |
| 4 | –≠–Ω–¥–ø–æ–∏–Ω—Ç `/v1/analysis/start` | `gpt_integration/service.py:190-199` | ‚úÖ |
| 5 | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è `_orchestrate_analysis` | `gpt_integration/service.py:124-188` | ‚úÖ |
| 6 | –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ Server | `gpt_integration/service.py:59-110` | ‚úÖ |
| 7 | –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | `gpt_integration/aggregator.py` | ‚úÖ |
| 8 | –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ | `gpt_integration/pipeline.py:14-43` | ‚úÖ |
| 9 | GPT –∫–ª–∏–µ–Ω—Ç | `gpt_integration/gpt_client.py` | ‚úÖ |
| 10 | –ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è | `gpt_integration/pipeline.py:111-170` | ‚úÖ |
| 11 | –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ webhook –±–æ—Ç–∞ | `gpt_integration/service.py:112-122, 177-178` | ‚úÖ |
| 12 | Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ | `bot/handlers/webhook.py:62-262` | ‚úÖ |
| 13 | Server Bot API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã | `server/app/features/bot_api/routes.py` | ‚úÖ |
| 14 | Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | `docker-compose.yml:124-142` | ‚úÖ |

**–í—ã–≤–æ–¥**: –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã! üéâ