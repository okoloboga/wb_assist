# План тестирования интеграции с Google Sheets

## Цели
- Проверить аутентификацию и стабильность работы `GoogleSheetsClient`.
- Подтвердить базовые операции: создание таблицы, запись, чтение.
- Протестировать массовые операции (`batchUpdate`) и базовое форматирование.
- Проверить права доступа при `drive.file` и работу с «чужими» таблицами.
- Оценить обработку ошибок, квот и обновление токена.

## Предусловия
- Включены `Google Sheets API` и `Google Drive API` в проекте `wbassist`.
- `config/credentials.json` — тип OAuth «Desktop application» (ключ `installed`), `redirect_uris` включает `http://localhost` или `http://localhost:8080/`.
- `config/token.json` создан (пройден OAuth, вы добавлены как Test User).
- `SCOPES`: `https://www.googleapis.com/auth/spreadsheets`, `https://www.googleapis.com/auth/drive.file`.
- Рабочая порт-конфигурация для локального OAuth: `GOOGLE_OAUTH_PORT=8080`.

## Сценарии тестирования

### 1. Аутентификация
- Инициализация `GoogleSheetsClient()` проходит без ошибок; `client.service` не `None`.
- Повторная инициализация при наличии `token.json` не запускает браузер, токен читается корректно.

### 2. Создание таблицы
- Вызов `create_spreadsheet("Тест мониторинга цен")` возвращает валидный `spreadsheetId`.
- Таблица доступна по URL `https://docs.google.com/spreadsheets/d/{spreadsheetId}`.

### 3. Запись и чтение значений
- Запись диапазона `A1:D3` с заголовками и данными:
  - Пример: `[['Товар','Цена','Конкурент 1','Конкурент 2'], ['iPhone 14','80000','79000','81000'], ['Samsung Galaxy','70000','69000','71000']]`.
- Проверка `updatedCells > 0`.
- Чтение `A1:D3` и сравнение с исходными значениями (совпадение заголовков и количества строк).

### 4. Массовые операции (batchUpdate)
- Добавление нового листа и переименование листа.
- Изменение ширины колонок, установка жирного шрифта для заголовков, выравнивание.
- Проверка результата через `spreadsheets.get` и визуально в UI Google Sheets.

### 5. Интеграция с моделью `Product`
- Формирование данных по `Product` (ID, название, бренд, артикул, категория, цены и позиция) и запись в `A1:K2`.
- Чтение обратно и валидация ключевых полей: название, текущая цена, позиция по цене.

### 6. Права доступа и `drive.file`
- Попытка чтения таблицы, которую приложение не создавало — ожидаем `403` (ограничение `drive.file`).
- Таблица, созданная приложением, доступна другим аккаунтам после явной выдачи доступа — чтение проходит успешно.

### 7. Обновление токена
- Эмуляция истечения токена (моки в тестах): вызывается `creds.refresh(Request())`.
- Повторная запись после «обновления» проходит успешно.

### 8. Ошибки и устойчивость
- Некорректный диапазон (например, `Z9999`) — ожидаем `HttpError` и корректный лог.
- Неверный `spreadsheetId` — ожидаем `404/HttpError`.
- Проверка реакции на `429 Too Many Requests` (моки) и наличие/план добавления backoff.

### 9. Производительность и квоты
- Серия из 30–60 операций чтения/записи с замером времени.
- Подтверждение отсутствия превышения минутных квот, оценка средней латентности.

### 10. Очистка
- Рекомендация: добавить метод удаления через Drive API (перемещение в корзину) для очистки тестовых таблиц.

## Автоматизация
- Юнит-тесты клиента:
  - Проверка аутентификации, записи/чтения, обработки ошибок через моки `googleapiclient`.
  - Проверка обновления токена через мок `Credentials`.
- Интеграционные тесты:
  - Полный сценарий с `Product`: создать таблицу, записать, прочитать, сверить данные.
  - Тест форматирования и `batchUpdate`.
- Смоук-скрипт:
  - Быстрая проверка: создать таблицу, записать заголовки и пару строк, прочитать и вывести краткий отчёт.

## Запуск
- Автотесты: `python -m unittest discover competitive_analysis/price_monitoring/tests -v`
- Смоук (при наличии флага): `python competitive_analysis/scripts/authorize_google_sheets.py --create-test`

## Критерии успеха
- `GoogleSheetsClient.service` инициализируется без браузера после появления `token.json`.
- Создание таблицы стабильно возвращает `spreadsheetId`; таблица открывается по URL.
- Запись и чтение диапазонов возвращают совпадающие значения и корректную метрику `updatedCells`.
- `batchUpdate` применяет структуру и форматирование, результаты подтверждаются API и визуально.
- Негативные сценарии возвращают ожидаемые ошибки, которые логируются и не падают без контроля.
- Права доступа соответствуют `drive.file` (ограничение на «чужие» таблицы соблюдается).

## Дальнейшие шаги
- Добавить метод удаления таблиц в клиенте для автоматической очистки.
- Реализовать экспоненциальный backoff и ретраи для `429/5xx`.
- При необходимости снизить предупреждения OAuth: добавить пользователей в «Test users» или ограничить `SCOPES` до `spreadsheets`.