# üö® S2 ISSUE: –ü—Ä–æ–±–ª–µ–º–∞ —Å nm_id –≤ API –æ—Ç–≤–µ—Ç–∞—Ö

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä `nm_id` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä–Ω—ã–º API —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º.

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

1. **WB API –¥–∞–Ω–Ω—ã–µ:**
   ```
   Step 2: nm_id = order_data.get('nmId') = 255366802
   Step 2: nm_id type = <class 'int'>
   Step 2: nm_id is None? False
   ```

2. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ WBOrder:**
   ```
   Step 5: WBOrder created, nm_id=255366802
   Step 5: WBOrder nm_id type = <class 'int'>
   Step 5: WBOrder nm_id value = 255366802
   ```

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:**
   ```
   Step 7: Order flushed to DB
   Step 8: Committing transaction
   Step 9: Transaction committed successfully
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î:**
   ```sql
   SELECT id, order_id, nm_id, name FROM wb_orders WHERE order_id = '2946945013846881169';
   -- –†–µ–∑—É–ª—å—Ç–∞—Ç: id=1, nm_id=255366802, name='–ë–ª—É–∑–∫–∏' ‚úÖ
   ```

5. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤:**
   ```
   DEBUG stocks: Found 53 stocks by nm_id
   DEBUG stocks_dict: Final result={'L': 27, 'M': 0, 'XL': 0, 'S': 17}
   ```

### ‚ùå –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **API –æ—Ç–≤–µ—Ç—ã:**
   ```json
   {
     "nm_id": null,  // ‚ùå –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 255366802
     "stocks": {}    // ‚ùå –î–æ–ª–∂–Ω–æ –±—ã—Ç—å {'L': 27, 'M': 0, 'XL': 0, 'S': 17}
   }
   ```

2. **–û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è:**
   ```
   DEBUG final stocks: {order_data.get('stocks', {})}
   DEBUG final nm_id: {order_data.get('nm_id', 'NOT_FOUND')}
   ```
   **–≠—Ç–∏ –ª–æ–≥–∏ –ù–ï –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –≤—ã–≤–æ–¥–µ!**

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:

1. **WB API ‚Üí –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**
   - ‚úÖ `nm_id` –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ WB API
   - ‚úÖ `nm_id` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ WBOrder
   - ‚úÖ `nm_id` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î

2. **–ë–î ‚Üí API –æ—Ç–≤–µ—Ç:**
   - ‚úÖ `nm_id` —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –ë–î
   - ‚úÖ `stocks` —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–æ `nm_id`
   - ‚ùå **–î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –≥–¥–µ-—Ç–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞**

### –ö–æ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:

```python
# –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º
stocks_dict = {}
for stock in stocks:
    size = stock.size or "ONE SIZE"
    quantity = stock.quantity or 0
    stocks_dict[size] = quantity
# –†–µ–∑—É–ª—å—Ç–∞—Ç: {'L': 27, 'M': 0, 'XL': 0, 'S': 17} ‚úÖ

# –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
order_data = {
    "stocks": stocks_dict,  # ‚úÖ –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    "nm_id": order.nm_id,  # ‚úÖ –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
}

# –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è!
logger.info(f"DEBUG final stocks: {order_data.get('stocks', {})}")
logger.info(f"DEBUG final nm_id: {order_data.get('nm_id', 'NOT_FOUND')}")
```

## üéØ –ì–∏–ø–æ—Ç–µ–∑—ã –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–û—à–∏–±–∫–∞ –≤ `_get_product_statistics`:**
   - –ú–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
   - –ö–æ–¥ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤
   - **–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** –ü—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 2. **–û—à–∏–±–∫–∞ –≤ `format_order_detail`:**
   - –§–æ—Ä–º–∞—Ç—Ç–µ—Ä –∏–∑–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
   - **–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** –ü—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π JSON:**
   - FastAPI –Ω–µ –º–æ–∂–µ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
   - **‚úÖ –†–ï–®–ï–ù–û:** Pydantic —Å—Ö–µ–º—ã –æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç –ø–æ–ª—è

### 4. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º:**
   - –î–∞–Ω–Ω—ã–µ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ API
   - **–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç

### 5. **–ü—Ä–æ–±–ª–µ–º–∞ —Å SQLAlchemy —Å–µ—Å—Å–∏–µ–π:**
   - –°–µ—Å—Å–∏—è –Ω–µ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - Lazy loading –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üîç –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏

### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ª–æ–≥–∏:
```python
# –í get_order_detail
logger.info(f"DEBUG stocks: order.nm_id={order.nm_id}, type={type(order.nm_id)}")
logger.info(f"DEBUG stocks_dict: Final result={stocks_dict}")
logger.info(f"DEBUG final stocks: {order_data.get('stocks', {})}")
logger.info(f"DEBUG final nm_id: {order_data.get('nm_id', 'NOT_FOUND')}")
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –õ–æ–≥–∏ `DEBUG stocks` –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
- ‚úÖ –õ–æ–≥–∏ `DEBUG stocks_dict` –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è  
- ‚ùå –õ–æ–≥–∏ `DEBUG final` –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è

**–í—ã–≤–æ–¥:** –ö–æ–¥ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –º–µ–∂–¥—É —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º `stocks_dict` –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏!

## üö® –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å

**–í–´–°–û–ö–ê–Ø:** –ë–µ–∑ `nm_id` –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∑–∞–∫–∞–∑—ã –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–∞–π—Ç–∏ —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏** –º–µ–∂–¥—É `stocks_dict` –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã** –º–µ–∂–¥—É —ç—Ç–∏–º–∏ —Ç–æ—á–∫–∞–º–∏
3. **–î–æ–±–∞–≤–∏—Ç—å try-catch** –≤–æ–∫—Ä—É–≥ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ –∫–æ–¥–∞
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Pydantic —Å—Ö–µ–º—ã** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—Ç–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è –ø–æ–ª–µ–π
5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å FastAPI —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é** JSON

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```json
{
  "nm_id": 255366802,
  "stocks": {
    "L": 27,
    "M": 0, 
    "XL": 0,
    "S": 17
  }
}
```

## ‚úÖ –†–ï–®–ï–ù–ò–ï

**–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ Pydantic —Å—Ö–µ–º–µ `OrderData`!**

**–ü—Ä–∏—á–∏–Ω–∞:** Pydantic –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Å—Ö–µ–º–µ –º–æ–¥–µ–ª–∏.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `nm_id` –∏ `stocks` –≤ —Å—Ö–µ–º—É `OrderData`:

```python
class OrderData(BaseModel):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    # –ü–æ–ª—è –¥–ª—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ nm_id
    nm_id: Optional[int] = None
    stocks: Optional[Dict[str, int]] = None
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "nm_id": 255366802,
  "stocks": {
    "L": 27,
    "M": 0, 
    "XL": 0,
    "S": 17
  }
}
```

## üìä –°—Ç–∞—Ç—É—Å

- **–ü—Ä–æ–±–ª–µ–º–∞:** ‚úÖ –†–ï–®–ï–ù–ê
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
- **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** Backend Team
- **–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-07
- **–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è:** 2025-10-07
- **–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-10-07
