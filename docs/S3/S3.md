# 📘 Спецификация этапа 3: Система уведомлений

---

## 🎯 Цель этапа

**РЕАЛИЗОВАНА** полнофункциональная система уведомлений для пользователей бота о ключевых событиях Wildberries с поддержкой общих кабинетов и polling архитектуры.

---

## ✅ Что реализовано

### **1. Архитектура системы**
- **Polling система** - бот периодически запрашивает новые уведомления с сервера
- **Единая синхронизация** - все данные WB синхронизируются в БД через Celery
- **Event-driven уведомления** - система обнаруживает изменения и генерирует уведомления
- **Мультипользовательские кабинеты** - несколько пользователей на один API ключ

### **2. Типы уведомлений**
- **Новые заказы** - с детальной информацией и изображениями товаров
- **Изменения статуса заказов** - выкупы, отмены, возвраты
- **Негативные отзывы** - отзывы с оценкой 1-3 звезды
- **Критические остатки** - товары с остатком ≤ 2 штук

### **3. Настройки пользователя**
- Включение/отключение всех уведомлений
- Индивидуальные настройки по типам уведомлений
- Группировка уведомлений (опционально)

### **4. Технические особенности**
- **Timezone поддержка** - централизованный `TimezoneUtils` для единой работы с МСК (UTC+3)
- **Rate limiting** - улучшенная обработка 429 ошибок с `Retry-After` заголовком
- **Retry механизмы** - агрессивный exponential backoff до 5 минут для "sales" API
- **Image support** - отображение изображений товаров в уведомлениях
- **Duplicate prevention** - защита от дублирования уведомлений через `NotificationHistory`
- **Smart stock detection** - фильтрация межскладских переводов в критических остатках

---

## 🏗️ Архитектура системы

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   WB API        │───▶│  Sync Service    │───▶│   Database      │
│   (Wildberries) │    │  (Celery Tasks)  │    │   (PostgreSQL)  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Bot           │◀───│  Polling API     │◀───│ Notification   │
│   (Telegram)    │    │  (/poll)         │    │ Service         │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

---

## 🔄 Флоу работы системы

### **1. Синхронизация данных**
- **Celery Beat** запускает периодические задачи синхронизации
- **WBSyncService** получает данные из WB API
- Данные сохраняются в БД с метками времени
- Создаются записи в `WBSyncLog` для отслеживания статуса

### **2. Обнаружение событий**
- **NotificationService** сравнивает текущие и предыдущие данные
- Обнаруживает новые заказы, изменения статусов, критические остатки
- Фильтрует события по времени последней проверки пользователя

### **3. Polling система**
- **Bot** каждые N секунд запрашивает новые уведомления
- **API endpoint** `/api/v1/notifications/poll` возвращает новые события
- **Bot** отправляет уведомления пользователю в Telegram

### **4. Обработка уведомлений**
- **EventDetector** определяет тип события
- **NotificationGenerator** создает контент уведомления
- **BotMessageFormatter** форматирует сообщение для Telegram
- **Bot** отправляет уведомление с изображением (если есть)

---

## 📁 Структура файлов

### **Backend (Server)**
```
server/app/features/notifications/
├── notification_service.py      # Центральный сервис
├── event_detector.py           # Обнаружение событий
├── notification_generator.py   # Генерация уведомлений
├── models.py                   # Модели БД
├── crud.py                     # CRUD операции
├── schemas.py                  # Pydantic схемы
└── api/
    └── polling.py              # Polling API endpoint
```

### **Frontend (Bot)**
```
bot/handlers/
├── polling.py                  # Polling система
├── notifications.py            # Обработка уведомлений
└── orders.py                   # Команды заказов
```

### **Sync Service**
```
server/app/features/wb_api/
├── sync_service.py             # Синхронизация с WB
├── models.py                   # Модели WB данных
└── crud_cabinet_users.py       # Управление кабинетами
```

---

## 🗄️ База данных

### **Основные таблицы**
- `wb_orders` - заказы WB
- `wb_products` - товары с изображениями
- `wb_stocks` - остатки товаров
- `wb_reviews` - отзывы
- `wb_sync_logs` - логи синхронизации
- `notification_settings` - настройки уведомлений
- `cabinet_users` - связь пользователей с кабинетами

### **Ключевые поля**
- `WBProduct.image_url` - URL изображения товара
- `WBSyncLog.completed_at` - время завершения синхронизации
- `NotificationSettings.notifications_enabled` - глобальное включение/отключение

---

## ⚙️ Конфигурация

### **Environment Variables**
```env
# Polling интервал (секунды)
POLLING_INTERVAL=30

# WB API rate limits
WB_API_RATE_LIMIT=30  # requests per minute
WB_API_INTERVAL=2000   # ms between requests
```

### **Настройки уведомлений**
- Глобальное включение/отключение
- Индивидуальные настройки по типам
- Группировка уведомлений
- Таймауты и лимиты

---

## 🐛 Известные проблемы и решения

### **1. Дублирование уведомлений** ✅ РЕШЕНО
- **Проблема:** Старые заказы повторно уведомляются
- **Решение:** Фильтрация через `NotificationHistory` для исключения уже отправленных заказов
- **Реализация:** Запрос `sent_order_ids` за последние 24 часа в `_get_new_orders()`

### **2. Критические остатки без реального движения** ✅ РЕШЕНО
- **Проблема:** Уведомления при межскладских переводах
- **Решение:** Сравнение агрегированных остатков до и после `last_check`
- **Реализация:** Проверка `previous_total > critical_threshold` и `current_total <= critical_threshold` и `current_total < previous_total`

### **3. Timezone несоответствия** ✅ РЕШЕНО
- **Проблема:** Смешение UTC и MSK
- **Решение:** Централизованный `TimezoneUtils` модуль для единой работы с МСК
- **Реализация:** Все `datetime.now(timezone.utc)` заменены на `TimezoneUtils.now_msk()`

### **4. Rate limiting WB API** ✅ РЕШЕНО
- **Проблема:** 429 Too Many Requests
- **Решение:** Улучшенная обработка `Retry-After` заголовка и агрессивный exponential backoff
- **Реализация:** До 5 минут задержки для "sales" API, до 2 минут для других

---

## 📊 Мониторинг и логирование

### **Ключевые метрики**
- Количество синхронизаций в час
- Успешность API запросов
- Время отклика polling системы
- Количество отправленных уведомлений

### **Логирование**
- Синхронизация: `WBSyncLog` таблица
- Уведомления: `NotificationHistory` таблица
- Ошибки: Application logs с детализацией

---

## 🚀 Развертывание

### **Требования**
- PostgreSQL 15+
- Redis 6+
- Python 3.12+
- Celery с Redis broker

### **Компоненты**
- **Server** - FastAPI приложение
- **Celery Worker** - фоновые задачи синхронизации
- **Celery Beat** - планировщик задач
- **Bot** - Telegram бот с polling

---

## 📋 Статус реализации

* ✅ **Polling система** - работает стабильно
* ✅ **Синхронизация данных** - автоматическая через Celery
* ✅ **Уведомления о заказах** - с изображениями и детальной информацией
* ✅ **Критические остатки** - с фильтрацией межскладских переводов
* ✅ **Настройки пользователя** - полная настройка типов уведомлений
* ✅ **Timezone поддержка** - централизованный `TimezoneUtils` для МСК
* ✅ **Rate limiting** - улучшенная обработка 429 ошибок с `Retry-After`
* ✅ **Мультипользовательские кабинеты** - несколько пользователей на API
* ✅ **Duplicate prevention** - защита от дублирования через `NotificationHistory`
* ✅ **Code optimization** - удалены неиспользуемые функции, устранено дублирование