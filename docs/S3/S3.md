# 📘 Спецификация этапа 3: Система уведомлений

## ОБЩИЙ ПРОЦЕСС РАБОТЫ

- Пользователь нажимает на /start и система его регистрирует в БД по telegram_id
- Бот предлагает ввести WB API - без ключа нельзя попасть в главное меню
- Пользователь вводит WB API - он проверяется и в случае валидности начинается Первичная синхронизация
- Пока синхронизация не будет окончена - пользователь не может попасть в главное меню. Во время первичной синхронизации мы получаем от серверов WB данные за указанный последний интервал
- Когда Первичная синхронизация окончена - пользователь попадает в главное меню (webhook - бот шлёт сообщение)
- Уведомления НЕ приходят при первичной синхронизации
- Каждые {SYNC_INTERVAL} секунд Celery запускает последующие синхронизации и проверяет на наличие актуальных данных
- Если есть обновлённые данные про: Заказы, Выкупы, Отмены заказов, Возвраты, Негативные отзывы, Критические Остатки на складах - сервер по Webhook присылает об этом уведомления
- Если новых данных нет при синхронизации - нет никаких сообщений и уведомлений
- Пользователь может отключать разные виды уведомлений в настройках

## 🔄 АРХИТЕКТУРА СИНХРОНИЗАЦИИ

1. **Celery Beat** запускает `sync_all_cabinets()` каждые `SYNC_INTERVAL` секунд
                          ↓
2. **sync_cabinet_data()** вызывается для каждого кабинета
                          ↓
3. **В sync_all_data():**
   - Сохраняется `previous_sync_at = cabinet.last_sync_at`
   - Выполняется синхронизация данных с WB API (flag=0 для sales)
   - Обрабатываются события через `process_sync_events_simple()`
   - Обновляется `cabinet.last_sync_at = now()`
   - Коммит в БД
                          ↓
4. **В process_sync_events_simple():**
   - Используется `previous_sync_at` для поиска новых событий
   - Выкупы/возвраты ищутся по `created_at > previous_sync_at` (время добавления в БД)
   - Заказы/отмены ищутся по `created_at/updated_at > previous_sync_at`
   - Формируются уведомления с полной информацией о товарах
                          ↓
5. **Webhook отправка:**
   - Уведомления отправляются через HTTP POST webhook
   - Сохраняются в `NotificationHistory` для предотвращения дублирования
                          ↓
6. **Бот получает webhook** уведомления и отправляет их пользователю

---

## ✅ Что реализовано

### **1. Архитектура системы**
- **Webhook система** - сервер отправляет уведомления боту в реальном времени через webhook
- **Единая синхронизация** - все данные WB синхронизируются в БД через Celery
- **Event-driven уведомления** - система обнаруживает изменения и генерирует уведомления
- **Мультипользовательские кабинеты** - несколько пользователей на один API ключ
- **Гибридная система обнаружения** - использует `created_at`/`updated_at` для определения новых событий
- **Полная синхронизация sales** - всегда использует `flag=0` для надежности получения всех данных

### **2. Типы уведомлений**
- **Новые заказы** - с детальной информацией и изображениями товаров
- **Выкупы** - события выкупа товаров с полной статистикой
- **Отмены заказов** - отмененные заказы с информацией о товаре
- **Возвраты** - события возврата товаров с полной статистикой
- **Негативные отзывы** - отзывы с оценкой 1-3 звезды
- **Критические остатки** - товары с остатком ≤ 2 штук

### **3. Настройки пользователя**
- Включение/отключение всех уведомлений
- Индивидуальные настройки по типам уведомлений
- Управление через главное меню бота "Уведомления"
- Настройки сохраняются в БД и применяются сразу

### **4. Технические особенности**
- **Timezone поддержка** - централизованный `TimezoneUtils` для единой работы с МСК (UTC+3)
- **Правильная обработка дат** - WB API возвращает МСК, парсится как МСК, конвертируется в UTC для БД
- **Отображение времени** - UTC из БД конвертируется в МСК для пользователя
- **Rate limiting** - улучшенная обработка 429 ошибок с `Retry-After` заголовком
- **Retry механизмы** - агрессивный exponential backoff до 5 минут для "sales" API
- **Image support** - отображение изображений товаров в уведомлениях
- **Duplicate prevention** - защита от дублирования уведомлений через `NotificationHistory`
- **Smart stock detection** - фильтрация межскладских переводов в критических остатках

### **5. Архитектура данных для уведомлений**
- **WBOrder** - заказы со статусами (новые заказы через `created_at`, отмены через `updated_at`)
- **WBSales** - события продаж/возвратов (выкупы/возвраты через `created_at` - время добавления в БД)
- **WBReview** - отзывы (негативные отзывы через `created_date`)
- **Разделение по доменам** - заказы ≠ финансовые события
- **Логика времени** - `created_at` для новых записей, `updated_at` для изменений существующих

---

## 🏗️ Архитектура системы

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   WB API        │───▶│  Sync Service    │───▶│   Database      │
│   (Wildberries) │    │  (Celery Tasks)  │    │   (PostgreSQL)  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Bot           │◀───│  Webhook API     │◀───│ Notification   │
│   (Telegram)    │    │  (HTTP POST)     │    │ Service         │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

---

## 🔄 Флоу работы системы

### **1. Синхронизация данных**
- **Celery Beat** запускает периодические задачи синхронизации каждые `SYNC_INTERVAL` секунд
- **WBSyncService** получает данные из WB API
- **Sales API** всегда использует `flag=0` (полная синхронизация) для надежности получения всех данных
- Данные сохраняются в БД с метками времени (`created_at`, `updated_at`)
- Создаются записи в `WBSyncLog` для отслеживания статуса
- **Timezone:** WB API возвращает МСК, парсится как МСК, конвертируется в UTC для хранения

### **2. Обнаружение событий**
- **NotificationService** использует гибридный подход с прямыми SQL-запросами
- Обнаруживает новые заказы, выкупы, отмены, возвраты, негативные отзывы
- Использует `created_at`/`updated_at` для определения новых событий
- Фильтрует события по `last_sync_at` (время последней успешной синхронизации)
- **Ключевая особенность:** выкупы/возвраты ищутся по `created_at` (время добавления в БД), а не по `sale_date` (время события)

### **3. Webhook система**
- **NotificationService** отправляет уведомления через HTTP POST webhook
- **Bot** получает webhook уведомления в реальном времени
- **Bot** отправляет уведомления пользователю в Telegram
- **WebhookSender** обрабатывает retry логику и ошибки

### **4. Обработка уведомлений**
- **NotificationService** использует гибридный подход с прямыми SQL-запросами
- **EventDetector** определяет тип события
- **NotificationGenerator** создает контент уведомления с полной информацией о товаре
- **BotMessageFormatter** форматирует сообщение для Telegram
- **Bot** отправляет уведомление с изображением (если есть)
- **WebhookSender** отправляет уведомления через HTTP POST
- **Защита от дублирования:** уведомления сохраняются в `NotificationHistory`

---

## 📁 Структура файлов

### **Backend (Server)**
```
server/app/features/notifications/
├── notification_service.py      # Центральный сервис с гибридной логикой
├── event_detector.py           # Обнаружение событий
├── notification_generator.py   # Генерация уведомлений
├── models.py                   # Модели БД
├── crud.py                     # CRUD операции
├── schemas.py                  # Pydantic схемы
└── webhook_sender.py           # Webhook отправка уведомлений

server/app/features/wb_api/
├── sync_service.py             # Синхронизация с WB (flag=0 для sales)
├── models.py                   # Модели WB данных
├── models_sales.py             # Модель WBSales
├── client.py                   # WB API клиент
└── crud_cabinet_users.py       # Управление кабинетами

server/app/utils/
└── timezone.py                 # TimezoneUtils для работы с МСК/UTC
```

### **Frontend (Bot)**
```
bot/handlers/
├── webhook.py                  # Webhook обработчики уведомлений
├── notifications.py            # Обработка уведомлений
├── orders.py                   # Команды заказов
└── commands.py                 # Основные команды бота
```

### **Sync Service**
```
server/app/features/sync/
├── tasks.py                    # Celery задачи синхронизации
└── wb_sync_integration.py      # Интеграция с уведомлениями
```

---

## 🗄️ База данных

### **Основные таблицы**
- `wb_orders` - заказы WB (новые заказы, отмены)
- `wb_sales` - события продаж/возвратов (выкупы, возвраты)
- `wb_products` - товары с изображениями
- `wb_stocks` - остатки товаров
- `wb_reviews` - отзывы (негативные отзывы)
- `wb_sync_logs` - логи синхронизации
- `notification_settings` - настройки уведомлений
- `notification_history` - история отправленных уведомлений
- `cabinet_users` - связь пользователей с кабинетами

### **Ключевые поля**
- `WBOrder.created_at` - время создания заказа в БД
- `WBOrder.updated_at` - время последнего изменения заказа
- `WBSales.created_at` - время добавления события в БД
- `WBSales.sale_date` - время события по WB (в UTC)
- `WBSales.type` - тип события ('buyout', 'return')
- `WBReview.created_date` - время создания отзыва
- `WBProduct.image_url` - URL изображения товара
- `WBSyncLog.completed_at` - время завершения синхронизации
- `NotificationSettings.notifications_enabled` - глобальное включение/отключение

---

## ⚙️ Конфигурация

### **Environment Variables**
```env
# Синхронизация интервал (секунды)
SYNC_INTERVAL=180

# WB API rate limits
WB_API_RATE_LIMIT=30  # requests per minute
WB_API_INTERVAL=2000   # ms between requests

# Database
POSTGRES_USER=user
POSTGRES_PASSWORD=password
POSTGRES_DB=wb_assist_db

# Redis
REDIS_URL=redis://localhost:6379/0

# Bot
BOT_TOKEN=your_telegram_bot_token
WEBHOOK_URL=https://your-domain.com/webhook
```

### **Настройки уведомлений**
- Глобальное включение/отключение (`notifications_enabled`)
- Индивидуальные настройки по типам:
  - `new_orders_enabled` - новые заказы
  - `order_buyouts_enabled` - выкупы
  - `order_cancellations_enabled` - отмены
  - `order_returns_enabled` - возвраты
  - `negative_reviews_enabled` - негативные отзывы
  - `critical_stocks_enabled` - критические остатки
- Управление через главное меню бота "Уведомления"
- Настройки сохраняются в БД и применяются сразу

---

## 📊 Мониторинг и логирование

### **Ключевые метрики**
- Количество синхронизаций в час
- Успешность API запросов
- Время доставки webhook уведомлений
- Количество отправленных уведомлений
- Статистика по типам событий (заказы, выкупы, отмены, возвраты, отзывы)
- Производительность SQL-запросов

### **Логирование**
- Синхронизация: `WBSyncLog` таблица
- Уведомления: `NotificationHistory` таблица
- Ошибки: Application logs с детализацией
- Детальные логи для каждого типа события
- Статистика по пользователям и кабинетам

### **Мониторинг в реальном времени**
- Логи Celery Worker для отслеживания синхронизации
- Логи Bot для отслеживания доставки уведомлений
- Метрики производительности API
- Статистика использования WB API

---

## 🚀 Развертывание

### **Требования**
- PostgreSQL 15+
- Redis 6+
- Python 3.12+
- Celery с Redis broker

### **Компоненты**
- **Server** - FastAPI приложение с API для синхронизации
- **Celery Worker** - фоновые задачи синхронизации
- **Celery Beat** - планировщик задач (каждые SYNC_INTERVAL секунд)
- **Bot** - Telegram бот с webhook обработчиками
- **PostgreSQL** - основная база данных
- **Redis** - кэш и брокер для Celery

### **Docker Compose**
```yaml
services:
  server:
    build: ./server
    ports:
      - "8000:8000"
    environment:
      - SYNC_INTERVAL=180
      - POSTGRES_URL=postgresql://user:password@postgres:5432/wb_assist_db
      - REDIS_URL=redis://redis:6379/0
  
  celery-worker:
    build: ./server
    command: celery -A app.core.celery_app worker --loglevel=info
    environment:
      - SYNC_INTERVAL=180
  
  celery-beat:
    build: ./server
    command: celery -A app.core.celery_app beat --loglevel=info
    environment:
      - SYNC_INTERVAL=180
  
  bot:
    build: ./bot
    environment:
      - BOT_TOKEN=your_telegram_bot_token
      - WEBHOOK_URL=https://your-domain.com/webhook
  
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=wb_assist_db
  
  redis:
    image: redis:7-alpine
```

