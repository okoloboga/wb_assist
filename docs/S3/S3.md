# ๐ ะกะฟะตัะธัะธะบะฐัะธั ััะฐะฟะฐ 3: ะกะธััะตะผะฐ ัะฒะตะดะพะผะปะตะฝะธะน

## ะะะฉะะ ะะะะฆะะกะก ะะะะะขะซ

- ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั ะฝะฐ /start ะธ ัะธััะตะผะฐ ะตะณะพ ัะตะณะธัััะธััะตั ะฒ ะะ ะฟะพ telegram_id
- ะะพั ะฟัะตะดะปะฐะณะฐะตั ะฒะฒะตััะธ WB API - ะฑะตะท ะบะปััะฐ ะฝะตะปัะทั ะฟะพะฟะฐััั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั
- ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั WB API - ะพะฝ ะฟัะพะฒะตััะตััั ะธ ะฒ ัะปััะฐะต ะฒะฐะปะธะดะฝะพััะธ ะฝะฐัะธะฝะฐะตััั ะะตัะฒะธัะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั
ะะพะบะฐ ัะธะฝััะพะฝะธะทะฐัะธั ะฝะต ะฑัะดะตั ะพะบะพะฝัะตะฝะฐ - ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะผะพะถะตั ะฟะพะฟะฐััั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั. ะะพ ะฒัะตะผั ะฟะตัะฒะธัะฝะพะน
ะกะธะฝััะพะฝะธะทะฐัะธะธ ะผั ะฟะพะปััะฐะตะผ ะพั ัะตัะฒะตัะพะฒ WB ะดะฐะฝะฝัะต ะทะฐ ัะบะฐะทะฐะฝะฝัะน ะฟะพัะปะตะดะฝะธะน ะธะฝัะตัะฒะฐะป
- ะะพะณะดะฐ ะะตัะฒะธัะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั ะพะบะพะฝัะตะฝะฐ - ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะฟะฐะดะฐะตั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั (webhook - ะฑะพั ัะปัั ัะพะพะฑัะตะฝะธะต)
ะะพ ะฝะต ะฟัะธัะพะดัั ัะฒะตะดะพะผะปะตะฝะธั - ัะฒะตะดะพะผะปะตะฝะธั ะะ ะดะพะปะถะฝั ะฟัะธัะพะดะธัั ะฟัะธ ะฟะตัะฒะธัะฝะพะน ัะธะฝะฝััะพะฝะธะทะฐัะธะธ
- ะะฐะถะดัะต {SYNC_INTERVAL} ัะตะบัะฝะด Celery ะทะฐะฟััะบะฐะตั ะฟะพัะปะตะดัััะธะต ัะธะฝััะพะฝะธะทะฐัะธะธ ะธ ะฟัะพะฒะตััะตั ะฝะฐ ะฝะฐะปะธัะธะต 
ะฐะบััะฐะปัะฝัั ะดะฐะฝะฝัั
- ะัะปะธ ะตััั ะพะฑะฝะพะฒะปัะฝะฝัะต ะดะฟะฝะฝัะต ะฟัะพ: ะะฐะบะฐะทั, ะัะบัะฟั, ะัะผะตะฝั ะทะฐะบะฐะทะพะฒ, ะะพะทะฒัะฐัั, ะะตะณะฐัะธะฒะฝัะต ะพัะทัะฒั, 
ะัะธัะธัะตัะบะธะต ะััะฐัะบะธ ะฝะฐ ัะบะปะฐะดะฐั - ัะตัะฒะตั ะฟะพ Webhook ะฟัะธััะปะฐะตั ะพะฑ ััะพะผ ัะฒะตะดะพะผะปะตะฝะธั
- ะัะปะธ ะฝะพะฒัั ะดะฐะฝะฝัั ะฝะตั ะฟัะธ ัะธะฝััะพะฝะธะทะฐัะธะธ - ะฝะตั ะฝะธะบะฐะบะธั ัะพะพะฑัะตะฝะธะน ะธ ัะฒะตะดะพะผะปะตะฝะธะน
- ะะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั ะพัะบะปััะฐัั ัะฐะทะฝัะต ะฒะธะดั ัะฒะตะดะพะผะปะตะฝะธะน ะฒ ะฝะฐัััะพะนะบะฐั

1. Celery Beat ะทะฐะฟััะบะฐะตั sync_all_cabinets() ะบะฐะถะดัะต SYNC_INTERVAL ัะตะบัะฝะด
                          โ
2. sync_cabinet_data() ะฒัะทัะฒะฐะตััั ะดะปั ะบะฐะถะดะพะณะพ ะบะฐะฑะธะฝะตัะฐ
                          โ
3. ะ sync_all_data():
   - ะกะพััะฐะฝัะตััั previous_sync_at = cabinet.last_sync_at  โ ะะะะะ!
   - ะัะฟะพะปะฝัะตััั ัะธะฝััะพะฝะธะทะฐัะธั ะดะฐะฝะฝัั ั WB API
   - ะะฑะฝะพะฒะปัะตััั cabinet.last_sync_at = now()
   - ะะพะผะผะธั ะฒ ะะ
                          โ
4. ะ _send_sync_completion_notification():
   - ะะตัะตะดะฐะตััั previous_sync_at  โ ะะะะะ!
   - ะัะทัะฒะฐะตััั _get_current_orders_for_notifications(cabinet_id, previous_sync_at)
   - ะัะทัะฒะฐะตััั _get_previous_orders_for_notifications(cabinet_id, previous_sync_at)
   - ะะฐะฝะฝัะต ะบะพััะตะบัะฝะพ ัะธะปัััััััั: updated_at > previous_sync_at  โ ะะกะะะะะะะะ!
                          โ
5. ะ process_sync_events():
   - ะะฑะฝะฐััะถะธะฒะฐัััั ะฝะพะฒัะต ัะพะฑััะธั
   - ะคะพัะผะธัััััั ัะฒะตะดะพะผะปะตะฝะธั
   - ะัะฟัะฐะฒะปััััั ัะตัะตะท webhook
   - ะกะพััะฐะฝััััั ะฒ NotificationHistory  โ ะะะะะ!
                          โ
6. ะะพั ะฟะพะปััะฐะตั webhook ัะฒะตะดะพะผะปะตะฝะธั ะธ ะพัะฟัะฐะฒะปัะตั ะธั ะฟะพะปัะทะพะฒะฐัะตะปั

---

## โ ะงัะพ ัะตะฐะปะธะทะพะฒะฐะฝะพ

### **1. ะััะธัะตะบัััะฐ ัะธััะตะผั**
- **Webhook ัะธััะตะผะฐ** - ัะตัะฒะตั ะพัะฟัะฐะฒะปัะตั ัะฒะตะดะพะผะปะตะฝะธั ะฑะพัั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ ัะตัะตะท webhook
- **ะะดะธะฝะฐั ัะธะฝััะพะฝะธะทะฐัะธั** - ะฒัะต ะดะฐะฝะฝัะต WB ัะธะฝััะพะฝะธะทะธัััััั ะฒ ะะ ัะตัะตะท Celery
- **Event-driven ัะฒะตะดะพะผะปะตะฝะธั** - ัะธััะตะผะฐ ะพะฑะฝะฐััะถะธะฒะฐะตั ะธะทะผะตะฝะตะฝะธั ะธ ะณะตะฝะตัะธััะตั ัะฒะตะดะพะผะปะตะฝะธั
- **ะัะปััะธะฟะพะปัะทะพะฒะฐัะตะปััะบะธะต ะบะฐะฑะธะฝะตัั** - ะฝะตัะบะพะปัะบะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฝะฐ ะพะดะธะฝ API ะบะปัั

### **๐ง ะะกะะะะะะะะะฏ (2025-01-28)**
- **ะะพััะดะพะบ ัะธะฝััะพะฝะธะทะฐัะธะธ** - ัะพะฑััะธั ะพะฑัะฐะฑะฐััะฒะฐัััั ะะ ะพะฑะฝะพะฒะปะตะฝะธั `last_sync_at`
- **ะะพะณะธะบะฐ ะฟะพะธัะบะฐ ัะพะฑััะธะน** - ะฒัะบัะฟั/ะฒะพะทะฒัะฐัั ะธััััั ะฒ `WBSales`, ะฐ ะฝะต ะฒ `WBOrder`
- **Timezone ะธัะฟัะฐะฒะปะตะฝะธั** - ะฒะตะทะดะต ัััะพะณะพ ะะกะ ะฒัะตะผั
- **ะฃะฑัะฐะฝ ะดะฒะพะนะฝะพะน ะบะพะผะผะธั** - ะบะพะผะผะธั ะฟัะพะธััะพะดะธั ัะพะปัะบะพ ะพะดะธะฝ ัะฐะท
- **ะัะฟัะฐะฒะปะตะฝั ัะพัะผะฐััะตัั** - ัะฐะฑะพัะฐัั ั ะฟัะฐะฒะธะปัะฝัะผะธ ะผะพะดะตะปัะผะธ ะดะฐะฝะฝัั

### **2. ะขะธะฟั ัะฒะตะดะพะผะปะตะฝะธะน**
- **ะะพะฒัะต ะทะฐะบะฐะทั** - ั ะดะตัะฐะปัะฝะพะน ะธะฝัะพัะผะฐัะธะตะน ะธ ะธะทะพะฑัะฐะถะตะฝะธัะผะธ ัะพะฒะฐัะพะฒ
- **ะะทะผะตะฝะตะฝะธั ััะฐัััะฐ ะทะฐะบะฐะทะพะฒ** - ะฒัะบัะฟั, ะพัะผะตะฝั, ะฒะพะทะฒัะฐัั
- **ะะตะณะฐัะธะฒะฝัะต ะพัะทัะฒั** - ะพัะทัะฒั ั ะพัะตะฝะบะพะน 1-3 ะทะฒะตะทะดั
- **ะัะธัะธัะตัะบะธะต ะพััะฐัะบะธ** - ัะพะฒะฐัั ั ะพััะฐัะบะพะผ โค 2 ัััะบ

### **3. ะะฐัััะพะนะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั**
- ะะบะปััะตะฝะธะต/ะพัะบะปััะตะฝะธะต ะฒัะตั ัะฒะตะดะพะผะปะตะฝะธะน
- ะะฝะดะธะฒะธะดัะฐะปัะฝัะต ะฝะฐัััะพะนะบะธ ะฟะพ ัะธะฟะฐะผ ัะฒะตะดะพะผะปะตะฝะธะน
- ะััะฟะฟะธัะพะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน (ะพะฟัะธะพะฝะฐะปัะฝะพ)

### **4. ะขะตัะฝะธัะตัะบะธะต ะพัะพะฑะตะฝะฝะพััะธ**
- **Timezone ะฟะพะดะดะตัะถะบะฐ** - ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝัะน `TimezoneUtils` ะดะปั ะตะดะธะฝะพะน ัะฐะฑะพัั ั ะะกะ (UTC+3)
- **Rate limiting** - ัะปัััะตะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ 429 ะพัะธะฑะพะบ ั `Retry-After` ะทะฐะณะพะปะพะฒะบะพะผ
- **Retry ะผะตัะฐะฝะธะทะผั** - ะฐะณัะตััะธะฒะฝัะน exponential backoff ะดะพ 5 ะผะธะฝัั ะดะปั "sales" API
- **Image support** - ะพัะพะฑัะฐะถะตะฝะธะต ะธะทะพะฑัะฐะถะตะฝะธะน ัะพะฒะฐัะพะฒ ะฒ ัะฒะตะดะพะผะปะตะฝะธัั
- **Duplicate prevention** - ะทะฐัะธัะฐ ะพั ะดัะฑะปะธัะพะฒะฐะฝะธั ัะฒะตะดะพะผะปะตะฝะธะน ัะตัะตะท `NotificationHistory`
- **Smart stock detection** - ัะธะปัััะฐัะธั ะผะตะถัะบะปะฐะดัะบะธั ะฟะตัะตะฒะพะดะพะฒ ะฒ ะบัะธัะธัะตัะบะธั ะพััะฐัะบะฐั

---

## ๐๏ธ ะััะธัะตะบัััะฐ ัะธััะตะผั

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   WB API        โโโโโถโ  Sync Service    โโโโโถโ   Database      โ
โ   (Wildberries) โ    โ  (Celery Tasks)  โ    โ   (PostgreSQL)  โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
                                โ
                                โผ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   Bot           โโโโโโ  Webhook API     โโโโโโ Notification   โ
โ   (Telegram)    โ    โ  (HTTP POST)     โ    โ Service         โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะคะปะพั ัะฐะฑะพัั ัะธััะตะผั

### **1. ะกะธะฝััะพะฝะธะทะฐัะธั ะดะฐะฝะฝัั**
- **Celery Beat** ะทะฐะฟััะบะฐะตั ะฟะตัะธะพะดะธัะตัะบะธะต ะทะฐะดะฐัะธ ัะธะฝััะพะฝะธะทะฐัะธะธ
- **WBSyncService** ะฟะพะปััะฐะตั ะดะฐะฝะฝัะต ะธะท WB API
- ะะฐะฝะฝัะต ัะพััะฐะฝััััั ะฒ ะะ ั ะผะตัะบะฐะผะธ ะฒัะตะผะตะฝะธ
- ะกะพะทะดะฐัััั ะทะฐะฟะธัะธ ะฒ `WBSyncLog` ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ััะฐัััะฐ

### **2. ะะฑะฝะฐััะถะตะฝะธะต ัะพะฑััะธะน**
- **NotificationService** ััะฐะฒะฝะธะฒะฐะตั ัะตะบััะธะต ะธ ะฟัะตะดัะดััะธะต ะดะฐะฝะฝัะต
- ะะฑะฝะฐััะถะธะฒะฐะตั ะฝะพะฒัะต ะทะฐะบะฐะทั, ะธะทะผะตะฝะตะฝะธั ััะฐัััะพะฒ, ะบัะธัะธัะตัะบะธะต ะพััะฐัะบะธ
- ะคะธะปััััะตั ัะพะฑััะธั ะฟะพ ะฒัะตะผะตะฝะธ ะฟะพัะปะตะดะฝะตะน ะฟัะพะฒะตัะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั

### **3. Webhook ัะธััะตะผะฐ**
- **NotificationService** ะพัะฟัะฐะฒะปัะตั ัะฒะตะดะพะผะปะตะฝะธั ัะตัะตะท HTTP POST webhook
- **Bot** ะฟะพะปััะฐะตั webhook ัะฒะตะดะพะผะปะตะฝะธั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- **Bot** ะพัะฟัะฐะฒะปัะตั ัะฒะตะดะพะผะปะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ Telegram

### **4. ะะฑัะฐะฑะพัะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน**
- **EventDetector** ะพะฟัะตะดะตะปัะตั ัะธะฟ ัะพะฑััะธั
- **NotificationGenerator** ัะพะทะดะฐะตั ะบะพะฝัะตะฝั ัะฒะตะดะพะผะปะตะฝะธั
- **BotMessageFormatter** ัะพัะผะฐัะธััะตั ัะพะพะฑัะตะฝะธะต ะดะปั Telegram
- **Bot** ะพัะฟัะฐะฒะปัะตั ัะฒะตะดะพะผะปะตะฝะธะต ั ะธะทะพะฑัะฐะถะตะฝะธะตะผ (ะตัะปะธ ะตััั)

---

## ๐ ะกัััะบัััะฐ ัะฐะนะปะพะฒ

### **Backend (Server)**
```
server/app/features/notifications/
โโโ notification_service.py      # ะฆะตะฝััะฐะปัะฝัะน ัะตัะฒะธั
โโโ event_detector.py           # ะะฑะฝะฐััะถะตะฝะธะต ัะพะฑััะธะน
โโโ notification_generator.py   # ะะตะฝะตัะฐัะธั ัะฒะตะดะพะผะปะตะฝะธะน
โโโ models.py                   # ะะพะดะตะปะธ ะะ
โโโ crud.py                     # CRUD ะพะฟะตัะฐัะธะธ
โโโ schemas.py                  # Pydantic ััะตะผั
โโโ webhook_sender.py           # Webhook ะพัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน
```

### **Frontend (Bot)**
```
bot/handlers/
โโโ webhook.py                  # Webhook ะพะฑัะฐะฑะพััะธะบะธ ัะฒะตะดะพะผะปะตะฝะธะน
โโโ notifications.py            # ะะฑัะฐะฑะพัะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน
โโโ orders.py                   # ะะพะผะฐะฝะดั ะทะฐะบะฐะทะพะฒ
```

### **Sync Service**
```
server/app/features/wb_api/
โโโ sync_service.py             # ะกะธะฝััะพะฝะธะทะฐัะธั ั WB
โโโ models.py                   # ะะพะดะตะปะธ WB ะดะฐะฝะฝัั
โโโ crud_cabinet_users.py       # ะฃะฟัะฐะฒะปะตะฝะธะต ะบะฐะฑะธะฝะตัะฐะผะธ
```

---

## ๐๏ธ ะะฐะทะฐ ะดะฐะฝะฝัั

### **ะัะฝะพะฒะฝัะต ัะฐะฑะปะธัั**
- `wb_orders` - ะทะฐะบะฐะทั WB
- `wb_products` - ัะพะฒะฐัั ั ะธะทะพะฑัะฐะถะตะฝะธัะผะธ
- `wb_stocks` - ะพััะฐัะบะธ ัะพะฒะฐัะพะฒ
- `wb_reviews` - ะพัะทัะฒั
- `wb_sync_logs` - ะปะพะณะธ ัะธะฝััะพะฝะธะทะฐัะธะธ
- `notification_settings` - ะฝะฐัััะพะนะบะธ ัะฒะตะดะพะผะปะตะฝะธะน
- `cabinet_users` - ัะฒัะทั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ั ะบะฐะฑะธะฝะตัะฐะผะธ

### **ะะปััะตะฒัะต ะฟะพะปั**
- `WBProduct.image_url` - URL ะธะทะพะฑัะฐะถะตะฝะธั ัะพะฒะฐัะฐ
- `WBSyncLog.completed_at` - ะฒัะตะผั ะทะฐะฒะตััะตะฝะธั ัะธะฝััะพะฝะธะทะฐัะธะธ
- `NotificationSettings.notifications_enabled` - ะณะปะพะฑะฐะปัะฝะพะต ะฒะบะปััะตะฝะธะต/ะพัะบะปััะตะฝะธะต

---

## โ๏ธ ะะพะฝัะธะณััะฐัะธั

### **Environment Variables**
```env
# ะกะธะฝััะพะฝะธะทะฐัะธั ะธะฝัะตัะฒะฐะป (ัะตะบัะฝะดั)
SYNC_INTERVAL=180

# WB API rate limits
WB_API_RATE_LIMIT=30  # requests per minute
WB_API_INTERVAL=2000   # ms between requests
```

### **ะะฐัััะพะนะบะธ ัะฒะตะดะพะผะปะตะฝะธะน**
- ะะปะพะฑะฐะปัะฝะพะต ะฒะบะปััะตะฝะธะต/ะพัะบะปััะตะฝะธะต
- ะะฝะดะธะฒะธะดัะฐะปัะฝัะต ะฝะฐัััะพะนะบะธ ะฟะพ ัะธะฟะฐะผ
- ะััะฟะฟะธัะพะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน
- ะขะฐะนะผะฐััั ะธ ะปะธะผะธัั

---

## ๐ ะะพะฝะธัะพัะธะฝะณ ะธ ะปะพะณะธัะพะฒะฐะฝะธะต

### **ะะปััะตะฒัะต ะผะตััะธะบะธ**
- ะะพะปะธัะตััะฒะพ ัะธะฝััะพะฝะธะทะฐัะธะน ะฒ ัะฐั
- ะฃัะฟะตัะฝะพััั API ะทะฐะฟัะพัะพะฒ
- ะัะตะผั ะดะพััะฐะฒะบะธ webhook ัะฒะตะดะพะผะปะตะฝะธะน
- ะะพะปะธัะตััะฒะพ ะพัะฟัะฐะฒะปะตะฝะฝัั ัะฒะตะดะพะผะปะตะฝะธะน

### **ะะพะณะธัะพะฒะฐะฝะธะต**
- ะกะธะฝััะพะฝะธะทะฐัะธั: `WBSyncLog` ัะฐะฑะปะธัะฐ
- ะฃะฒะตะดะพะผะปะตะฝะธั: `NotificationHistory` ัะฐะฑะปะธัะฐ
- ะัะธะฑะบะธ: Application logs ั ะดะตัะฐะปะธะทะฐัะธะตะน

---

## ๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต

### **ะขัะตะฑะพะฒะฐะฝะธั**
- PostgreSQL 15+
- Redis 6+
- Python 3.12+
- Celery ั Redis broker

### **ะะพะผะฟะพะฝะตะฝัั**
- **Server** - FastAPI ะฟัะธะปะพะถะตะฝะธะต
- **Celery Worker** - ัะพะฝะพะฒัะต ะทะฐะดะฐัะธ ัะธะฝััะพะฝะธะทะฐัะธะธ
- **Celery Beat** - ะฟะปะฐะฝะธัะพะฒัะธะบ ะทะฐะดะฐั
- **Bot** - Telegram ะฑะพั ั webhook ะพะฑัะฐะฑะพััะธะบะฐะผะธ

