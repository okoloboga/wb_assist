# 📘 Спецификация этапа 3: Система уведомлений

## ОБЩИЙ ПРОЦЕСС РАБОТЫ

- Пользователь нажимает на /start и система его регистрирует в БД по telegram_id
- Бот предлагает ввести WB API - без ключа нельзя попасть в главное меню
- Пользователь вводит WB API - он проверяется и в случае валидности начинается Первичная синхронизация
Пока синхронизация не будет окончена - пользователь не может попасть в главное меню. Во время первичной
Синхронизации мы получаем от серверов WB данные за указанный последний интервал
- Когда Первичная синхронизация окончена - пользователь попадает в главное меню (webhook - бот шлёт сообщение)
Но не приходят уведомления - уведомления НЕ должны приходить при первичной синнхронизации
- Каждые {SYNC_INTERVAL} секунд Celery запускает последующие синхронизации и проверяет на наличие 
актуальных данных
- Если есть обновлённые дпнные про: Заказы, Выкупы, Отмены заказов, Возвраты, Негативные отзывы, 
Критические Остатки на складах - сервер по Webhook присылает об этом уведомления
- Если новых данных нет при синхронизации - нет никаких сообщений и уведомлений
- Пользователь может отключать разные виды уведомлений в настройках

1. Celery Beat запускает sync_all_cabinets() каждые SYNC_INTERVAL секунд
                          ↓
2. sync_cabinet_data() вызывается для каждого кабинета
                          ↓
3. В sync_all_data():
   - Сохраняется previous_sync_at = cabinet.last_sync_at  ← НОВОЕ!
   - Выполняется синхронизация данных с WB API
   - Обновляется cabinet.last_sync_at = now()
   - Коммит в БД
                          ↓
4. В _send_sync_completion_notification():
   - Передается previous_sync_at  ← НОВОЕ!
   - Вызывается _get_current_orders_for_notifications(cabinet_id, previous_sync_at)
   - Вызывается _get_previous_orders_for_notifications(cabinet_id, previous_sync_at)
   - Данные корректно фильтруются: updated_at > previous_sync_at  ← ИСПРАВЛЕНО!
                          ↓
5. В process_sync_events():
   - Обнаруживаются новые события
   - Формируются уведомления
   - Отправляются через webhook
   - Сохраняются в NotificationHistory  ← НОВОЕ!
                          ↓
6. Бот получает webhook уведомления и отправляет их пользователю

---

## ✅ Что реализовано

### **1. Архитектура системы**
- **Webhook система** - сервер отправляет уведомления боту в реальном времени через webhook
- **Единая синхронизация** - все данные WB синхронизируются в БД через Celery
- **Event-driven уведомления** - система обнаруживает изменения и генерирует уведомления
- **Мультипользовательские кабинеты** - несколько пользователей на один API ключ

### **🔧 ИСПРАВЛЕНИЯ (2025-01-28)**
- **Порядок синхронизации** - события обрабатываются ДО обновления `last_sync_at`
- **Логика поиска событий** - выкупы/возвраты ищутся в `WBSales`, а не в `WBOrder`
- **Timezone исправления** - везде строго МСК время
- **Убран двойной коммит** - коммит происходит только один раз
- **Исправлены форматтеры** - работают с правильными моделями данных
- **Celery concurrency** - уменьшен с 2 до 1 воркера для предотвращения дублирования
- **SYNC_INTERVAL** - исправлено использование переменной окружения вместо хардкода
- **ZeroDivisionError** - исправлено деление на ноль в расчете процента выкупов
- **Подсчет остатков** - исправлена логика суммирования остатков в уведомлениях
- **Формат негативных отзывов** - улучшен с информацией о заказе и правильными звездами
- **Шаблоны уведомлений** - упрощены и оптимизированы для лучшей читаемости

### **🔧 КРИТИЧЕСКИЕ ИСПРАВЛЕНИЯ ЛОГИКИ УВЕДОМЛЕНИЙ (2025-01-28)**
- **Фильтрация по времени** - выкупы/возвраты/отзывы теперь ищутся за последние 24 часа вместо `last_sync_at`
- **Логика событий** - исправлена разница между обновлениями записей (отмены) и новыми событиями (выкупы)
- **Убраны лишние логи** - убраны подробные логи с остатками, которые засоряли консоль
- **Централизация настроек** - настройки уведомлений перенесены только в главное меню "Уведомления"
- **Исправлена кнопка "Назад"** - добавлен обработчик для кнопки "Назад к меню"
- **ГЛАВНАЯ ПРОБЛЕМА РЕШЕНА** - выкупы и возвраты теперь работают корректно

### **2. Типы уведомлений**
- **Новые заказы** - с детальной информацией и изображениями товаров
- **Изменения статуса заказов** - выкупы, отмены, возвраты
- **Негативные отзывы** - отзывы с оценкой 1-3 звезды
- **Критические остатки** - товары с остатком ≤ 2 штук

### **3. Настройки пользователя**
- Включение/отключение всех уведомлений
- Индивидуальные настройки по типам уведомлений
- Группировка уведомлений (опционально)

### **4. Технические особенности**
- **Timezone поддержка** - централизованный `TimezoneUtils` для единой работы с МСК (UTC+3)
- **Rate limiting** - улучшенная обработка 429 ошибок с `Retry-After` заголовком
- **Retry механизмы** - агрессивный exponential backoff до 5 минут для "sales" API
- **Image support** - отображение изображений товаров в уведомлениях
- **Duplicate prevention** - защита от дублирования уведомлений через `NotificationHistory`
- **Smart stock detection** - фильтрация межскладских переводов в критических остатках

### **5. Архитектура данных для уведомлений**
- **WBOrder** - заказы со статусами (отмены работают через `updated_at`)
- **WBSales** - события продаж/возвратов (выкупы работают через `sale_date`)
- **Разделение по доменам** - заказы ≠ финансовые события
- **Логика времени** - обновления записей vs новые события

---

## 🏗️ Архитектура системы

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   WB API        │───▶│  Sync Service    │───▶│   Database      │
│   (Wildberries) │    │  (Celery Tasks)  │    │   (PostgreSQL)  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Bot           │◀───│  Webhook API     │◀───│ Notification   │
│   (Telegram)    │    │  (HTTP POST)     │    │ Service         │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

---

## 🔄 Флоу работы системы

### **1. Синхронизация данных**
- **Celery Beat** запускает периодические задачи синхронизации
- **WBSyncService** получает данные из WB API
- Данные сохраняются в БД с метками времени
- Создаются записи в `WBSyncLog` для отслеживания статуса

### **2. Обнаружение событий**
- **NotificationService** сравнивает текущие и предыдущие данные
- Обнаруживает новые заказы, изменения статусов, критические остатки
- Фильтрует события по времени последней проверки пользователя

### **3. Webhook система**
- **NotificationService** отправляет уведомления через HTTP POST webhook
- **Bot** получает webhook уведомления в реальном времени
- **Bot** отправляет уведомления пользователю в Telegram

### **4. Обработка уведомлений**
- **EventDetector** определяет тип события
- **NotificationGenerator** создает контент уведомления
- **BotMessageFormatter** форматирует сообщение для Telegram
- **Bot** отправляет уведомление с изображением (если есть)

---

## 📁 Структура файлов

### **Backend (Server)**
```
server/app/features/notifications/
├── notification_service.py      # Центральный сервис
├── event_detector.py           # Обнаружение событий
├── notification_generator.py   # Генерация уведомлений
├── models.py                   # Модели БД
├── crud.py                     # CRUD операции
├── schemas.py                  # Pydantic схемы
└── webhook_sender.py           # Webhook отправка уведомлений
```

### **Frontend (Bot)**
```
bot/handlers/
├── webhook.py                  # Webhook обработчики уведомлений
├── notifications.py            # Обработка уведомлений
└── orders.py                   # Команды заказов
```

### **Sync Service**
```
server/app/features/wb_api/
├── sync_service.py             # Синхронизация с WB
├── models.py                   # Модели WB данных
└── crud_cabinet_users.py       # Управление кабинетами
```

---

## 🗄️ База данных

### **Основные таблицы**
- `wb_orders` - заказы WB
- `wb_products` - товары с изображениями
- `wb_stocks` - остатки товаров
- `wb_reviews` - отзывы
- `wb_sync_logs` - логи синхронизации
- `notification_settings` - настройки уведомлений
- `cabinet_users` - связь пользователей с кабинетами

### **Ключевые поля**
- `WBProduct.image_url` - URL изображения товара
- `WBSyncLog.completed_at` - время завершения синхронизации
- `NotificationSettings.notifications_enabled` - глобальное включение/отключение

---

## ⚙️ Конфигурация

### **Environment Variables**
```env
# Синхронизация интервал (секунды)
SYNC_INTERVAL=180

# WB API rate limits
WB_API_RATE_LIMIT=30  # requests per minute
WB_API_INTERVAL=2000   # ms between requests
```

### **Настройки уведомлений**
- Глобальное включение/отключение
- Индивидуальные настройки по типам
- Группировка уведомлений
- Таймауты и лимиты

---

## 📊 Мониторинг и логирование

### **Ключевые метрики**
- Количество синхронизаций в час
- Успешность API запросов
- Время доставки webhook уведомлений
- Количество отправленных уведомлений

### **Логирование**
- Синхронизация: `WBSyncLog` таблица
- Уведомления: `NotificationHistory` таблица
- Ошибки: Application logs с детализацией

---

## 🚀 Развертывание

### **Требования**
- PostgreSQL 15+
- Redis 6+
- Python 3.12+
- Celery с Redis broker

### **Компоненты**
- **Server** - FastAPI приложение
- **Celery Worker** - фоновые задачи синхронизации
- **Celery Beat** - планировщик задач
- **Bot** - Telegram бот с webhook обработчиками

