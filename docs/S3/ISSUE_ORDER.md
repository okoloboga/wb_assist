# üìã –î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ó–ê–ö–ê–ó–ï - –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

## üéØ –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ –≤ Telegram –±–æ—Ç–µ WB Assist.

---

## üìä –ü–†–ò–ú–ï–† –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø

```
–ó–∞–∫–∞–∑ ID: 2207 –æ—Ç 23.10.2025 13:00

üÜî 225287280 / slavabrand_dress_white_belt / (M)
üéπ 2041472975210

üí∞ –§–∏–Ω–∞–Ω—Å—ã:
–¶–µ–Ω–∞ –∑–∞–∫–∞–∑–∞: 8,100.0‚ÇΩ
–°–ü–ü %: 23.0%
–¶–µ–Ω–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: 1,626.0‚ÇΩ
–°–∫–∏–¥–∫–∞: 74.0%

üöõ –ö–∞–∑–∞–Ω—å -> –ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å

üìà –í—ã–∫—É–ø—ã –∑–∞ –ø–µ—Ä–∏–æ–¥—ã:
7 | 14 | 30 –¥–Ω–µ–π:
19 | 25 | 32

üîç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º:
–í—Å–µ–≥–æ: 140 –∑–∞–∫–∞–∑–æ–≤
–ê–∫—Ç–∏–≤–Ω—ã–µ: 85
–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ: 55
–í—ã–∫—É–ø—ã: 32
–í–æ–∑–≤—Ä–∞—Ç—ã: 7

‚≠ê –†–µ–π—Ç–∏–Ω–≥ –∏ –æ—Ç–∑—ã–≤—ã:
–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: 4.63
–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: 351

5‚≠ê - 84.4%
4‚≠ê - 5.8%
3‚≠ê - 3.9%
2‚≠ê - 1.9%
1‚≠ê - 3.9%

üì¶ –û—Å—Ç–∞—Ç–∫–∏ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º:
L: 91 —à—Ç.
M: 86 —à—Ç.
S: 46 —à—Ç.
XL: 0 —à—Ç.
```

---

## üîÑ –ü–†–û–¶–ï–°–° –ü–û–õ–£–ß–ï–ù–ò–Ø –î–ê–ù–ù–´–•

### 1Ô∏è‚É£ **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ (Telegram Bot)**

**–§–∞–π–ª:** `bot/handlers/orders.py`  
**–§—É–Ω–∫—Ü–∏—è:** `show_order_details(callback: CallbackQuery)`  
**–°—Ç—Ä–æ–∫–∏:** 151-215

#### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- **Callback data:** `order_details_{order_id}` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `order_details_2207`)
- **User ID:** `callback.from_user.id` (Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

#### –ü—Ä–æ—Ü–µ—Å—Å:
1. –ü–∞—Ä—Å–∏–º `order_id` –∏–∑ callback data (—Å—Ç—Ä–æ–∫–∞ 155)
2. –í—ã–∑—ã–≤–∞–µ–º API –∫–ª–∏–µ–Ω—Ç: `bot_api_client.get_order_details(order_id, user_id)` (—Å—Ç—Ä–æ–∫–∞ 160)

---

### 2Ô∏è‚É£ **HTTP –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É (Bot API Client)**

**–§–∞–π–ª:** `bot/api/client.py`  
**–§—É–Ω–∫—Ü–∏—è:** `get_order_details(order_id: int, user_id: int)`  
**–°—Ç—Ä–æ–∫–∏:** 351-354

#### HTTP –∑–∞–ø—Ä–æ—Å:
```http
GET /api/v1/bot/orders/{order_id}?telegram_id={user_id}
Headers:
  X-API-SECRET-KEY: {API_SECRET_KEY}
  Content-Type: application/json
```

**–ü—Ä–∏–º–µ—Ä:** `GET /api/v1/bot/orders/2207?telegram_id=5101525651`

#### Retry –ª–æ–≥–∏–∫–∞:
- **–ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫:** 3
- **Timeout:** 30 —Å–µ–∫—É–Ω–¥
- **Exponential backoff:** 1s ‚Üí 2s ‚Üí 4s

---

### 3Ô∏è‚É£ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (Bot API Service)**

**–§–∞–π–ª:** `server/app/features/bot_api/routes.py`  
**Endpoint:** `GET /api/v1/bot/orders/{order_id}`  
**–§—É–Ω–∫—Ü–∏—è:** `get_order_detail(order_id, telegram_id, db)`

#### –ü—Ä–æ—Ü–µ—Å—Å:
1. –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `telegram_id` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users`
2. –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å: `BotAPIService.get_order_detail(order_id, user.id, db)`

---

### 4Ô∏è‚É£ **–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–µ (Bot API Service)**

**–§–∞–π–ª:** `server/app/features/bot_api/service.py`  
**–§—É–Ω–∫—Ü–∏—è:** `get_order_detail(order_id: int, user_id: int, db: Session)`  
**–°—Ç—Ä–æ–∫–∏:** 247-429

#### üìä **–ò–°–ü–û–õ–¨–ó–£–ï–ú–´–ï –¢–ê–ë–õ–ò–¶–´ –ë–î:**

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü–æ–ª—è |
|---------|-----------|------|
| **users** | –°–≤—è–∑—å Telegram ‚Üí Cabinet | `id`, `telegram_id` |
| **cabinet_users** | –°–≤—è–∑—å User ‚Üí Cabinet | `user_id`, `cabinet_id` |
| **wb_cabinets** | WB –∫–∞–±–∏–Ω–µ—Ç—ã | `id`, `api_key`, `name` |
| **wb_orders** | –ó–∞–∫–∞–∑—ã WB | `id`, `order_id`, `nm_id`, `name`, `article`, `size`, `barcode`, `total_price`, `spp_percent`, `customer_price`, `discount_percent`, `warehouse_from`, `warehouse_to`, `order_date`, `status` |
| **wb_products** | –¢–æ–≤–∞—Ä—ã WB | `nm_id`, `rating`, `image_url` |
| **wb_stocks** | –û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ | `nm_id`, `size`, `quantity`, `warehouse_name` |
| **wb_reviews** | –û—Ç–∑—ã–≤—ã | `nm_id`, `rating`, `created_at` |
| **wb_sales** | –ü—Ä–æ–¥–∞–∂–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç—ã | `nm_id`, `type` ('buyout'/'return'), `sale_date`, `is_cancel` |

---

#### üìù **–î–ï–¢–ê–õ–¨–ù–´–ô –ü–†–û–¶–ï–°–° –°–ë–û–†–ê –î–ê–ù–ù–´–•:**

##### **–®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞**
**–°—Ç—Ä–æ–∫–∏:** 260-272  
**–ó–∞–ø—Ä–æ—Å:**
```sql
SELECT * FROM wb_orders 
WHERE id = {order_id} 
  AND cabinet_id = {cabinet.id}
```

**–ü–æ–ª—É—á–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- Order ID (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)
- WB Order ID
- NM ID —Ç–æ–≤–∞—Ä–∞
- –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
- –ê—Ä—Ç–∏–∫—É–ª, —Ä–∞–∑–º–µ—Ä, —à—Ç—Ä–∏—Ö–∫–æ–¥
- –¶–µ–Ω—ã (total_price, spp_percent, customer_price, discount_percent)
- –°–∫–ª–∞–¥—ã (warehouse_from, warehouse_to)
- –î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞, —Å—Ç–∞—Ç—É—Å

---

##### **–®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ**
**–°—Ç—Ä–æ–∫–∏:** 274-280  
**–ó–∞–ø—Ä–æ—Å:**
```sql
SELECT * FROM wb_products 
WHERE cabinet_id = {cabinet_id} 
  AND nm_id = {order.nm_id}
```

**–ü–æ–ª—É—á–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –†–µ–π—Ç–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞ (`rating`)
- URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (`image_url`)

---

##### **–®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–∞ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º**
**–°—Ç—Ä–æ–∫–∏:** 282-299  
**–ó–∞–ø—Ä–æ—Å:**
```sql
SELECT * FROM wb_stocks 
WHERE cabinet_id = {cabinet_id} 
  AND nm_id = {order.nm_id}
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```python
# –°—É–º–º–∏—Ä—É–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
stocks_dict = {}
for stock in stocks:
    size = stock.size or "ONE SIZE"
    quantity = stock.quantity or 0
    if size in stocks_dict:
        stocks_dict[size] += quantity  # –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ!
    else:
        stocks_dict[size] = quantity
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `{"L": 91, "M": 86, "S": 46, "XL": 0}`

---

##### **–®–∞–≥ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∑—ã–≤–æ–≤**
**–°—Ç—Ä–æ–∫–∏:** 301-307  
**–ó–∞–ø—Ä–æ—Å:**
```sql
SELECT COUNT(*) FROM wb_reviews 
WHERE cabinet_id = {cabinet_id} 
  AND nm_id = {order.nm_id}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `reviews_count = 351`

---

##### **–®–∞–≥ 5: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–¥–∞–∂**
**–§—É–Ω–∫—Ü–∏—è:** `_get_product_statistics(cabinet_id, nm_id)`  
**–°—Ç—Ä–æ–∫–∏:** 1527-1582

**5.1 –í—ã–∫—É–ø—ã –∑–∞ –ø–µ—Ä–∏–æ–¥—ã (7/14/30 –¥–Ω–µ–π):**
```sql
SELECT * FROM wb_sales 
WHERE cabinet_id = {cabinet_id} 
  AND nm_id = {nm_id}
  AND sale_date >= {start_date}
  AND type = 'buyout'
  AND is_cancel = False
```

**–ü–µ—Ä–∏–æ–¥—ã:**
- `7_days`: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
- `14_days`: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
- `30_days`: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `{"7_days": 19, "14_days": 25, "30_days": 32}`

---

##### **–®–∞–≥ 6: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∑–∞–∫–∞–∑–∞–º**
**–°—Ç—Ä–æ–∫–∏:** 316-342

**6.1 –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ (–∞–∫—Ç–∏–≤–Ω—ã–µ/–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ):**
```sql
SELECT 
    COUNT(id) as total_orders,
    COUNT(CASE WHEN status = 'active' THEN 1 END) as active_orders,
    COUNT(CASE WHEN status = 'canceled' THEN 1 END) as canceled_orders
FROM wb_orders 
WHERE cabinet_id = {cabinet_id} 
  AND nm_id = {nm_id}
```

**6.2 –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ (–≤—ã–∫—É–ø—ã/–≤–æ–∑–≤—Ä–∞—Ç—ã):**
```sql
SELECT 
    COUNT(CASE WHEN type = 'buyout' THEN 1 END) as buyout_count,
    COUNT(CASE WHEN type = 'return' THEN 1 END) as return_count
FROM wb_sales 
WHERE cabinet_id = {cabinet_id} 
  AND nm_id = {nm_id}
  AND is_cancel = False
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
{
    "total_orders": 140,
    "active_orders": 85,
    "canceled_orders": 55,
    "buyout_orders": 32,
    "return_orders": 7
}
```

---

##### **–®–∞–≥ 7: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–æ–≤**
**–°—Ç—Ä–æ–∫–∏:** 344-353

**–ó–∞–ø—Ä–æ—Å:**
```sql
SELECT 
    rating,
    COUNT(id) as count
FROM wb_reviews 
WHERE cabinet_id = {cabinet_id} 
  AND nm_id = {nm_id}
  AND rating IS NOT NULL
GROUP BY rating
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `{5: 290, 4: 30, 3: 10, 2: 5, 1: 16}`

**–†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ (–≤ —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä–µ):**
```python
pct_5 = (290 / 351) * 100 = 84.4%
pct_4 = (30 / 351) * 100 = 5.8%
pct_3 = (10 / 351) * 100 = 3.9%
pct_2 = (5 / 351) * 100 = 1.9%
pct_1 = (16 / 351) * 100 = 3.9%
```

---

##### **–®–∞–≥ 8: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞**
**–°—Ç—Ä–æ–∫–∏:** 346-353

**–ó–∞–ø—Ä–æ—Å:**
```sql
SELECT AVG(rating) FROM wb_reviews 
WHERE cabinet_id = {cabinet_id} 
  AND nm_id = {nm_id}
  AND rating IS NOT NULL
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `avg_rating = 4.63`

---

#### üì¶ **–§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ò–¢–û–ì–û–í–û–ì–û –û–ë–™–ï–ö–¢–ê –î–ê–ù–ù–´–•**

**–°—Ç—Ä–æ–∫–∏:** 360-420

```python
order_data = {
    # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ
    "id": 2207,
    "order_id": "5669701717467158671",  # WB ID
    "nm_id": 225287280,
    "article": "slavabrand_dress_white_belt",
    "size": "M",
    "barcode": "2041472975210",
    "status": "active",
    
    # –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –±—Ä–µ–Ω–¥
    "product_name": "–ü–ª–∞—Ç—å—è",
    "brand": "SLAVABRAND",
    
    # –î–∞—Ç—ã
    "date": "2025-10-23T13:00:00+00:00",
    "order_date": "2025-10-23T13:00:00+00:00",
    
    # –§–∏–Ω–∞–Ω—Å—ã
    "total_price": 8100.0,
    "spp_percent": 23.0,
    "customer_price": 1626.0,
    "discount_percent": 74.0,
    
    # –°–∫–ª–∞–¥—ã
    "warehouse_from": "–ö–∞–∑–∞–Ω—å",
    "warehouse_to": "–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    
    # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    "image_url": "https://basket-xx.wbbasket.ru/.../1.webp",
    
    # –†–µ–π—Ç–∏–Ω–≥ –∏ –æ—Ç–∑—ã–≤—ã
    "rating": 4.7,  # –ò–∑ wb_products
    "avg_rating": 4.63,  # –°—Ä–µ–¥–Ω–∏–π –∏–∑ –æ—Ç–∑—ã–≤–æ–≤
    "reviews_count": 351,
    "rating_distribution": {5: 290, 4: 30, 3: 10, 2: 5, 1: 16},
    
    # –í—ã–∫—É–ø—ã –∑–∞ –ø–µ—Ä–∏–æ–¥—ã
    "sales_periods": {
        "7_days": 19,
        "14_days": 25,
        "30_days": 32
    },
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
    "orders_stats": {
        "total_orders": 140,
        "active_orders": 85,
        "canceled_orders": 55,
        "buyout_orders": 32,
        "return_orders": 7
    },
    
    # –û—Å—Ç–∞—Ç–∫–∏ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º (—Å—É–º–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º)
    "stocks": {
        "L": 91,
        "M": 86,
        "S": 46,
        "XL": 0
    }
}
```

---

### 5Ô∏è‚É£ **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (Bot API Formatter)**

**–§–∞–π–ª:** `server/app/features/bot_api/formatter.py`  
**–§—É–Ω–∫—Ü–∏—è:** `format_order_detail(data: Dict[str, Any])`  
**–°—Ç—Ä–æ–∫–∏:** 458-606

#### –ü—Ä–æ—Ü–µ—Å—Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

**1. –ó–∞–≥–æ–ª–æ–≤–æ–∫:**
```python
# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–∫–∞–∑–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É
status_map = {
    "active": "–ó–∞–∫–∞–∑",
    "buyout": "–í—ã–∫—É–ø", 
    "canceled": "–û—Ç–º–µ–Ω–∞",
    "return": "–í–æ–∑–≤—Ä–∞—Ç"
}

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã: "23.10.2025 13:00"
date_part = "2025-10-23"
time_part = "13:00"
year, month, day = date_part.split('-')
formatted_datetime = f"{day}.{month}.{year} {time_part}"

# –†–µ–∑—É–ª—å—Ç–∞—Ç: "–ó–∞–∫–∞–∑ ID: 2207 –æ—Ç 23.10.2025 13:00"
```

**2. –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ç–æ–≤–∞—Ä–∞:**
```python
# üÜî {nm_id} / {article} / ({size})
# üéπ {barcode}

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# üÜî 225287280 / slavabrand_dress_white_belt / (M)
# üéπ 2041472975210
```

**3. –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ f-string —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —á–∏—Å–µ–ª
total_price = 8100.0
spp_percent = 23.0
customer_price = 1626.0
discount_percent = 74.0

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# –¶–µ–Ω–∞ –∑–∞–∫–∞–∑–∞: 8,100.0‚ÇΩ
# –°–ü–ü %: 23.0%
# –¶–µ–Ω–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: 1,626.0‚ÇΩ
# –°–∫–∏–¥–∫–∞: 74.0%
```

**4. –í—ã–∫—É–ø—ã –∑–∞ –ø–µ—Ä–∏–æ–¥—ã:**
```python
sales_7 = sales_periods.get('7_days', 0)   # 19
sales_14 = sales_periods.get('14_days', 0)  # 25
sales_30 = sales_periods.get('30_days', 0)  # 32

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# üìà –í—ã–∫—É–ø—ã –∑–∞ –ø–µ—Ä–∏–æ–¥—ã:
# 7 | 14 | 30 –¥–Ω–µ–π:
# 19 | 25 | 32
```

**5. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤:**
```python
# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# üîç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º:
# –í—Å–µ–≥–æ: 140 –∑–∞–∫–∞–∑–æ–≤
# –ê–∫—Ç–∏–≤–Ω—ã–µ: 85
# –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ: 55
# –í—ã–∫—É–ø—ã: 32
# –í–æ–∑–≤—Ä–∞—Ç—ã: 7
```

**6. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö):**
```python
stars_5 = 290
pct_5 = (290 / 351) * 100 = 84.4%

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# 5‚≠ê - 84.4%
# 4‚≠ê - 5.8%
# 3‚≠ê - 3.9%
# 2‚≠ê - 1.9%
# 1‚≠ê - 3.9%
```

**7. –û—Å—Ç–∞—Ç–∫–∏ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º:**
```python
# –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º
sorted_stocks = sorted(stocks.keys())

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# üì¶ –û—Å—Ç–∞—Ç–∫–∏ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º:
# L: 91 —à—Ç.
# M: 86 —à—Ç.
# S: 46 —à—Ç.
# XL: 0 —à—Ç.
```

---

### 6Ô∏è‚É£ **–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É**

**–§–∞–π–ª:** `server/app/features/bot_api/service.py`  
**–°—Ç—Ä–æ–∫–∏:** 415-422

```python
return {
    "success": True,
    "data": order_data,
    "telegram_text": formatted_text  # –ì–æ—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
}
```

**HTTP Response:**
```json
{
  "success": true,
  "data": {...},
  "telegram_text": "–ó–∞–∫–∞–∑ ID: 2207 –æ—Ç 23.10.2025 13:00\n\nüÜî 225287280...",
  "order": {
    "id": 2207,
    "nm_id": 225287280,
    "image_url": "https://..."
  }
}
```

---

### 7Ô∏è‚É£ **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ Telegram**

**–§–∞–π–ª:** `bot/handlers/orders.py`  
**–°—Ç—Ä–æ–∫–∏:** 186-207

#### –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:

**–ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:**
```python
await callback.message.answer_photo(
    photo=image_url,
    caption=response.telegram_text,
    reply_markup=keyboard
)
```

**–ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
```python
await callback.message.edit_text(
    response.telegram_text,
    reply_markup=keyboard
)
```

**–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞:**
```python
InlineKeyboardMarkup(inline_keyboard=[
    [InlineKeyboardButton(
        text="üîô –ö —Å–ø–∏—Å–∫—É –∑–∞–∫–∞–∑–æ–≤",
        callback_data="orders"
    )]
])
```

---

## üóÑÔ∏è –°–•–ï–ú–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•

### –°–≤—è–∑–∏ —Ç–∞–±–ª–∏—Ü:

```
users (telegram_id)
  ‚Üì
cabinet_users (user_id, cabinet_id)
  ‚Üì
wb_cabinets (id, api_key)
  ‚Üì
  ‚îú‚îÄ‚Üí wb_orders (cabinet_id, nm_id)
  ‚îú‚îÄ‚Üí wb_products (cabinet_id, nm_id)
  ‚îú‚îÄ‚Üí wb_stocks (cabinet_id, nm_id)
  ‚îú‚îÄ‚Üí wb_reviews (cabinet_id, nm_id)
  ‚îî‚îÄ‚Üí wb_sales (cabinet_id, nm_id)
```

### –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

**wb_orders:**
- `idx_order_id` –Ω–∞ `order_id`
- `idx_nm_id` –Ω–∞ `nm_id`
- `idx_order_date` –Ω–∞ `order_date`
- `idx_order_status` –Ω–∞ `status`
- `uq_cabinet_order_id` –Ω–∞ `(cabinet_id, order_id)` - UNIQUE

**wb_sales:**
- `idx_sales_nm_id` –Ω–∞ `nm_id`
- `idx_sales_date` –Ω–∞ `sale_date`
- `idx_sales_type` –Ω–∞ `type`
- `idx_sales_is_cancel` –Ω–∞ `is_cancel`
- `uq_cabinet_sale_id` –Ω–∞ `(cabinet_id, sale_id)` - UNIQUE

**wb_stocks:**
- `idx_stocks_nm_id` –Ω–∞ `nm_id`

**wb_reviews:**
- `idx_reviews_nm_id` –Ω–∞ `nm_id`

---

## ‚ö° –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞:

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - 1 –∑–∞–ø—Ä–æ—Å
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤—è–∑–∏ user-cabinet** - 1 –∑–∞–ø—Ä–æ—Å
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞** - 1 –∑–∞–ø—Ä–æ—Å
4. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞** - 1 –∑–∞–ø—Ä–æ—Å
5. **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤** - 1 –∑–∞–ø—Ä–æ—Å
6. **–ü–æ–¥—Å—á–µ—Ç –æ—Ç–∑—ã–≤–æ–≤** - 1 –∑–∞–ø—Ä–æ—Å
7. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤** - 1 –∑–∞–ø—Ä–æ—Å
8. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂** - 1 –∑–∞–ø—Ä–æ—Å
9. **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤** - 1 –∑–∞–ø—Ä–æ—Å
10. **–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥** - 1 –∑–∞–ø—Ä–æ—Å
11. **–í—ã–∫—É–ø—ã –∑–∞ 3 –ø–µ—Ä–∏–æ–¥–∞** - 3 –∑–∞–ø—Ä–æ—Å–∞

**–ò–¢–û–ì–û: ~13 SQL –∑–∞–ø—Ä–æ—Å–æ–≤**

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ –≤—Å–µ—Ö –ø–æ–ª—è—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL (GROUP BY)
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ (COUNT, AVG)

---

## üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:

1. **Telegram ID ‚Üí User ID** (—Ç–∞–±–ª–∏—Ü–∞ `users`)
2. **User ID ‚Üí Cabinet ID** (—Ç–∞–±–ª–∏—Ü–∞ `cabinet_users`)
3. **Order.cabinet_id == Cabinet.id** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–º

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–∫–∞–∑—ã —Å–≤–æ–∏—Ö –∫–∞–±–∏–Ω–µ—Ç–æ–≤!**

---

## üöÄ –ú–ê–°–®–¢–ê–ë–ò–†–£–ï–ú–û–°–¢–¨

### –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–π –±–∞–∑–µ SQLite
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
- –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Redis)
2. **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤** (JOIN –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö SELECT)
3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** (SQLAlchemy async)
4. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è** –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö

---

## üìù –ö–õ–Æ–ß–ï–í–´–ï –§–ê–ô–õ–´

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –°—Ç—Ä–æ–∫–∏ |
|------|-----------|--------|
| `bot/handlers/orders.py` | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ | 151-215 |
| `bot/api/client.py` | HTTP –∫–ª–∏–µ–Ω—Ç | 351-354 |
| `server/app/features/bot_api/routes.py` | API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã | - |
| `server/app/features/bot_api/service.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ | 247-429 |
| `server/app/features/bot_api/formatter.py` | –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π | 458-606 |
| `server/app/features/wb_api/models.py` | –ú–æ–¥–µ–ª–∏ –ë–î (–∑–∞–∫–∞–∑—ã) | 74-125 |
| `server/app/features/wb_api/models_sales.py` | –ú–æ–¥–µ–ª–∏ –ë–î (–ø—Ä–æ–¥–∞–∂–∏) | 9-48 |

---

## üêõ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

### –ö–ª—é—á–µ–≤—ã–µ –ª–æ–≥–∏:

**Bot:**
```python
logger.info(f"üì¢ Order detail response: {response}")
logger.info(f"üì¢ Order data: {order}")
logger.info(f"üì¢ Order image_url: {image_url}")
```

**Server:**
```python
logger.info(f"Order data for order {order_id}")
logger.info(f"Order data keys: {list(order_data.keys())}")
logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞: {e}")
```

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –ü–û–¢–û–ö –î–ê–ù–ù–´–•

```
Telegram Bot (User clicks order)
  ‚Üì callback: "order_details_2207"
  
Bot Handler (orders.py)
  ‚Üì GET /api/v1/bot/orders/2207?telegram_id=5101525651
  
Server API (routes.py)
  ‚Üì BotAPIService.get_order_detail()
  
Database Queries:
  ‚îú‚îÄ wb_orders (–æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–∫–∞–∑)
  ‚îú‚îÄ wb_products (—Ä–µ–π—Ç–∏–Ω–≥, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
  ‚îú‚îÄ wb_stocks (–æ—Å—Ç–∞—Ç–∫–∏)
  ‚îú‚îÄ wb_reviews (–æ—Ç–∑—ã–≤—ã, —Ä–µ–π—Ç–∏–Ω–≥–∏)
  ‚îî‚îÄ wb_sales (–≤—ã–∫—É–ø—ã, –≤–æ–∑–≤—Ä–∞—Ç—ã)
  
Formatter (formatter.py)
  ‚Üì format_order_detail()
  
Server Response (JSON)
  ‚Üì {success, data, telegram_text, order}
  
Bot Client (client.py)
  ‚Üì BotAPIResponse
  
Telegram Message
  ‚Üì Photo + Caption OR Text + Keyboard
  
User sees formatted order details
```

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23.10.2025  
**–ê–≤—Ç–æ—Ä:** WB Assist Development Team  
**–í–µ—Ä—Å–∏—è:** 1.0
