# üìã –°–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É **–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏** —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ —Ç–æ–ª—å–∫–æ –æ **–Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö**, –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–∏—Ö —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### **1. –ü–µ—Ä–≤–∏—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (First Sync)**

**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç WB API –∫–ª—é—á –≤–ø–µ—Ä–≤—ã–µ

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ WB API
2. **–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–∞** - `WBCabinet` —Å `last_sync_at = NULL`
3. **–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö** –∑–∞ –ø–µ—Ä–∏–æ–¥ `SYNC_DAYS` –¥–Ω–µ–π
4. **–§–ª–∞–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** `should_notify = False` (–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
5. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î** –∫–∞–∫ "–±–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è" –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** `cabinet.last_sync_at = now()`
7. **–û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é

### **2. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (Incremental Sync)**

**–¢—Ä–∏–≥–≥–µ—Ä:** Celery Beat –∫–∞–∂–¥—ã–µ `SYNC_INTERVAL` —Å–µ–∫—É–Ω–¥

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** `cabinet.last_sync_at` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ < 24 —á–∞—Å–æ–≤
2. **–§–ª–∞–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** `should_notify = True`
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** —Å WB API —Å –º–æ–º–µ–Ω—Ç–∞ `last_sync_at`
4. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ** —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≤ –ë–î
5. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π** –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** `cabinet.last_sync_at = now()`

---

## üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π

### **–ö—Ä–∏—Ç–µ—Ä–∏–π "–Ω–æ–≤–∏–∑–Ω—ã":**
–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **`created_at`** (–≤—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ë–î), –∞ –ù–ï `order_date` –∏–∑ WB API

**–õ–æ–≥–∏–∫–∞:**
- `created_at` - –≤—Ä–µ–º—è –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –ø–æ—è–≤–∏–ª–∞—Å—å –≤ –Ω–∞—à–µ–π –ë–î
- `order_date` - –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ WB (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–∞—Ä—ã–º)
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `created_at` —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å –∏–º–µ–Ω–Ω–æ **–Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î**

---

## üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–æ–≤

### **–ú–µ—Ö–∞–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
–ó–∞–∫–∞–∑ #12345: new ‚Üí buyout ‚Üí return
```

**–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
1. **new_order** - –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
2. **order_buyout** - –ø—Ä–∏ –≤—ã–∫—É–ø–µ (—Ç–æ—Ç –∂–µ order_id)
3. **order_return** - –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ (—Ç–æ—Ç –∂–µ order_id)

### **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤:**

**1. –ß–µ—Ä–µ–∑ Redis (StatusChangeMonitor):**
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç: `{order_id: status}` –≤ Redis
- TTL: 1 —á–∞—Å

**2. –ß–µ—Ä–µ–∑ –ë–î (OrderStatusHistory):**
- –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –û—Ç–º–µ—Ç–∫–∞ `notification_sent` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

**3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π:**
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏ —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
- –°–æ–∑–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏

---

## üè™ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ - –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Å–∫–ª–∞–¥–∞–º

### **–ü—Ä–æ–±–ª–µ–º–∞ –º–µ–∂—Å–∫–ª–∞–¥—Å–∫–∏—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤:**
```
–°–∫–ª–∞–¥ A: 100 ‚Üí 0 (–ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Å–∫–ª–∞–¥ B)
–°–∫–ª–∞–¥ B: 0 ‚Üí 100 (–ø–æ–ª—É—á–µ–Ω–∏–µ —Å —Å–∫–ª–∞–¥–∞ A)
–û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: 100 (–Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è)
```

### **–†–µ—à–µ–Ω–∏–µ - –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º:**
- –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ `nm_id` + `size`
- –°—É–º–º–∏—Ä—É–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º
- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ (–Ω–µ –º–µ–∂—Å–∫–ª–∞–¥—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º —É–º–µ–Ω—å—à–µ–Ω–∏–∏

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### **–ê—Ç–æ–º–∞—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã:**

**1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ Redis:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `sent_notifications:{user_id}:{type}` Set
- TTL: 24 —á–∞—Å–∞

**2. –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ë–î
- –û—Ç–ø—Ä–∞–≤–∫–∞ webhook
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `NotificationHistory`
- –û—Ç–º–µ—Ç–∫–∞ –≤ Redis

**3. –ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ë–∞—Ç—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å Redis
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üìù –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### **1. –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã (new_order)**
- **–¢—Ä–∏–≥–≥–µ—Ä:** `WBOrder.created_at > last_check`
- **–§–æ—Ä–º–∞—Ç:** –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ

### **2. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–æ–≤**
- **order_buyout** - –∑–∞–∫–∞–∑ –≤—ã–∫—É–ø–ª–µ–Ω
- **order_cancellation** - –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω  
- **order_return** - –∑–∞–∫–∞–∑ –≤–æ–∑–≤—Ä–∞—â–µ–Ω
- **–¢—Ä–∏–≥–≥–µ—Ä:** –ò–∑–º–µ–Ω–µ–Ω–∏–µ `status` –≤ `WBOrder`

### **3. –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–∑—ã–≤—ã (negative_review)**
- **–¢—Ä–∏–≥–≥–µ—Ä:** `WBReview.rating <= 3` –ò `WBReview.created_date > last_check`
- **–§–æ—Ä–º–∞—Ç:** –†–µ–π—Ç–∏–Ω–≥ + —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞

### **4. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ (critical_stocks)**
- **–¢—Ä–∏–≥–≥–µ—Ä:** –°—É–º–º–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º –ø–µ—Ä–µ—à–ª–∞ –ø–æ—Ä–æ–≥ (‚â§ 2)
- **–ê–≥—Ä–µ–≥–∞—Ü–∏—è:** –ü–æ `nm_id` + `size`

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
- `notifications_enabled` - –æ–±—â–µ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ
- `new_orders_enabled` - –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã
- `order_buyouts_enabled` - –≤—ã–∫—É–ø—ã
- `order_cancellations_enabled` - –æ—Ç–º–µ–Ω—ã
- `order_returns_enabled` - –≤–æ–∑–≤—Ä–∞—Ç—ã
- `negative_reviews_enabled` - –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–∑—ã–≤—ã
- `critical_stocks_enabled` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏

---

## üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π

### **–°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–ø—É—Å–∫–∞:**
```
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 1: 10:00 (—É—Å–ø–µ—à–Ω–æ)
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 2: 10:05 (–ø—Ä–æ–ø—É—â–µ–Ω–∞ - –æ—à–∏–±–∫–∞)
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 3: 10:10 (–ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ 10:00-10:10)
```

### **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ **2 –æ–∫–Ω–∞** —Å—Ä–∞–∑—É
- –≠—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è

### **–ó–∞—â–∏—Ç–∞ –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π:**
- –ü—Ä–∏ –ø–µ—Ä–µ—Ä—ã–≤–µ > 24 —á–∞—Å–æ–≤ –æ—Ç–∫–ª—é—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π

---

## üìä –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### **–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —á–µ—Ä–µ–∑ BotMessageFormatter:**
- –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
- –î–ª—è –∑–∞–∫–∞–∑–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ Markdown

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
```python
{
    "type": "new_order",
    "user_id": 123,
    "data": {
        "order_id": "12345",
        "product_name": "–¢–æ–≤–∞—Ä",
        "amount": 1500,
        "image_url": "https://...",
        # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
    },
    "telegram_text": "üßæ –ù–û–í–´–ô –ó–ê–ö–ê–ó [#12345]...",
    "created_at": "2024-01-28T10:00:00",
    "priority": "MEDIUM"
}
```

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
- –°—á–µ—Ç—á–∏–∫–∏ –ø–æ–ø—ã—Ç–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã

### **–ú–µ—Ç—Ä–∏–∫–∏:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞—Ç—á–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
