# üìã –°–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### **–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É **–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏** —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ —Ç–æ–ª—å–∫–æ –æ **–Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö**, –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–∏—Ö —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### **1. –ü–µ—Ä–≤–∏—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (First Sync)**

**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç WB API –∫–ª—é—á –≤–ø–µ—Ä–≤—ã–µ

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞** - –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ WB API
2. **–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–∞** - `WBCabinet` —Å `last_sync_at = NULL`
3. **–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö** –∑–∞ –ø–µ—Ä–∏–æ–¥ `SYNC_DAYS` –¥–Ω–µ–π
4. **–§–ª–∞–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** `should_notify = False` (–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
5. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î** –∫–∞–∫ "–±–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è" –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** `cabinet.last_sync_at = now()`
7. **–û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é

**–ö–æ–¥:**
```python
# server/app/features/wb_api/sync_service.py:1466-1488
async def _should_send_notification(self, cabinet: WBCabinet) -> bool:
    if not cabinet.last_sync_at:  # –ü–µ—Ä–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        return False
    # ... –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
```

### **2. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (Incremental Sync)**

**–¢—Ä–∏–≥–≥–µ—Ä:** Celery Beat –∫–∞–∂–¥—ã–µ `SYNC_INTERVAL` —Å–µ–∫—É–Ω–¥

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** `cabinet.last_sync_at` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ < 24 —á–∞—Å–æ–≤
2. **–§–ª–∞–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** `should_notify = True`
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** —Å WB API —Å –º–æ–º–µ–Ω—Ç–∞ `last_sync_at`
4. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ** —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≤ –ë–î
5. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π** –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** `cabinet.last_sync_at = now()`

---

## üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π

### **–ö—Ä–∏—Ç–µ—Ä–∏–π "–Ω–æ–≤–∏–∑–Ω—ã":**
–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **`created_at`** (–≤—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ë–î), –∞ –ù–ï `order_date` –∏–∑ WB API

**–ö–æ–¥:**
```python
# server/app/features/notifications/notification_service.py:834
orders = self.db.query(WBOrder).filter(
    WBOrder.created_at > last_check,  # ‚Üê –ö–õ–Æ–ß–ï–í–û–ï –ü–û–õ–ï!
    ~WBOrder.order_id.in_(sent_order_ids)  # –ò—Å–∫–ª—é—á–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
).all()
```

**–õ–æ–≥–∏–∫–∞:**
- `created_at` - –≤—Ä–µ–º—è –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –ø–æ—è–≤–∏–ª–∞—Å—å –≤ –Ω–∞—à–µ–π –ë–î
- `order_date` - –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ WB (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–∞—Ä—ã–º)
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `created_at` —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å –∏–º–µ–Ω–Ω–æ **–Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î**

---

## üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–æ–≤

### **–ú–µ—Ö–∞–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
–ó–∞–∫–∞–∑ #12345: new ‚Üí buyout ‚Üí return
```

**–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
1. **new_order** - –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
2. **order_buyout** - –ø—Ä–∏ –≤—ã–∫—É–ø–µ (—Ç–æ—Ç –∂–µ order_id)
3. **order_return** - –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ (—Ç–æ—Ç –∂–µ order_id)

### **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤:**

**1. –ß–µ—Ä–µ–∑ Redis (StatusChangeMonitor):**
```python
# server/app/features/notifications/status_monitor.py:33-47
def get_previous_state(self, user_id: int, redis_client) -> Dict[str, str]:
    state_data = redis_client.get(f"notifications:order_status:{user_id}")
    # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç: {order_id: status}
```

**2. –ß–µ—Ä–µ–∑ –ë–î (OrderStatusHistory):**
```python
# server/app/features/notifications/models.py:60-75
class OrderStatusHistory(Base):
    order_id = Column(Integer, nullable=False, index=True)
    previous_status = Column(String(50), nullable=True)
    current_status = Column(String(50), nullable=False)
    notification_sent = Column(Boolean, default=False)
```

**3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π:**
```python
# server/app/features/notifications/status_monitor.py:66-96
def compare_order_states(self, previous_state, current_orders):
    for order in current_orders:
        previous_status = previous_state.get(order_id)
        current_status = order.get("status")
        
        if previous_status != current_status:
            # –°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
```

---

## üè™ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ - –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Å–∫–ª–∞–¥–∞–º

### **–ü—Ä–æ–±–ª–µ–º–∞ –º–µ–∂—Å–∫–ª–∞–¥—Å–∫–∏—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤:**
```
–°–∫–ª–∞–¥ A: 100 ‚Üí 0 (–ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Å–∫–ª–∞–¥ B)
–°–∫–ª–∞–¥ B: 0 ‚Üí 100 (–ø–æ–ª—É—á–µ–Ω–∏–µ —Å —Å–∫–ª–∞–¥–∞ A)
–û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: 100 (–Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è)
```

### **–†–µ—à–µ–Ω–∏–µ - –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º:**
```python
# server/app/features/notifications/notification_service.py:1043-1070
def group_stocks_by_product(stocks):
    grouped = {}
    for stock in stocks:
        key = (stock.nm_id, stock.size or "")  # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–æ–≤–∞—Ä—É+—Ä–∞–∑–º–µ—Ä
        grouped[key] = stock.quantity

# –°—É–º–º–∏—Ä—É–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º
current_total = sum(stock.quantity for stock in current_stock_list)
previous_total = sum(stock.quantity for stock in prev_stock_list)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ
if (previous_total > threshold and 
    current_total <= threshold and 
    current_total < previous_total):
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞:**

**–£—Ä–æ–≤–µ–Ω—å 1: NotificationHistory (–æ—Å–Ω–æ–≤–Ω–∞—è)**
```python
# server/app/features/notifications/notification_service.py:1201-1269
def _save_notification_to_history(self, user_id, notification, result):
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
    notification_id = f"notif_{type}_{unique_key}_{timestamp}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
    existing = self.db.query(NotificationHistory).filter(
        NotificationHistory.id == notification_id
    ).first()
```

**–£—Ä–æ–≤–µ–Ω—å 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö**
```python
# server/app/features/notifications/notification_service.py:810-827
sent_notifications = self.db.query(NotificationHistory).filter(
    NotificationHistory.user_id == user_id,
    NotificationHistory.notification_type == "new_order",
    NotificationHistory.sent_at > last_check - timedelta(hours=24)
).all()

# –ò–∑–≤–ª–µ–∫–∞–µ–º order_id –∏–∑ JSON content
sent_order_ids = set()
for n in sent_notifications:
    content_data = json.loads(n.content)
    sent_order_ids.add(content_data["order_id"])
```

**–£—Ä–æ–≤–µ–Ω—å 3: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤**
```python
# server/app/features/notifications/notification_service.py:834-836
orders = self.db.query(WBOrder).filter(
    ~WBOrder.order_id.in_(sent_order_ids)  # –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ
).all()
```

---

## üìù –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞

### **1. –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã (new_order)**
- **–¢—Ä–∏–≥–≥–µ—Ä:** `WBOrder.created_at > last_check`
- **–§–∏–ª—å—Ç—Ä:** –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ `order_id`
- **–§–æ—Ä–º–∞—Ç:** –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ

### **2. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–æ–≤**
- **order_buyout** - –∑–∞–∫–∞–∑ –≤—ã–∫—É–ø–ª–µ–Ω
- **order_cancellation** - –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω  
- **order_return** - –∑–∞–∫–∞–∑ –≤–æ–∑–≤—Ä–∞—â–µ–Ω
- **–¢—Ä–∏–≥–≥–µ—Ä:** –ò–∑–º–µ–Ω–µ–Ω–∏–µ `status` –≤ `WBOrder`
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ:** –ß–µ—Ä–µ–∑ `StatusChangeMonitor` (Redis) + `OrderStatusHistory` (–ë–î)

### **3. –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–∑—ã–≤—ã (negative_review)**
- **–¢—Ä–∏–≥–≥–µ—Ä:** `WBReview.rating <= 3` –ò `WBReview.created_date > last_check`
- **–§–∏–ª—å—Ç—Ä:** –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –æ—Ç–∑—ã–≤—ã (–Ω–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ)
- **–§–æ—Ä–º–∞—Ç:** –†–µ–π—Ç–∏–Ω–≥ + —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞

### **4. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ (critical_stocks)**
- **–¢—Ä–∏–≥–≥–µ—Ä:** –°—É–º–º–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º –ø–µ—Ä–µ—à–ª–∞ –ø–æ—Ä–æ–≥ (‚â§ 2)
- **–§–∏–ª—å—Ç—Ä:** –†–µ–∞–ª—å–Ω–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ (–Ω–µ –º–µ–∂—Å–∫–ª–∞–¥—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã)
- **–ê–≥—Ä–µ–≥–∞—Ü–∏—è:** –ü–æ `nm_id` + `size`

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```python
# server/app/features/notifications/models.py:10-35
class NotificationSettings(Base):
    notifications_enabled = Column(Boolean, default=True)
    new_orders_enabled = Column(Boolean, default=True)
    order_buyouts_enabled = Column(Boolean, default=True)
    order_cancellations_enabled = Column(Boolean, default=True)
    order_returns_enabled = Column(Boolean, default=True)
    negative_reviews_enabled = Column(Boolean, default=True)
    critical_stocks_enabled = Column(Boolean, default=True)
```

### **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
```python
# server/app/features/notifications/notification_service.py:100-103
if not user_settings.notifications_enabled:
    return {"status": "disabled", "notifications_sent": 0}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞
if user_settings.new_orders_enabled:
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã
```

---

## üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π

### **–°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–ø—É—Å–∫–∞:**
```
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 1: 10:00 (—É—Å–ø–µ—à–Ω–æ)
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 2: 10:05 (–ø—Ä–æ–ø—É—â–µ–Ω–∞ - –æ—à–∏–±–∫–∞)
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 3: 10:10 (–ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ 10:00-10:10)
```

### **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ **2 –æ–∫–Ω–∞** —Å—Ä–∞–∑—É
- –≠—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è

### **–ó–∞—â–∏—Ç–∞ –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π:**
```python
# server/app/features/wb_api/sync_service.py:1479-1480
if time_diff > timedelta(hours=24):
    return False  # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –¥–æ–ª–≥–æ–º –ø–µ—Ä–µ—Ä—ã–≤–µ
```

---

## üìä –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### **–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —á–µ—Ä–µ–∑ BotMessageFormatter:**
```python
# server/app/features/notifications/notification_service.py:144
telegram_text = self._format_notification_for_telegram(clean_event)

# –î–ª—è –∑–∞–∫–∞–∑–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
if notification_type in ["new_order", "order_buyout", "order_cancellation", "order_return"]:
    order_data = self._convert_notification_to_order_format(notification)
    return self.message_formatter.format_order_detail({"order": order_data})
```

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
```python
{
    "type": "new_order",
    "user_id": 123,
    "data": {
        "order_id": "12345",
        "product_name": "–¢–æ–≤–∞—Ä",
        "amount": 1500,
        "image_url": "https://...",
        # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
    },
    "telegram_text": "üßæ –ù–û–í–´–ô –ó–ê–ö–ê–ó [#12345]...",
    "created_at": "2024-01-28T10:00:00",
    "priority": "MEDIUM"
}
```

---

## üö® –ü—Ä–æ–±–ª–µ–º—ã —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—Ç–µ–∫—É—â–∏–µ)

### **1. Race Conditions**
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
**–†–µ—à–µ–Ω–∏–µ:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ `_get_sync_lock()`

### **2. –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞—â–∏—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ 24 —á–∞—Å–∞
**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏ –¥–æ–ª–≥–æ–º –ø–µ—Ä–µ—Ä—ã–≤–µ –æ—Ç–∫–ª—é—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### **3. –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ ID –∏–∑ `NotificationHistory.content`
**–†–∏—Å–∫:** –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –º–æ–≥—É—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã

### **4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `NotificationHistory`
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### **1. –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis Set –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
- –ï–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### **2. –£–ª—É—á—à–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤**
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É —á–µ—Ä–µ–∑ `StatusChangeMonitor`
- –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É Redis –∏ –ë–î

### **3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ë–∞—Ç—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ë–î

### **4. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- –ú–µ—Ç—Ä–∏–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

---

## üìà –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–∏—Å—Ç–µ–º—ã

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** 7/10
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ `created_at`
- ‚úÖ –£–º–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º
- ‚úÖ –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ race conditions
- ‚ùå –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö

**–ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:** 9/10
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ù–∞–¥–µ–∂–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç race conditions
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏
