# RAG Fixes - 2025-12-16

## üêõ –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

### 1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç similarity**
**–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä `<#>` (cosine distance) —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ–æ—Ä–º—É–ª–æ–π, —á—Ç–æ –¥–∞–≤–∞–ª–æ –∑–Ω–∞—á–µ–Ω–∏—è > 1.0
```
Similarity range: 1.2662 - 1.2691 ‚ùå (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0-1)
```

**–†–µ—à–µ–Ω–∏–µ**: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ inner product `<=>` –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ (OpenAI embeddings)
- –§–æ—Ä–º—É–ª–∞: `similarity = (embedding <=> query) * -1`
- –î–∏–∞–ø–∞–∑–æ–Ω: [0, 1] –≥–¥–µ 1 = –∏–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: ASC –ø–æ distance (–æ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–º—É)

**–§–∞–π–ª**: `gpt_integration/ai_chat/RAG/vector_search.py` (—Å—Ç—Ä–æ–∫–∏ 147-194)

---

### 2. **–ß–∞–Ω–∫–∏ stocks –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤**
**–ü—Ä–æ–±–ª–µ–º–∞**: –ó–∞–ø—Ä–æ—Å "–ö–∞–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å?" –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª stocks
```
Chunk types found: review, sale ‚ùå (–Ω—É–∂–Ω–æ: stock)
```

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:
- `quantity == 0`: "–Ω—É–ª–µ–≤–æ–π –æ—Å—Ç–∞—Ç–æ–∫", "–°–†–û–ß–ù–û –ø–æ–ø–æ–ª–Ω–∏—Ç—å", "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫"
- `quantity <= 5`: "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫", "–æ—á–µ–Ω—å –º–∞–ª–æ", "—Å—Ä–æ—á–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å"
- `quantity <= 10`: "–Ω–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫", "–º–∞–ª–æ —Ç–æ–≤–∞—Ä–∞", "–Ω—É–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å"
- `quantity <= 20`: "–Ω–µ–≤—ã—Å–æ–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫", "—Å—Ç–æ–∏—Ç –ø–æ–ø–æ–ª–Ω–∏—Ç—å"
- `quantity > 20`: "–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫", "–∑–∞–ø–∞—Å –≤ –Ω–æ—Ä–º–µ"

**–§–∞–π–ª**: `gpt_integration/ai_chat/RAG/indexer.py` (—Å—Ç—Ä–æ–∫–∏ 232-268)

---

### 3. **Threshold –±—ã–ª —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–º**
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Ä–æ–≥ 0.5 –¥–ª—è —Å—Ç–∞—Ä–æ–π –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏–ª –¥–ª—è –Ω–æ–≤–æ–π

**–†–µ—à–µ–Ω–∏–µ**: –°–Ω–∏–∂–µ–Ω –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π threshold —Å `0.5` –¥–æ `0.3`
- 0.7-1.0 = –≤—ã—Å–æ–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
- 0.4-0.7 = —Å—Ä–µ–¥–Ω—è—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
- 0.0-0.4 = –Ω–∏–∑–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å

**–§–∞–π–ª**: `gpt_integration/ai_chat/RAG/vector_search.py` (—Å—Ç—Ä–æ–∫–∏ 66-73)
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `docs/RAG/RAG_INDEXING_SETUP.md` (—Å—Ç—Ä–æ–∫–∏ 61-65)

---

### 4. **–£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
**–î–æ–±–∞–≤–ª–µ–Ω–æ**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞ —Å:
- similarity score
- inner product –∑–Ω–∞—á–µ–Ω–∏–µ–º
- distance
- —Å—Ç–∞—Ç—É—Å–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (PASSED/FILTERED)

**–§–∞–π–ª**: `gpt_integration/ai_chat/RAG/vector_search.py` (—Å—Ç—Ä–æ–∫–∏ 222-245)

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

### **–®–∞–≥ 1: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ AI-—Å–µ—Ä–≤–∏—Å–∞ (GPT)**
```bash
docker-compose restart gpt
```

### **–®–∞–≥ 2: –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
–ü–æ—Å–∫–æ–ª—å–∫—É —Ñ–æ—Ä–º–∞—Ç —á–∞–Ω–∫–æ–≤ stocks –∏–∑–º–µ–Ω–∏–ª—Å—è, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å:

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ API** (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è cabinet_id=1):
```bash
curl -X POST \
  http://localhost:9000/v1/rag/index/1 \
  -H "X-API-KEY: your_api_key_here"
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ Python** (–¥–ª—è –≤—Å–µ—Ö –∫–∞–±–∏–Ω–µ—Ç–æ–≤):
```bash
docker-compose exec server python -c "
from app.features.rag.tasks import index_all_cabinets_rag
result = index_all_cabinets_rag.delay()
print('Task ID:', result.id)
"
```

**–í–∞—Ä–∏–∞–Ω—Ç C: –°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏**:
```bash
# –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–ª—è cabinet_id=1
docker-compose exec gpt python -m gpt_integration.ai_chat.RAG.reset_index_status 1

# –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤)
# –ò–ª–∏ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –í–∞—Ä–∏–∞–Ω—Ç A –∏–ª–∏ B
```

### **–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤**
–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ AI-—Å–µ—Ä–≤–∏—Å–∞ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤—ã–µ similarity scores:
```bash
docker-compose logs -f gpt | grep "similarity="
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç:
```
‚úÖ similarity=0.7234 (inner_product=0.7234), distance=-0.7234
‚úÖ PASSED threshold (0.7234 >= 0.3)
```

### **–®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å:
```
–ö–∞–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å?
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- Chunk types: **stock** (–≤–º–µ—Å—Ç–æ review, sale)
- Similarity: **0.3 - 1.0** (–≤–º–µ—Å—Ç–æ > 1.0)
- –û—Ç–≤–µ—Ç –±–æ—Ç–∞: **—Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏**

---

## üìä –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` (–µ—Å–ª–∏ –Ω–µ—Ç):
```bash
# RAG Configuration - –ü–æ–∏—Å–∫
RAG_SIMILARITY_THRESHOLD=0.3  # –ë—ã–ª–æ: 0.5
```

---

## ‚úÖ Checklist –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

- [ ] AI-—Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ similarity (0-1)
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å "–ö–∞–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å?" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç stocks
- [ ] –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ –≤–º–µ—Å—Ç–æ "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

---

**–î–∞—Ç–∞**: 2025-12-16
**–í–µ—Ä—Å–∏—è**: RAG v1.1.0
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
