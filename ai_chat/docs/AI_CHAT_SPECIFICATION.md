# AI Chat Service - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ

## üìã –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

**AI Chat Service** ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π FastAPI-—Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –ø–æ —Ç–µ–º–µ Wildberries –∏ e-commerce. –°–µ—Ä–≤–∏—Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –±—ç–∫–µ–Ω–¥–æ–º, Telegram –±–æ—Ç–æ–º –∏ –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤.

### –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—â–∞—Ç—å—Å—è —Å AI –ø–æ —Ç–µ–º–∞–º:
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –Ω–∞ Wildberries
- –†–∞–±–æ—Ç–∞ —Å –∑–∞–∫–∞–∑–∞–º–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏
- –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
- –û—Ç–∑—ã–≤—ã –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏
- –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∏ —Å–∫–ª–∞–¥—ã WB
- –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ e-commerce

### –ö–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- ‚ö° –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤: **30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å—É—Ç–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
- üíæ –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- üéØ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–µ–º–∞—Ç–∏–∫–∏ (—Ç–æ–ª—å–∫–æ WB –∏ e-commerce)
- üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram –±–æ—Ç–æ–º —á–µ—Ä–µ–∑ REST API
- üê≥ –û—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –≤ Docker (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `gpt_integration`)
- üîí –ó–∞—â–∏—Ç–∞ –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ API –∫–ª—é—á–æ–º
- üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Main Server   ‚îÇ    ‚îÇ   Telegram Bot  ‚îÇ    ‚îÇ  GPT Analysis   ‚îÇ    ‚îÇ   AI Chat       ‚îÇ
‚îÇ   (port 8000)   ‚îÇ    ‚îÇ   (port 8001)   ‚îÇ    ‚îÇ   (port 9000)   ‚îÇ    ‚îÇ   (port 9001)   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ PostgreSQL    ‚îÇ    ‚îÇ ‚Ä¢ User Commands ‚îÇ    ‚îÇ ‚Ä¢ Data Analysis ‚îÇ    ‚îÇ ‚Ä¢ Chat History  ‚îÇ
‚îÇ ‚Ä¢ WB API        ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚î§ ‚Ä¢ Notifications ‚îÇ    ‚îÇ ‚Ä¢ Reports       ‚îÇ    ‚îÇ ‚Ä¢ Rate Limits   ‚îÇ
‚îÇ ‚Ä¢ Bot API       ‚îÇ    ‚îÇ ‚Ä¢ Webhooks      ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ ‚Ä¢ Async Tasks   ‚îÇ    ‚îÇ ‚Ä¢ Context AI    ‚îÇ
‚îÇ ‚Ä¢ User Data     ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ ‚Ä¢ PostgreSQL    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ                                              ‚ñ≤
                                ‚îÇ                                              ‚îÇ
                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                         POST /v1/chat/send
```

### –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ** —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
2. **–ë–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç** `POST /v1/chat/send` —Å `telegram_id` –∏ `message`
3. **AI Chat –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã** –≤ —Ç–∞–±–ª–∏—Ü–µ `ai_chat_daily_limits`
4. **–ï—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω** ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 429 (Too Many Requests)
5. **–ï—Å–ª–∏ –ª–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω**:
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ç–µ–º–∞—Ç–∏–∫–∏
   - –ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ OpenAI API
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç –≤ `ai_chat_requests`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –≤ `ai_chat_daily_limits`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –±–æ—Ç—É
6. **–ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

#### –¢–∞–±–ª–∏—Ü–∞ 1: `ai_chat_requests`
–•—Ä–∞–Ω–∏—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å AI.

```sql
CREATE TABLE ai_chat_requests (
    id SERIAL PRIMARY KEY,
    telegram_id BIGINT NOT NULL,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    message TEXT NOT NULL,
    response TEXT NOT NULL,
    tokens_used INTEGER DEFAULT 0,
    request_date DATE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    INDEX idx_telegram_id (telegram_id),
    INDEX idx_user_id (user_id),
    INDEX idx_request_date (request_date),
    INDEX idx_created_at (created_at)
);
```

**–ü–æ–ª—è:**
- `id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
- `telegram_id` ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `user_id` ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ users (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL)
- `message` ‚Äî —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `response` ‚Äî –æ—Ç–≤–µ—Ç AI
- `tokens_used` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
- `request_date` ‚Äî –¥–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ (–¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–Ω—è–º)
- `created_at` ‚Äî —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞

#### –¢–∞–±–ª–∏—Ü–∞ 2: `ai_chat_daily_limits`
–•—Ä–∞–Ω–∏—Ç —Å—á–µ—Ç—á–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤.

```sql
CREATE TABLE ai_chat_daily_limits (
    id SERIAL PRIMARY KEY,
    telegram_id BIGINT NOT NULL UNIQUE,
    request_count INTEGER DEFAULT 0 NOT NULL,
    last_reset_date DATE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE,
    
    -- –ò–Ω–¥–µ–∫—Å—ã
    INDEX idx_telegram_id (telegram_id),
    INDEX idx_last_reset (last_reset_date)
);
```

**–ü–æ–ª—è:**
- `id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `telegram_id` ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `request_count` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
- `last_reset_date` ‚Äî –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–∞
- `created_at` ‚Äî –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
- `updated_at` ‚Äî –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
- –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è `request_count` –Ω–∞ 0
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è `request_count`
- –ï—Å–ª–∏ `request_count >= 30` ‚Üí –æ—Ç–∫–∞–∑ –≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏

---

## üì¶ –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (SQLAlchemy)

### –§–∞–π–ª: `models.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

#### –ú–æ–¥–µ–ª—å `AIChatRequest`
–°–æ–∑–¥–∞—Ç—å SQLAlchemy –º–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:
- –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `Base`
- –ò–º—è —Ç–∞–±–ª–∏—Ü—ã: `ai_chat_requests`
- –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –ø–æ–ª—è –∏–∑ SQL —Å—Ö–µ–º—ã –≤—ã—à–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `func.now()` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ `created_at`
- –ò–º–µ–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–π `__repr__` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

#### –ú–æ–¥–µ–ª—å `AIChatDailyLimit`
–°–æ–∑–¥–∞—Ç—å SQLAlchemy –º–æ–¥–µ–ª—å –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ª–∏–º–∏—Ç–æ–≤:
- –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `Base`
- –ò–º—è —Ç–∞–±–ª–∏—Ü—ã: `ai_chat_daily_limits`
- –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –ø–æ–ª—è –∏–∑ SQL —Å—Ö–µ–º—ã –≤—ã—à–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `onupdate=func.now()` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ `updated_at`
- –ò–º–µ–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–π `__repr__` –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–π —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç—á–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "15/30")

---

## üìù Schemas (Pydantic)

### –§–∞–π–ª: `schemas.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

–°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤ API:

#### Request/Response —Å—Ö–µ–º—ã –¥–ª—è `/v1/chat/send`:
- **ChatSendRequest**: `telegram_id` (int), `message` (str, 1-4000 —Å–∏–º–≤–æ–ª–æ–≤)
- **ChatSendResponse**: `response` (str), `remaining_requests` (int), `tokens_used` (int)

#### Request/Response —Å—Ö–µ–º—ã –¥–ª—è `/v1/chat/history`:
- **ChatHistoryRequest**: `telegram_id` (int), `limit` (int, 1-100, default=10), `offset` (int, >=0, default=0)
- **ChatHistoryItem**: `id`, `message`, `response`, `tokens_used`, `created_at` (—Å `from_attributes=True`)
- **ChatHistoryResponse**: `items` (List[ChatHistoryItem]), `total`, `limit`, `offset`

#### Response —Å—Ö–µ–º–∞ –¥–ª—è `/v1/chat/limits/{telegram_id}`:
- **ChatLimitsResponse**: `telegram_id`, `requests_today`, `requests_remaining`, `daily_limit`, `reset_date`

#### Request/Response —Å—Ö–µ–º—ã –¥–ª—è `/v1/chat/reset-limit`:
- **ResetLimitRequest**: `telegram_id` (int)
- **ResetLimitResponse**: `success` (bool), `message` (str)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Field()` –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏–π –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –î–æ–±–∞–≤–ª—è—Ç—å docstring –∫ –∫–∞–∂–¥–æ–π —Å—Ö–µ–º–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å type hints (typing.Optional, typing.List)

---

## üîß CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

### –§–∞–π–ª: `crud.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å `AIChatCRUD` —Å –º–µ—Ç–æ–¥–∞–º–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:

#### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã:
- `DAILY_LIMIT = 30` - –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤

#### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `db: Session` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `self.db`

#### –ú–µ—Ç–æ–¥ `check_and_update_limit(telegram_id: int) -> Tuple[bool, int]`
**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ `ai_chat_daily_limits` –ø–æ `telegram_id`
2. –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å `request_count=0`
3. –ï—Å–ª–∏ `last_reset_date` < —Å–µ–≥–æ–¥–Ω—è ‚Üí —Å–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ (`request_count=0`)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –µ—Å–ª–∏ `request_count >= DAILY_LIMIT` ‚Üí –≤–µ—Ä–Ω—É—Ç—å `(False, 0)`
5. –£–≤–µ–ª–∏—á–∏—Ç—å `request_count` –Ω–∞ 1, –æ–±–Ω–æ–≤–∏—Ç—å `updated_at`
6. –í–µ—Ä–Ω—É—Ç—å `(True, remaining)` –≥–¥–µ `remaining = DAILY_LIMIT - request_count`
7. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —ç–º–æ–¥–∑–∏ (‚ú® —Å–æ–∑–¥–∞–Ω–∏–µ, üîÑ —Å–±—Ä–æ—Å, ‚õî –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ, ‚úÖ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)

#### –ú–µ—Ç–æ–¥ `get_limits(telegram_id: int) -> dict`
**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å:**
- `requests_today`: —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç—á–∏–∫
- `requests_remaining`: –æ—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤
- `daily_limit`: –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç (30)
- `reset_date`: –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞
**–ù–ï –∏–∑–º–µ–Ω—è–µ—Ç** —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤!

#### –ú–µ—Ç–æ–¥ `save_chat_request(telegram_id, user_id, message, response, tokens_used) -> AIChatRequest`
- –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å `AIChatRequest` —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î, –≤–µ—Ä–Ω—É—Ç—å –æ–±—ä–µ–∫—Ç
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å: `üíæ Saved chat request: telegram_id=..., tokens=...`

#### –ú–µ—Ç–æ–¥ `get_chat_history(telegram_id, limit=10, offset=0) -> Tuple[List[AIChatRequest], int]`
- –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ `created_at` DESC (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —á–µ—Ä–µ–∑ `limit` –∏ `offset`
- –í–µ—Ä–Ω—É—Ç—å `(—Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π, –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)`
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å: `üìú Retrieved chat history: telegram_id=..., total=..., returned=...`

#### –ú–µ—Ç–æ–¥ `get_recent_context(telegram_id, limit=5) -> List[dict]`
- –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ AI
- –í–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π: `[{"role": "user", "content": "..."}, {"role": "assistant", "content": "..."}, ...]`
- –ü–æ—Ä—è–¥–æ–∫: –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º (reversed)
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å: `üîç Retrieved context: telegram_id=..., messages=...`

#### –ú–µ—Ç–æ–¥ `reset_user_limit(telegram_id: int) -> bool`
- –°–±—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (admin —Ñ—É–Ω–∫—Ü–∏—è)
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `request_count=0`, `last_reset_date=today`, `updated_at=now`
- –í–µ—Ä–Ω—É—Ç—å `True` –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, `False` –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å: `üîÑ Admin reset limit for telegram_id=...`

#### –ú–µ—Ç–æ–¥ `get_user_stats(telegram_id: int, days=7) -> dict`
**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π:**
- `total_requests`: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- `total_tokens`: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
- `days`: –ø–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞
- `avg_requests_per_day`: —Å—Ä–µ–¥–Ω–µ–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å
- `avg_tokens_per_request`: —Å—Ä–µ–¥–Ω–µ–µ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –í—Å–µ –º–µ—Ç–æ–¥—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å logging
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –≤ –ª–æ–≥–∞—Ö –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 0)

---

## ü§ñ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç

### –§–∞–π–ª: `prompts.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

–°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–º–∞—Ç–∏–∫–∏ AI —á–∞—Ç–∞.

#### –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `SYSTEM_PROMPT`
–î–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è AI:

**–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI:**
- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ WB
- –†–∞–±–æ—Ç–∞ —Å –∑–∞–∫–∞–∑–∞–º–∏, –æ—Å—Ç–∞—Ç–∫–∞–º–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞–º–∏
- –û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏ —Ç–æ–≤–∞—Ä–æ–≤
- –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
- –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ Wildberries
- –†–∞–±–æ—Ç–∞ —Å API –∏ –∫–∞–±–∏–Ω–µ—Ç–æ–º –ø—Ä–æ–¥–∞–≤—Ü–∞
- –õ–æ–≥–∏—Å—Ç–∏–∫–∞, —Å–∫–ª–∞–¥—ã –∏ –ø–æ—Å—Ç–∞–≤–∫–∏ WB
- –ö–æ–º–∏—Å—Å–∏–∏, —Ñ–∏–Ω–∞–Ω—Å—ã –∏ –Ω–∞–ª–æ–≥–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤

**–ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è:**
1. –û—Ç–≤–µ—á–∞—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ç–µ–º–µ Wildberries –∏ e-commerce
2. –í–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∑—ã–≤–∞—Ç—å, –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ (—Å –ø—Ä–∏–º–µ—Ä–æ–º —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∫–∞–∑–∞)
3. –î–∞–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏: üìä üìà üí∞ üõí ‚ö†Ô∏è ‚úÖ ‚ùå üì¶ ‚≠ê
5. –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É
6. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ ‚Äî 2000 —Å–∏–º–≤–æ–ª–æ–≤
7. –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ (/digest) –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ù–ï –¥–∞–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ WB
- –ù–ï –æ–±–µ—â–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
- –ù–ï –æ–±—Å—É–∂–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É, —Ä–µ–ª–∏–≥–∏—é –∏ –¥—Ä—É–≥–∏–µ –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è —Ç–µ–º—ã

**–°—Ç–∏–ª—å:**
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
- –ü—Ä–∞–∫—Ç–∏—á–Ω—ã–π –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π
- –° –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (—Å–ø–∏—Å–∫–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∏)

#### –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `SYSTEM_PROMPT_SHORT` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ö–æ—Ä–æ—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤).

---

## üåê FastAPI —Å–µ—Ä–≤–∏—Å

### –§–∞–π–ª: `service.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

#### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- –°–æ–∑–¥–∞—Ç—å FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏:
  - `title="AI Chat Service"`
  - `description="AI —á–∞—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ Wildberries —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤"`
  - `version="1.0.0"`
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (level=INFO, —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º)

#### –°–æ–±—ã—Ç–∏–µ `@app.on_event("startup")`:
- –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –ë–î: `Base.metadata.create_all(bind=engine)`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ `OPENAI_API_KEY` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫: `üöÄ Starting AI Chat Service...`
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü: `‚úÖ Database tables created/verified`

#### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

##### `_verify_api_key(x_api_key: Optional[str])`:
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-API-KEY` –ø—Ä–æ—Ç–∏–≤ `API_SECRET_KEY` –∏–∑ env
- –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí `HTTPException(403, "Invalid or missing API key")`

##### `_get_openai_client() -> OpenAI`:
- –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç OpenAI —Å API –∫–ª—é—á–æ–º –∏–∑ env
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `OPENAI_BASE_URL` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω ‚Üí `HTTPException(500, "OpenAI API key not configured")`

##### `_call_openai(messages, model, max_tokens, temperature) -> tuple[str, int]`:
- –í—ã–∑–≤–∞—Ç—å `client.chat.completions.create()` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ env (–∏–ª–∏ defaults): `OPENAI_MODEL`, `OPENAI_MAX_TOKENS`, `OPENAI_TEMPERATURE`
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å: `ü§ñ Calling OpenAI: model=..., max_tokens=..., messages=...`
- –í–µ—Ä–Ω—É—Ç—å `(response_text, tokens_used)`
- –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí `HTTPException(500, f"AI service error: {str(e)}")`
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å: `‚úÖ OpenAI response received: {len} chars, {tokens} tokens`

#### API Endpoints:

##### `GET /health`
- –í–µ—Ä–Ω—É—Ç—å `{"status": "ok", "service": "ai_chat", "version": "1.0.0"}`
- –ë–µ–∑ –∑–∞—â–∏—Ç—ã API –∫–ª—é—á–æ–º

##### `POST /v1/chat/send` (response_model=ChatSendResponse)
**–ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á (`_verify_api_key`)
2. –°–æ–∑–¥–∞—Ç—å `AIChatCRUD(db)`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã: `crud.check_and_update_limit(telegram_id)`
4. –ï—Å–ª–∏ `can_request=False` ‚Üí `HTTPException(429, {...})` —Å –¥–µ—Ç–∞–ª—è–º–∏ –ª–∏–º–∏—Ç–∞
5. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç: `crud.get_recent_context(telegram_id, limit=5)`
6. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å messages: `[system_prompt, ...context, user_message]`
7. –í—ã–∑–≤–∞—Ç—å OpenAI: `_call_openai(messages)`
8. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é: `crud.save_chat_request(...)`
9. –í–µ—Ä–Ω—É—Ç—å `ChatSendResponse(response, remaining_requests, tokens_used)`

##### `POST /v1/chat/history` (response_model=ChatHistoryResponse)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á
- –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: `crud.get_chat_history(telegram_id, limit, offset)`
- –í–µ—Ä–Ω—É—Ç—å `ChatHistoryResponse(items, total, limit, offset)`

##### `GET /v1/chat/limits/{telegram_id}` (response_model=ChatLimitsResponse)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á
- –ü–æ–ª—É—á–∏—Ç—å –ª–∏–º–∏—Ç—ã: `crud.get_limits(telegram_id)`
- –í–µ—Ä–Ω—É—Ç—å `ChatLimitsResponse(telegram_id, ...limits)`

##### `POST /v1/chat/reset-limit` (response_model=ResetLimitResponse)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á
- –°–±—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç: `crud.reset_user_limit(telegram_id)`
- –í–µ—Ä–Ω—É—Ç—å `ResetLimitResponse(success, message)`

##### `GET /v1/chat/stats/{telegram_id}`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á
- –ü–∞—Ä–∞–º–µ—Ç—Ä query: `days` (default=7)
- –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: `crud.get_user_stats(telegram_id, days)`
- –í–µ—Ä–Ω—É—Ç—å `{"telegram_id": ..., ...stats}`

#### –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ `if __name__ == "__main__"`:
- –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Ä—Ç –∏–∑ `AI_CHAT_PORT` (default=9001)
- –ó–∞–ø—É—Å—Ç–∏—Ç—å: `uvicorn.run("ai_chat.service:app", host="0.0.0.0", port=port, reload=True)`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–∫—Ä–æ–º–µ /health) –∑–∞—â–∏—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–æ–π API –∫–ª—é—á–∞
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —ç–º–æ–¥–∑–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- Dependency Injection –¥–ª—è `db: Session`

---

## üóÑÔ∏è Database Configuration

### –§–∞–π–ª: `database.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª—è:

##### `DATABASE_URL`:
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: `os.getenv("AI_CHAT_DATABASE_URL")`
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: `os.getenv("DATABASE_URL")`
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `"sqlite:///./ai_chat.db"`

##### `engine`:
- –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ `create_engine(DATABASE_URL, ...)`
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  - `pool_pre_ping=True` (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º)
  - `echo=False` (–Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã)

##### `SessionLocal`:
- –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ `sessionmaker(autocommit=False, autoflush=False, bind=engine)`

##### `Base`:
- –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ `declarative_base()` (–¥–ª—è SQLAlchemy –º–æ–¥–µ–ª–µ–π)

#### –§—É–Ω–∫—Ü–∏—è `get_db()`:
- Generator —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è FastAPI Dependency Injection
- –°–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `yield`, –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤ `finally`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** `db: Session = Depends(get_db)`

#### –§—É–Ω–∫—Ü–∏—è `init_db()`:
- –°–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã: `Base.metadata.create_all(bind=engine)`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üê≥ Docker Configuration

### –§–∞–π–ª: `Dockerfile`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É:**

```dockerfile
FROM python:3.11-slim
WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y gcc postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY ai_chat/requirements.txt /app/ai_chat/requirements.txt
RUN pip install --no-cache-dir -r ai_chat/requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ —Å–µ—Ä–≤–∏—Å–∞
COPY ai_chat/ /app/ai_chat/

# –ü–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞
EXPOSE 9001

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
CMD ["python", "-m", "uvicorn", "ai_chat.service:app", "--host", "0.0.0.0", "--port", "9001"]
```

### –§–∞–π–ª: `requirements.txt`

**–°–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
- `fastapi==0.109.0` (–∏–ª–∏ –≤—ã—à–µ)
- `uvicorn[standard]==0.27.0`
- `sqlalchemy==2.0.25`
- `psycopg2-binary==2.9.9` (–¥–ª—è PostgreSQL)
- `pydantic==2.5.3`
- `pydantic-settings==2.1.0`
- `httpx==0.26.0` (–¥–ª—è async HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)
- `openai==1.10.0` (–∏–ª–∏ –≤—ã—à–µ)
- `python-dotenv==1.0.0` (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ .env)

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ `docker-compose.yml`

**–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å:**

```yaml
ai_chat:
  build:
    context: .
    dockerfile: ai_chat/Dockerfile
  ports:
    - "9001:9001"
  environment:
    - AI_CHAT_PORT=9001
    - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
    - API_SECRET_KEY=${API_SECRET_KEY}
    - OPENAI_API_KEY=${OPENAI_API_KEY}
    - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
    - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
    - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-0.7}
    - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-1000}
  depends_on:
    db:
      condition: service_healthy
  networks:
    - app-network
  restart: unless-stopped
```

---

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram –±–æ—Ç–æ–º

### –§–∞–π–ª: `bot/handlers/ai_chat.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è:
- `router = Router()`
- `AI_CHAT_URL` –∏–∑ env (default: `"http://ai_chat:9001"`)
- `API_SECRET_KEY` –∏–∑ env

#### FSM States:
–°–æ–∑–¥–∞—Ç—å `AIChatStates(StatesGroup)`:
- `waiting_for_message = State()` - –æ–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### –ö–æ–º–∞–Ω–¥–∞ `/ai_chat` –∏–ª–∏ `/chat`:
**Handler:** `cmd_ai_chat(message, state)`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫: "ü§ñ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç Wildberries"
   - –°–ø–∏—Å–æ–∫ —Ç–µ–º: –ø—Ä–æ–¥–∞–∂–∏, –æ—Å—Ç–∞—Ç–∫–∏, –æ—Ç–∑—ã–≤—ã, —Ü–µ–Ω—ã, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: "/cancel –¥–ª—è –≤—ã—Ö–æ–¥–∞"
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: "üìä –£ –≤–∞—Å –µ—Å—Ç—å 30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å—É—Ç–∫–∏"
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ: `state.set_state(AIChatStates.waiting_for_message)`

#### –ö–æ–º–∞–Ω–¥–∞ `/cancel` (–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_message):
**Handler:** `cancel_chat(message, state)`

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ: `state.clear()`
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "‚úÖ –ß–∞—Ç —Å AI –∑–∞–≤–µ—Ä—à–µ–Ω"

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_message):
**Handler:** `process_ai_message(message, state)`

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∏—Ç—å `telegram_id` –∏ `user_message`
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏: `send_chat_action(action="typing")`
3. –°–¥–µ–ª–∞—Ç—å POST –∑–∞–ø—Ä–æ—Å –∫ `{AI_CHAT_URL}/v1/chat/send`:
   - Body: `{"telegram_id": ..., "message": ...}`
   - Headers: `{"X-API-KEY": API_SECRET_KEY}`
   - Timeout: 60 —Å–µ–∫—É–Ω–¥
4. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç:
   - **–ï—Å–ª–∏ 429 (–ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω)**:
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "‚õî –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞! üåÖ"
     - –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
     - return
   - **–ï—Å–ª–∏ 200 (—É—Å–ø–µ—Ö)**:
     - –ü–æ–ª—É—á–∏—Ç—å `response` –∏ `remaining_requests`
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "{response}\n\n_–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤: {remaining}/30_"
   - **–ü—Ä–∏ –æ—à–∏–±–∫–µ**:
     - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI..."

#### –ö–æ–º–∞–Ω–¥–∞ `/ai_limits`:
**Handler:** `cmd_ai_limits(message)`

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∏—Ç—å `telegram_id`
2. –°–¥–µ–ª–∞—Ç—å GET –∑–∞–ø—Ä–æ—Å –∫ `{AI_CHAT_URL}/v1/chat/limits/{telegram_id}`
3. –ï—Å–ª–∏ 200:
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "üìä –í–∞—à–∏ –ª–∏–º–∏—Ç—ã AI —á–∞—Ç–∞" —Å –¥–∞–Ω–Ω—ã–º–∏ (`requests_today`, `requests_remaining`, `daily_limit`, `reset_date`)
4. –ü—Ä–∏ –æ—à–∏–±–∫–µ:
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–º–∏—Ç–∞—Ö"

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async/await
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `httpx.AsyncClient` –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏
- HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### 1. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (PowerShell)

```powershell
$headers = @{ "X-API-KEY" = "$env:API_SECRET_KEY" }
$body = @{
    telegram_id = 123456789
    message = "–ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞?"
} | ConvertTo-Json

Invoke-RestMethod `
    -Method Post `
    -Uri "http://localhost:9001/v1/chat/send" `
    -Headers $headers `
    -ContentType "application/json" `
    -Body $body
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ (curl)

```bash
curl -X POST "http://localhost:9001/v1/chat/history" \
  -H "X-API-KEY: your-secret-key" \
  -H "Content-Type: application/json" \
  -d '{
    "telegram_id": 123456789,
    "limit": 10,
    "offset": 0
  }'
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ (curl)

```bash
curl -X GET "http://localhost:9001/v1/chat/limits/123456789" \
  -H "X-API-KEY: your-secret-key"
```

### 4. –°–±—Ä–æ—Å –ª–∏–º–∏—Ç–∞ (admin)

```bash
curl -X POST "http://localhost:9001/v1/chat/reset-limit" \
  -H "X-API-KEY: your-secret-key" \
  -H "Content-Type: application/json" \
  -d '{"telegram_id": 123456789}'
```

---

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|----------------------|
| `OPENAI_API_KEY` | OpenAI API –∫–ª—é—á | - (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) |
| `API_SECRET_KEY` | –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è API | - (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) |
| `DATABASE_URL` | URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL | `sqlite:///./ai_chat.db` |

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|----------------------|
| `AI_CHAT_PORT` | –ü–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞ | `9001` |
| `OPENAI_BASE_URL` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç OpenAI | - |
| `OPENAI_MODEL` | –ú–æ–¥–µ–ª—å OpenAI | `gpt-4o-mini` |
| `OPENAI_TEMPERATURE` | –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0.0-2.0) | `0.7` |
| `OPENAI_MAX_TOKENS` | –ú–∞–∫—Å —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ | `1000` |
| `AI_CHAT_DATABASE_URL` | –û—Ç–¥–µ–ª—å–Ω–∞—è –ë–î –¥–ª—è AI Chat | - |

### –î–ª—è Telegram –±–æ—Ç–∞:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|----------------------|
| `AI_CHAT_SERVICE_URL` | URL AI Chat —Å–µ—Ä–≤–∏—Å–∞ | `http://ai_chat:9001` |

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `.env` —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
- –î–ª—è Docker –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ `docker-compose.yml`
- `API_SECRET_KEY` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å –º–µ–∂–¥—É –≤—Å–µ–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

---

## ‚úÖ –≠—Ç–∞–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `ai_chat/`
- [ ] –°–æ–∑–¥–∞—Ç—å `models.py` (SQLAlchemy –º–æ–¥–µ–ª–∏)
- [ ] –°–æ–∑–¥–∞—Ç—å `schemas.py` (Pydantic —Å—Ö–µ–º—ã)
- [ ] –°–æ–∑–¥–∞—Ç—å `database.py` (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î)
- [ ] –°–æ–∑–¥–∞—Ç—å `crud.py` (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏)
- [ ] –°–æ–∑–¥–∞—Ç—å `prompts.py` (—Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç)

### –≠—Ç–∞–ø 2: FastAPI —Å–µ—Ä–≤–∏—Å
- [ ] –°–æ–∑–¥–∞—Ç—å `service.py` (FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `/health`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `/v1/chat/send`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `/v1/chat/history`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `/v1/chat/limits/{telegram_id}`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `/v1/chat/reset-limit` (admin)

### –≠—Ç–∞–ø 3: Docker –∏ –¥–µ–ø–ª–æ–π
- [ ] –°–æ–∑–¥–∞—Ç—å `Dockerfile`
- [ ] –°–æ–∑–¥–∞—Ç—å `requirements.txt`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å –≤ `docker-compose.yml`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health check

### –≠—Ç–∞–ø 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º
- [ ] –°–æ–∑–¥–∞—Ç—å `bot/handlers/ai_chat.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `/ai_chat`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `/ai_limits`
- [ ] –î–æ–±–∞–≤–∏—Ç—å FSM –¥–ª—è —Ä–µ–∂–∏–º–∞ —á–∞—Ç–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ 429 (–ª–∏–º–∏—Ç)

### –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] Integration —Ç–µ—Å—Ç—ã –¥–ª—è API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ (30 –∑–∞–ø—Ä–æ—Å–æ–≤)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤ –≤ –Ω–æ–≤—ã–π –¥–µ–Ω—å
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

### –≠—Ç–∞–ø 6: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] README.md –¥–ª—è AI Chat —Å–µ—Ä–≤–∏—Å–∞
- [ ] –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ (curl, PowerShell)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API (OpenAPI/Swagger - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ FastAPI)
- [ ] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### MVP (Must Have)
- ‚úÖ –ë–∞–∑–æ–≤—ã–π —á–∞—Ç —Å AI —á–µ—Ä–µ–∑ OpenAI API
- ‚úÖ –õ–∏–º–∏—Ç 30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å (—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î)
- ‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ç–µ–º–∞—Ç–∏–∫–∏ (—Ç–æ–ª—å–∫–æ WB/e-commerce)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram –±–æ—Ç–æ–º —á–µ—Ä–µ–∑ REST API
- ‚úÖ –ó–∞—â–∏—Ç–∞ API –∫–ª—é—á–æ–º
- ‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è

### Nice to Have (–±—É–¥—É—â–∏–µ –≤–µ—Ä—Å–∏–∏)
- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (`/v1/chat/stats`)
- Admin –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞–º–∏
- –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ü–ª–∞—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Python 3.11+
- FastAPI –¥–ª—è REST API
- SQLAlchemy –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
- PostgreSQL (–æ—Å–Ω–æ–≤–Ω–∞—è –ë–î) –∏–ª–∏ SQLite (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- OpenAI API –¥–ª—è LLM
- Docker + Docker Compose –¥–ª—è –¥–µ–ø–ª–æ—è
- Aiogram 3.x –¥–ª—è Telegram –±–æ—Ç–∞

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–∫—Ä–æ–º–µ `/health`) –∑–∞—â–∏—â–µ–Ω—ã `X-API-KEY`
- Rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (30 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Pydantic
- SQL Injection –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ SQLAlchemy ORM
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–µ–º–∞—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏):
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ: –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ + Load Balancer
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î: –∏–Ω–¥–µ–∫—Å—ã, –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ: Redis –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ –∏ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å: asyncio, Celery –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
- Health check —ç–Ω–¥–ø–æ–∏–Ω—Ç `/health`
- Swagger UI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ `/docs`
- –ú–µ—Ç—Ä–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

**–í–µ—Ä—Å–∏—è**: 1.0.0  
**–î–∞—Ç–∞**: 2025-10-29  
**–°—Ç–∞—Ç—É—Å**: Technical Specification ‚úÖ  
**–§–æ—Ä–º–∞—Ç**: –≠—Ç–∞–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è LLM/Developer

