â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ¯: ĞšĞ°Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Google Apps Script Ğ² ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ Ğ¨ĞĞ“ 1: ĞĞ¢ĞšĞ ĞĞ™Ğ¢Ğ• Ğ¨ĞĞ‘Ğ›ĞĞ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ²Ğ°Ñˆ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ Google Sheets Ğ¿Ğ¾ ID Ğ¸Ğ· .env:
https://docs.google.com/spreadsheets/d/[GOOGLE_TEMPLATE_SPREADSHEET_ID]/edit


ğŸ“ Ğ¨ĞĞ“ 2: ĞĞ¢ĞšĞ ĞĞ™Ğ¢Ğ• Ğ Ğ•Ğ”ĞĞšĞ¢ĞĞ  Ğ¡ĞšĞ Ğ˜ĞŸĞ¢ĞĞ’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ğ’ Ğ¼ĞµĞ½Ñ: Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ â†’ Apps Script


ğŸ“ Ğ¨ĞĞ“ 3: Ğ’Ğ¡Ğ¢ĞĞ’Ğ¬Ğ¢Ğ• ĞšĞĞ”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğµ Ğ²ĞµÑÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ² Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€Ğµ
2. Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ²ĞµÑÑŒ ĞºĞ¾Ğ´ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ½Ğ¸Ğ¶Ğµ (Ğ¡Ğ¢ĞĞ Ğ¢ ĞšĞĞ”Ğ ... ĞšĞĞĞ•Ğ¦ ĞšĞĞ”Ğ)
3. Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ Apps Script
4. Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ¾ĞºÑƒ (ÑÑ‚Ñ€Ğ¾ĞºĞ° 11):
   const API_BASE_URL = 'PLACEHOLDER_API_URL';
   
   ĞĞ° Ğ²Ğ°Ñˆ ngrok URL Ğ¸Ğ»Ğ¸ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¾Ğ¼ĞµĞ½:
   const API_BASE_URL = 'https://Ğ²Ğ°Ñˆ_ngrok_Ğ´Ğ¾Ğ¼ĞµĞ½.ngrok.io';
   
   Ğ˜Ğ›Ğ˜ Ğ´Ğ»Ñ Ğ±Ğ¾ĞµĞ²Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ°:
   const API_BASE_URL = 'https://api.wb-assist.com';


ğŸ“ Ğ¨ĞĞ“ 4: Ğ¡ĞĞ¥Ğ ĞĞĞ˜Ğ¢Ğ•
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ctrl+S (Windows/Linux) Ğ¸Ğ»Ğ¸ Cmd+S (Mac)


ğŸ“ Ğ¨ĞĞ“ 5: Ğ—ĞĞ”ĞĞ™Ğ¢Ğ• Ğ ĞĞ—Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ: Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ â†’ Apps Script
2. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ `onOpen` Ğ¸Ğ· Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰ĞµĞ³Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ°
3. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"
4. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "ĞĞ±Ğ·Ğ¾Ñ€ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¹" Ğ¸Ğ»Ğ¸ "Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿"
5. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Google Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚
6. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾" â†’ "ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ½Ğ° [Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°] (Ğ½ĞµĞ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾)"
7. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ"


ğŸ“ Ğ¨ĞĞ“ 6: ĞŸĞ ĞĞ’Ğ•Ğ Ğ¬Ğ¢Ğ• Ğ ĞĞ‘ĞĞ¢Ğ£
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†ĞµĞ¹ (F5)
2. Ğ’ Ğ¼ĞµĞ½Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑŒÑÑ "WB Assist"
3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ, Ñ‡Ñ‚Ğ¾ Ğ¼ĞµĞ½Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  Ğ¡Ğ¢ĞĞ Ğ¢ ĞšĞĞ”Ğ Ğ”Ğ›Ğ¯ Ğ’Ğ¡Ğ¢ĞĞ’ĞšĞ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Google Apps Script Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… WB Ğ² Google Sheets
 * Ğ’ĞµÑ€ÑĞ¸Ñ: 1.0.0
 * ĞĞ²Ñ‚Ğ¾Ñ€: WB Assist
 */

const API_BASE_URL = 'PLACEHOLDER_API_URL'; // Ğ—ĞĞœĞ•ĞĞ˜Ğ¢Ğ• ĞĞ Ğ’ĞĞ¨ URL

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('WB Assist')
    .addItem('ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ', 'updateAllData')
    .addItem('ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ', 'checkConnection')
    .addItem('âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸', 'showSettings')
    .addItem('â“ Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ°', 'showHelp')
    .addToUi();
}

function updateAllData() {
  try {
    const settings = getSettings();
    if (!settings.cabinetId || !settings.token) {
      SpreadsheetApp.getUi().alert(
        'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸', 
        'ĞĞµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹ ID ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğ° Ğ¸Ğ»Ğ¸ Token Export.', 
        SpreadsheetApp.getUi().ButtonSet.OK
      );
      return;
    }
    
    SpreadsheetApp.getActiveSpreadsheet().toast('ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...', 'WB Assist', 3);
    updateOrders(settings);
    updateStocks(settings);
    updateReviews(settings);
    updateConnectionStatus('âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾', new Date());
    SpreadsheetApp.getActiveSpreadsheet().toast('Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹!', 'WB Assist', 3);
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error);
    updateConnectionStatus('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message, new Date());
    SpreadsheetApp.getUi().alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ', 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ: ' + error.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function getSettings() {
  const settingsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸');
  if (!settingsSheet) throw new Error('Ğ›Ğ¸ÑÑ‚ "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
  return {
    cabinetId: settingsSheet.getRange('B1').getValue(),
    token: settingsSheet.getRange('B2').getValue()
  };
}

function checkConnection() {
  try {
    const settings = getSettings();
    if (!settings.cabinetId || !settings.token) {
      updateConnectionStatus('âš ï¸ ĞĞµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾', new Date());
      return false;
    }
    const response = UrlFetchApp.fetch(API_BASE_URL + '/api/export/health', {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0'}
    });
    if (response.getResponseCode() === 200) {
      updateConnectionStatus('âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾', new Date());
      return true;
    } else {
      updateConnectionStatus('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ', new Date());
      return false;
    }
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ:', error);
    updateConnectionStatus('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message, new Date());
    return false;
  }
}

function updateOrders(settings) {
  try {
    const url = `${API_BASE_URL}/api/export/orders/${settings.cabinetId}?token=${settings.token}&limit=1000`;
    const response = UrlFetchApp.fetch(url, {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0', 'Accept': 'application/json'}
    });
    if (response.getResponseCode() !== 200) throw new Error(`ĞÑˆĞ¸Ğ±ĞºĞ° API: ${response.getResponseCode()}`);
    const data = JSON.parse(response.getContentText());
    if (data.data && data.data.length > 0) {
      const ordersSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ğŸ›’ Ğ—Ğ°ĞºĞ°Ğ·Ñ‹');
      if (!ordersSheet) throw new Error('Ğ›Ğ¸ÑÑ‚ "Ğ—Ğ°ĞºĞ°Ğ·Ñ‹" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
      const lastRow = ordersSheet.getLastRow();
      if (lastRow > 1) ordersSheet.getRange(2, 1, lastRow - 1, ordersSheet.getLastColumn()).clear();
      const values = data.data.map(row => [
        row.order_id || '', row.article || '', row.name || '', row.size || '',
        row.quantity || 0, row.price || 0, row.total_price || 0, row.status || '',
        row.order_date || '', row.warehouse_from || '', row.warehouse_to || '',
        row.commission_amount || 0, row.spp_percent || 0, row.customer_price || 0,
        row.discount_percent || 0
      ]);
      if (values.length > 0) ordersSheet.getRange(2, 1, values.length, values[0].length).setValues(values);
      console.log(`ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²: ${values.length}`);
    }
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²:', error);
    throw error;
  }
}

function updateStocks(settings) {
  try {
    const url = `${API_BASE_URL}/api/export/stocks/${settings.cabinetId}?token=${settings.token}&limit=1000`;
    const response = UrlFetchApp.fetch(url, {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0', 'Accept': 'application/json'}
    });
    if (response.getResponseCode() !== 200) throw new Error(`ĞÑˆĞ¸Ğ±ĞºĞ° API: ${response.getResponseCode()}`);
    const data = JSON.parse(response.getContentText());
    if (data.data && data.data.length > 0) {
      const stocksSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ğŸ“¦ Ğ¡ĞºĞ»Ğ°Ğ´');
      if (!stocksSheet) throw new Error('Ğ›Ğ¸ÑÑ‚ "Ğ¡ĞºĞ»Ğ°Ğ´" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
      const lastRow = stocksSheet.getLastRow();
      if (lastRow > 1) stocksSheet.getRange(2, 1, lastRow - 1, stocksSheet.getLastColumn()).clear();
      const values = data.data.map(row => [
        row.article || '', row.name || '', row.brand || '', row.size || '', row.warehouse_name || '',
        row.quantity || 0, row.in_way_to_client || 0, row.in_way_from_client || 0,
        row.price || 0, row.discount || 0, row.last_updated || ''
      ]);
      if (values.length > 0) stocksSheet.getRange(2, 1, values.length, values[0].length).setValues(values);
      console.log(`ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ²: ${values.length}`);
    }
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ²:', error);
    throw error;
  }
}

function updateReviews(settings) {
  try {
    const url = `${API_BASE_URL}/api/export/reviews/${settings.cabinetId}?token=${settings.token}&limit=1000`;
    const response = UrlFetchApp.fetch(url, {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0', 'Accept': 'application/json'}
    });
    if (response.getResponseCode() !== 200) throw new Error(`ĞÑˆĞ¸Ğ±ĞºĞ° API: ${response.getResponseCode()}`);
    const data = JSON.parse(response.getContentText());
    if (data.data && data.data.length > 0) {
      const reviewsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('â­ ĞÑ‚Ğ·Ñ‹Ğ²Ñ‹');
      if (!reviewsSheet) throw new Error('Ğ›Ğ¸ÑÑ‚ "ĞÑ‚Ğ·Ñ‹Ğ²Ñ‹" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
      const lastRow = reviewsSheet.getLastRow();
      if (lastRow > 1) reviewsSheet.getRange(2, 1, lastRow - 1, reviewsSheet.getLastColumn()).clear();
      const values = data.data.map(row => [
        row.review_id || '', row.nm_id || '', row.product_name || '',
        row.rating || 0, row.text || '', row.pros || '', row.cons || '',
        row.user_name || '', row.color || '', row.matching_size || '',
        row.created_date || '', row.is_answered || false, row.was_viewed || false
      ]);
      if (values.length > 0) reviewsSheet.getRange(2, 1, values.length, values[0].length).setValues(values);
      console.log(`ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²: ${values.length}`);
    }
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²:', error);
    throw error;
  }
}

function updateConnectionStatus(status, timestamp) {
  try {
    const settingsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸');
    if (settingsSheet) {
      settingsSheet.getRange('B3').setValue(status);
      settingsSheet.getRange('B4').setValue(timestamp);
    }
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°:', error);
  }
}

function showSettings() {
  const ui = SpreadsheetApp.getUi();
  const settings = getSettings();
  ui.alert(
    'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ WB Assist',
    `ID ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğ°: ${settings.cabinetId || 'ĞĞµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾'}\n` +
    `Token Export: ${settings.token ? 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½' : 'ĞĞµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½'}\n\n` +
    'Ğ”Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº Ğ¾Ñ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑÑ‡ĞµĞ¹ĞºĞ¸ B1 Ğ¸ B2 Ğ² Ğ»Ğ¸ÑÑ‚Ğµ "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸"',
    ui.ButtonSet.OK
  );
}

function showHelp() {
  const ui = SpreadsheetApp.getUi();
  ui.alert(
    'Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ° WB Assist',
    'ğŸ“‹ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ¿Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:\n\n' +
    '1. Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ ID ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğ° Ğ¸ Token Export Ğ² Ğ»Ğ¸ÑÑ‚Ğµ "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸"\n' +
    '2. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ" Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…\n' +
    '3. Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ¾Ğ¼ Ğ¸Ğ· SYNC_INTERVAL\n' +
    '4. ĞŸÑ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ "ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ"\n\n' +
    'ğŸ”§ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°: @wb_assist_bot',
    ui.ButtonSet.OK
  );
}

function createTrigger() {
  try {
    deleteTrigger();
    const syncInterval = getSyncInterval();
    if (syncInterval) {
      ScriptApp.newTrigger('updateAllData').timeBased().everyMinutes(syncInterval).create();
      console.log(`Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ¾Ğ¼ ${syncInterval} Ğ¼Ğ¸Ğ½ÑƒÑ‚`);
    } else {
      ScriptApp.newTrigger('updateAllData').timeBased().everyHours(6).create();
      console.log('Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ¾Ğ¼ 6 Ñ‡Ğ°ÑĞ¾Ğ² (fallback)');
    }
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ğ°:', error);
  }
}

function getSyncInterval() {
  try {
    const response = UrlFetchApp.fetch(API_BASE_URL + '/api/export/sync-interval', {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0', 'Accept': 'application/json'}
    });
    if (response.getResponseCode() === 200) {
      const data = JSON.parse(response.getContentText());
      return Math.max(1, Math.floor(data.sync_interval_seconds / 60));
    }
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ°:', error);
  }
  return null;
}

function deleteTrigger() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'updateAllData') ScriptApp.deleteTrigger(trigger);
    });
    console.log('Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹');
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ğ¾Ğ²:', error);
  }
}

function initialize() {
  try {
    createTrigger();
    checkConnection();
    console.log('WB Assist Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');
  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:', error);
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   ĞšĞĞĞ•Ğ¦ ĞšĞĞ”Ğ Ğ”Ğ›Ğ¯ Ğ’Ğ¡Ğ¢ĞĞ’ĞšĞ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

