‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å Google Apps Script –≤ —à–∞–±–ª–æ–Ω
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìù –®–ê–ì 1: –û–¢–ö–†–û–ô–¢–ï –®–ê–ë–õ–û–ù
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à —à–∞–±–ª–æ–Ω Google Sheets –ø–æ ID –∏–∑ .env:
https://docs.google.com/spreadsheets/d/[GOOGLE_TEMPLATE_SPREADSHEET_ID]/edit


üìù –®–ê–ì 2: –û–¢–ö–†–û–ô–¢–ï –†–ï–î–ê–ö–¢–û–† –°–ö–†–ò–ü–¢–û–í
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–í –º–µ–Ω—é: –†–∞—Å—à–∏—Ä–µ–Ω–∏—è ‚Üí Apps Script


üìù –®–ê–ì 3: –í–°–¢–ê–í–¨–¢–ï –ö–û–î
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. –£–¥–∞–ª–∏—Ç–µ –≤–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ –Ω–∏–∂–µ (–°–¢–ê–†–¢ –ö–û–î–ê ... –ö–û–ù–ï–¶ –ö–û–î–ê)
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä Apps Script
4. –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫—É (—Å—Ç—Ä–æ–∫–∞ 11):
   const API_BASE_URL = 'PLACEHOLDER_API_URL';
   
   –ù–∞ –≤–∞—à ngrok URL –∏–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω:
   const API_BASE_URL = 'https://–≤–∞—à_ngrok_–¥–æ–º–µ–Ω.ngrok.io';
   
   –ò–õ–ò –¥–ª—è –±–æ–µ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:
   const API_BASE_URL = 'https://api.wb-assist.com';


üìù –®–ê–ì 4: –°–û–•–†–ê–ù–ò–¢–ï
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ù–∞–∂–º–∏—Ç–µ Ctrl+S (Windows/Linux) –∏–ª–∏ Cmd+S (Mac)


üìù –®–ê–ì 5: –ó–ê–î–ê–ô–¢–ï –†–ê–ó–†–ï–®–ï–ù–ò–Ø
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. –û—Ç–∫—Ä–æ–π—Ç–µ: –†–∞—Å—à–∏—Ä–µ–Ω–∏—è ‚Üí Apps Script
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `onOpen` –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å"
4. –ù–∞–∂–º–∏—Ç–µ "–û–±–∑–æ—Ä —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π" –∏–ª–∏ "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø"
5. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à Google –∞–∫–∫–∞—É–Ω—Ç
6. –ù–∞–∂–º–∏—Ç–µ "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ" ‚Üí "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ [–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞] (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ)"
7. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å"


üìù –®–ê–ì 6: –ü–†–û–í–ï–†–¨–¢–ï –†–ê–ë–û–¢–£
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ç–∞–±–ª–∏—Ü–µ–π (F5)
2. –í –º–µ–Ω—é –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è "WB Assist"
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–µ–Ω—é —Ä–∞–±–æ—Ç–∞–µ—Ç


‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  –°–¢–ê–†–¢ –ö–û–î–ê –î–õ–Ø –í–°–¢–ê–í–ö–ò
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Google Apps Script –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö WB –≤ Google Sheets
 * –í–µ—Ä—Å–∏—è: 1.0.0
 * –ê–≤—Ç–æ—Ä: WB Assist
 */

const API_BASE_URL = 'PLACEHOLDER_API_URL'; // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('WB Assist')
    .addItem('üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'updateAllData')
    .addItem('üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ', 'checkConnection')
    .addItem('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏', 'showSettings')
    .addItem('‚ùì –°–ø—Ä–∞–≤–∫–∞', 'showHelp')
    .addToUi();
}

function updateAllData() {
  try {
    const settings = getSettings();
    if (!settings.cabinetId || !settings.token) {
      SpreadsheetApp.getUi().alert(
        '–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', 
        '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã ID –∫–∞–±–∏–Ω–µ—Ç–∞ –∏–ª–∏ Token Export.', 
        SpreadsheetApp.getUi().ButtonSet.OK
      );
      return;
    }
    
    SpreadsheetApp.getActiveSpreadsheet().toast('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'WB Assist', 3);
    updateOrders(settings);
    updateStocks(settings);
    updateReviews(settings);
    updateConnectionStatus('‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', new Date());
    SpreadsheetApp.getActiveSpreadsheet().toast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'WB Assist', 3);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
    updateConnectionStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, new Date());
    SpreadsheetApp.getUi().alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ' + error.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function getSettings() {
  const settingsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏');
  if (!settingsSheet) throw new Error('–õ–∏—Å—Ç "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  return {
    cabinetId: settingsSheet.getRange('B1').getValue(),
    token: settingsSheet.getRange('B2').getValue()
  };
}

function checkConnection() {
  try {
    const settings = getSettings();
    if (!settings.cabinetId || !settings.token) {
      updateConnectionStatus('‚ö†Ô∏è –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ', new Date());
      return false;
    }
    const response = UrlFetchApp.fetch(API_BASE_URL + '/api/export/health', {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0'}
    });
    if (response.getResponseCode() === 200) {
      updateConnectionStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ', new Date());
      return true;
    } else {
      updateConnectionStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', new Date());
      return false;
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
    updateConnectionStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, new Date());
    return false;
  }
}

function updateOrders(settings) {
  try {
    const url = `${API_BASE_URL}/api/export/orders/${settings.cabinetId}?token=${settings.token}&limit=1000`;
    const response = UrlFetchApp.fetch(url, {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0', 'Accept': 'application/json'}
    });
    if (response.getResponseCode() !== 200) throw new Error(`–û—à–∏–±–∫–∞ API: ${response.getResponseCode()}`);
    const data = JSON.parse(response.getContentText());
    if (data.data && data.data.length > 0) {
      const ordersSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('üõí –ó–∞–∫–∞–∑—ã');
      if (!ordersSheet) throw new Error('–õ–∏—Å—Ç "–ó–∞–∫–∞–∑—ã" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      const lastRow = ordersSheet.getLastRow();
      if (lastRow > 1) ordersSheet.getRange(2, 1, lastRow - 1, ordersSheet.getLastColumn()).clear();
      const values = data.data.map(row => [
        row.order_id || '', row.article || '', row.name || '', row.size || '',
        row.quantity || 0, row.price || 0, row.total_price || 0, row.status || '',
        row.order_date || '', row.warehouse_from || '', row.warehouse_to || '',
        row.commission_amount || 0, row.spp_percent || 0, row.customer_price || 0,
        row.discount_percent || 0
      ]);
      if (values.length > 0) ordersSheet.getRange(2, 1, values.length, values[0].length).setValues(values);
      console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${values.length}`);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:', error);
    throw error;
  }
}

function updateStocks(settings) {
  try {
    const url = `${API_BASE_URL}/api/export/stocks/${settings.cabinetId}?token=${settings.token}&limit=1000`;
    const response = UrlFetchApp.fetch(url, {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0', 'Accept': 'application/json'}
    });
    if (response.getResponseCode() !== 200) throw new Error(`–û—à–∏–±–∫–∞ API: ${response.getResponseCode()}`);
    const data = JSON.parse(response.getContentText());
    if (data.data && data.data.length > 0) {
      const stocksSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('üì¶ –°–∫–ª–∞–¥');
      if (!stocksSheet) throw new Error('–õ–∏—Å—Ç "–°–∫–ª–∞–¥" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      const lastRow = stocksSheet.getLastRow();
      if (lastRow > 1) stocksSheet.getRange(2, 1, lastRow - 1, stocksSheet.getLastColumn()).clear();
      const values = data.data.map(row => [
        row.article || '', row.name || '', row.brand || '', row.size || '', row.warehouse_name || '',
        row.quantity || 0, row.in_way_to_client || 0, row.in_way_from_client || 0,
        row.price || 0, row.discount || 0, row.last_updated || ''
      ]);
      if (values.length > 0) stocksSheet.getRange(2, 1, values.length, values[0].length).setValues(values);
      console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ –æ—Å—Ç–∞—Ç–∫–æ–≤: ${values.length}`);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤:', error);
    throw error;
  }
}

function updateReviews(settings) {
  try {
    const url = `${API_BASE_URL}/api/export/reviews/${settings.cabinetId}?token=${settings.token}&limit=1000`;
    const response = UrlFetchApp.fetch(url, {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0', 'Accept': 'application/json'}
    });
    if (response.getResponseCode() !== 200) throw new Error(`–û—à–∏–±–∫–∞ API: ${response.getResponseCode()}`);
    const data = JSON.parse(response.getContentText());
    if (data.data && data.data.length > 0) {
      const reviewsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('‚≠ê –û—Ç–∑—ã–≤—ã');
      if (!reviewsSheet) throw new Error('–õ–∏—Å—Ç "–û—Ç–∑—ã–≤—ã" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      const lastRow = reviewsSheet.getLastRow();
      if (lastRow > 1) reviewsSheet.getRange(2, 1, lastRow - 1, reviewsSheet.getLastColumn()).clear();
      const values = data.data.map(row => [
        row.review_id || '', row.nm_id || '', row.product_name || '',
        row.rating || 0, row.text || '', row.pros || '', row.cons || '',
        row.user_name || '', row.color || '', row.matching_size || '',
        row.created_date || '', row.is_answered || false, row.was_viewed || false
      ]);
      if (values.length > 0) reviewsSheet.getRange(2, 1, values.length, values[0].length).setValues(values);
      console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ –æ—Ç–∑—ã–≤–æ–≤: ${values.length}`);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤:', error);
    throw error;
  }
}

function updateConnectionStatus(status, timestamp) {
  try {
    const settingsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏');
    if (settingsSheet) {
      settingsSheet.getRange('B3').setValue(status);
      settingsSheet.getRange('B4').setValue(timestamp);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
  }
}

function showSettings() {
  const ui = SpreadsheetApp.getUi();
  const settings = getSettings();
  ui.alert(
    '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ WB Assist',
    `ID –∫–∞–±–∏–Ω–µ—Ç–∞: ${settings.cabinetId || '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ'}\n` +
    `Token Export: ${settings.token ? '–ó–∞–ø–æ–ª–Ω–µ–Ω' : '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω'}\n\n` +
    '–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫–∏ B1 –∏ B2 –≤ –ª–∏—Å—Ç–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"',
    ui.ButtonSet.OK
  );
}

function showHelp() {
  const ui = SpreadsheetApp.getUi();
  ui.alert(
    '–°–ø—Ä–∞–≤–∫–∞ WB Assist',
    'üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:\n\n' +
    '1. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ ID –∫–∞–±–∏–Ω–µ—Ç–∞ –∏ Token Export –≤ –ª–∏—Å—Ç–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"\n' +
    '2. –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n' +
    '3. –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –∏–∑ SYNC_INTERVAL\n' +
    '4. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"\n\n' +
    'üîß –ü–æ–¥–¥–µ—Ä–∂–∫–∞: @wb_assist_bot',
    ui.ButtonSet.OK
  );
}

function createTrigger() {
  try {
    deleteTrigger();
    const syncInterval = getSyncInterval();
    if (syncInterval) {
      ScriptApp.newTrigger('updateAllData').timeBased().everyMinutes(syncInterval).create();
      console.log(`–¢—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º ${syncInterval} –º–∏–Ω—É—Ç`);
    } else {
      ScriptApp.newTrigger('updateAllData').timeBased().everyHours(6).create();
      console.log('–¢—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 6 —á–∞—Å–æ–≤ (fallback)');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞:', error);
  }
}

function getSyncInterval() {
  try {
    const response = UrlFetchApp.fetch(API_BASE_URL + '/api/export/sync-interval', {
      method: 'GET',
      headers: {'User-Agent': 'WB-Assist-GoogleSheets/1.0', 'Accept': 'application/json'}
    });
    if (response.getResponseCode() === 200) {
      const data = JSON.parse(response.getContentText());
      return Math.max(1, Math.floor(data.sync_interval_seconds / 60));
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞:', error);
  }
  return null;
}

function deleteTrigger() {
  try {
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'updateAllData') ScriptApp.deleteTrigger(trigger);
    });
    console.log('–°—Ç–∞—Ä—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤:', error);
  }
}

function initialize() {
  try {
    createTrigger();
    checkConnection();
    console.log('WB Assist –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
  }
}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                   –ö–û–ù–ï–¶ –ö–û–î–ê –î–õ–Ø –í–°–¢–ê–í–ö–ò
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

